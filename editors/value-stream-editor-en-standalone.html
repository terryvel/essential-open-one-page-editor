<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Value Stream Editor</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root {
      --bg: #f8fafc; --panel: #ffffff; --panel-2: #f1f5f9; --text: #0f172a;
      --muted: #475569; --primary: #06b6d4; --primary-2: #0284c7;
      --danger: #dc2626; --ok: #16a34a; --shadow: 0 16px 40px rgba(2,8,23,.12);
      --radius: 18px;
    }
    * { box-sizing: border-box; } html, body { height: 100%; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 10% -10%, #e2e8f0 10%, var(--bg) 60%); color: var(--text); }
    .wrap { max-width: 1200px; margin: 32px auto; padding: 0 16px 48px; }
    header { display: flex; flex-direction: column; align-items: flex-start; gap: 6px; margin-bottom: 18px; }
    h1 { font-size: clamp(18px, 2.6vw, 28px); font-weight: 700; letter-spacing: .4px; margin: 0; }
    .flow-name { font-size: 14px; color: var(--muted); }
    .flow-name .name { font-weight: 700; color: var(--text); }
    .flow-name .mini-btn { margin-left: 6px; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; }
    .global-actions { justify-content:flex-end; margin:6px 0 12px; }
    button, .btn { border:1px solid transparent; background:linear-gradient(180deg,var(--primary),var(--primary-2));
      color:#001018; font-weight:700; padding:10px 14px; border-radius:12px; cursor:pointer;
      transition: transform .06s ease, filter .2s ease, background .2s ease, box-shadow .2s ease;
      box-shadow: var(--shadow); }
    button:hover { filter:brightness(1.06); } button:active { transform: translateY(1px) scale(.99); }
    button:focus-visible { outline:2px solid var(--primary); outline-offset:2px; }
    .btn-secondary { background: linear-gradient(180deg,#eef2f7,#d9e0ea); color: var(--text); border-color:#cbd5e1; }
    .btn-danger { background: linear-gradient(180deg,#fda4af,#ef4444); color:#3b0b0e; }
    .grid { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:16px; }
    @media (max-width:900px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width:600px){ .grid{ grid-template-columns: 1fr; } }
    .span-2 { grid-column: 1 / -1; }
    .grid-summary { display:grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap:16px; margin-bottom:16px; }
    .summary-span { grid-column: 1 / -1; }
    @media (max-width:1100px){ .grid-summary{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width:800px){ .grid-summary{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width:560px){ .grid-summary{ grid-template-columns: 1fr; } }
    .box { background: linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid #e2e8f0; border-radius: var(--radius);
      box-shadow: var(--shadow); min-height:220px; padding:14px; display:flex; flex-direction:column; }
    .box-header { display:flex; align-items:center; justify-content:space-between; gap:10px; padding-bottom:8px; border-bottom:1px dashed #e2e8f0; margin-bottom:8px; }
    .box-title { font-size:16px; font-weight:700; color: var(--text); }
    .list { display:flex; flex-direction:column; gap:8px; margin-top:6px; }
    .item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; }
    .item .label { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .item .remove { background:none; color:var(--text); border:1px solid #cbd5e1; border-radius:10px; padding:6px 9px; font-weight:800; line-height:1; box-shadow:none; }
    .item .remove:hover { background:#f1f5f9; } .item .remove.danger{ border-color:var(--danger); color:#991b1b; }
    .item.invalid { border-color: var(--danger); box-shadow: 0 0 0 2px rgba(220,38,38,.15) inset; }
    /* KPI cell validation */
    .cell-content.invalid { border:1px solid var(--danger); box-shadow: 0 0 0 2px rgba(220,38,38,.15) inset; border-radius:8px; }
    .item[draggable="true"]{ cursor: grab; } .item.dragging{ opacity:.6; }
    footer { margin-top:18px; color:var(--muted); font-size:13px; }
    .tabs{ display:flex; gap:6px; flex-wrap:wrap; padding:0 8px; margin:6px 0 0; }
    .tab-btn{ background:#e5e7eb; color:#374151; border:1px solid #d1d5db; border-bottom:none; border-radius:10px 10px 0 0; padding:6px 12px; font-weight:700; box-shadow:none; }
    .tab-btn:hover{ filter:brightness(1.03); } .tab-btn.active{ background:#fff; color:#111827; border-color:#d1d5db; position:relative; top:1px; }
    .tab-panel{ background:#fff; border:1px solid #d1d5db; border-radius:0 12px 12px 12px; padding:12px; margin-top:0; }
    .tab-panel[hidden]{ display:none; }
    .vs-table-wrap{ overflow:auto; }
    table.vs-table{ width:100%; border-collapse: separate; border-spacing:0; }
    .vs-table th, .vs-table td { border:1px solid #e5e7eb; padding:8px 10px; vertical-align:top; }
    .vs-table th.row-header { background:#f8fafc; font-weight:700; text-align:left; width:240px; position:sticky; left:0; z-index:1; }
    .vs-table thead th { background: #f1f5f9; font-weight:700; }
    .stage-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .stage-actions{ display:inline-flex; gap:6px; }
    .mini-btn{ background:#fff; border:1px solid #cbd5e1; color:var(--text); border-radius:8px; padding:2px 8px; font-weight:700; box-shadow:none; line-height:1; cursor:pointer; }
    .mini-btn:hover{ background:#f1f5f9; } .mini-btn.danger{ border-color:var(--danger); color:#991b1b; }
    .cell-wrapper{ position:relative; min-height:38px; }
    .cell-content{ min-height:22px; white-space:pre-wrap; outline:none; }
    .cell-toolbar{ position:absolute; top:4px; right:4px; display:none; gap:4px; align-items:center; }
    td:hover .cell-toolbar, .cell-wrapper:focus-within .cell-toolbar{ display:inline-flex; }
    dialog::backdrop{ background: rgba(15,23,42,.38); backdrop-filter: blur(2px); }
    dialog{ border:1px solid #e2e8f0; background: linear-gradient(180deg,#fff 0%, #f8fafc 100%); color:var(--text); border-radius:16px; padding:0; box-shadow:0 30px 80px rgba(2,8,23,.24); width:min(720px,96vw); animation: modal-pop .16s ease-out; }
    @keyframes modal-pop{ from{ opacity:0; transform: translateY(8px) scale(.98);} to{opacity:1; transform: translateY(0) scale(1);} }
    .modal-header{ padding:14px 16px; border-bottom:1px solid #e5e7eb; font-weight:700; background:linear-gradient(180deg,#fff,#f7fafc); border-radius: 16px 16px 0 0; }
    .modal-body{ padding:14px 16px; }
    .modal-actions{ display:flex; justify-content:flex-end; gap:10px; padding:12px 16px; border-top:1px solid #e5e7eb; background:#fbfdff; border-radius:0 0 16px 16px; }
    .field{ display:grid; gap:6px; margin-bottom:10px; }
    input[type="text"], textarea, select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #cbd5e1; outline:none; background:#fff; color:var(--text); font-family:inherit; font-size:14px; transition:border-color .15s ease, box-shadow .15s ease; }
    input[type="text"]:focus, textarea:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(6,182,212,.2); }
    textarea{ resize: vertical; min-height: 220px; }
    .muted{ color: var(--muted); font-size: 12px; }
    .checkbox-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:8px; }
    .checkbox-grid label{ display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
    .spacer16{ height:16px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Value Stream Editor</h1>
      <div class="flow-name">Flow name: <span id="flowNameValue" class="name">&lt;Set&gt;</span> <button id="editFlowNameBtn" class="mini-btn" title="Edit flow name">✎</button></div>
      <div class="flow-name">Flow description: <span id="flowDescValue" class="name">&lt;None&gt;</span> <button id="editFlowDescBtn" class="mini-btn" title="Edit flow description">✎</button></div>
    </header>

    <div class="actions global-actions" id="globalActions">
      <button id="importBtn" class="btn-secondary" title="Import JSON">Import JSON</button>
      <button id="exportBtn" class="btn-secondary" title="Export structure as JSON">Export JSON</button>
      <button id="createDupBtn" class="btn-secondary" title="Create DUP">Create DUP</button>
      <button id="clearAllBtn" class="btn-secondary" title="Clear everything">Clear all</button>
    </div>

    <nav class="tabs" id="tabs">
      <button class="tab-btn active" data-target="tab-summary">Value Stream Summary</button>
      <button class="tab-btn" data-target="tab-canvas">Value Stream Canvas</button>
      
    </nav>

    <div id="tab-summary" class="tab-panel">
      <section class="grid-summary" id="summary-grid"></section>
      <div class="spacer16"></div>
      <div class="box summary-span" id="vs-table-box">
        <div class="box-header">
          <div class="box-title">Value Stages Matrix</div>
          <div class="actions">
            <button id="addStageBtn" class="btn-secondary" type="button">Add Value Stages</button>
          </div>
        </div>
        <div class="vs-table-wrap"><table class="vs-table" id="vsTable"></table></div>
      </div>
      <footer>Add items to the Summary boxes. The last box spans the whole row for <em>Impacted Business Services</em>. Below, the Value Stages matrix lets you add columns.</footer>
    </div>

    <div id="tab-canvas" class="tab-panel" hidden>
      <section class="grid" id="grid"></section>
      <footer>Tip: click “+ Add” to include items. Remove with “–”. Drag items in Value Stream to reorder.</footer>
    </div>

    
  </div>

  <div id="modals-root"></div>

  <!-- Assets required to generate Essential .dup -->
  <script type="application/json" id="python-code-b64">IyAKIyAgICAgICogQ29weXJpZ2h0IChjKTIwMDgtMjAxNyBFbnRlcnByaXNlIEFyY2hpdGVjdHVyZSBTb2x1dGlvbnMgbHRkLgojICAgICAgKiBUaGlzIGZpbGUgaXMgcGFydCBvZiBFc3NlbnRpYWwgQXJjaGl0ZWN0dXJlIE1hbmFnZXIsIAojICAgICAgKiB0aGUgRXNzZW50aWFsIEFyY2hpdGVjdHVyZSBNZXRhIE1vZGVsIGFuZCBUaGUgRXNzZW50aWFsIFByb2plY3QuCiMgICAgICAqCiMgICAgICAqIEVzc2VudGlhbCBBcmNoaXRlY3R1cmUgTWFuYWdlciBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5CiMgICAgICAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiMgICAgICAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgICAgICAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiMgICAgICAqCiMgICAgICAqIEVzc2VudGlhbCBBcmNoaXRlY3R1cmUgTWFuYWdlciBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAojICAgICAgKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgICAgICAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiMgICAgICAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiMgICAgICAqCiMgICAgICAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiMgICAgICAqIGFsb25nIHdpdGggRXNzZW50aWFsIEFyY2hpdGVjdHVyZSBNYW5hZ2VyLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgojICAgICAgKiAKIyAgICAgICAKIyAxOS4wMi4yMDA4CUpXQyB2MS4wCiMgMjAuMDUuMjAwOAlKV0MgdjEuMAojIDIyLjA1LjIwMDgJSldDIHYxLjAgcmVsZWFzZWQgQ3JlYXRlIG9yIFVwZGF0ZSBpbnN0YW5jZXMgYW5kIEF0dHJpYnV0ZXMKIyAxNS4wNy4yMDA4CUpXQyB2MS4xIEFkZGVkIG5ldyBmdW5jdGlvbnMgZm9yIGZpbmRpbmcgaW5zdGFuY2VzIGJ5IG5hbWUgaW4gRXNzZW50aWFsLgojIDE3LjA3LjIwMDgJSldDCXYxLjEuMSBmaXhlZCBtYXRjaGluZyBpc3N1ZSBpbiBnZXRFc3NlbnRpYWxJbnN0YW5jZUNvbnRhaW5zSWdub3JlQ2FzZSgpCiMgMTEuMDguMjAwOAlKV0MJdjEuMiBBZGRlZCBuZXcgZnVuY3Rpb25zICgyKSB0byBtYXRjaCBpbnN0YW5jZSBuYW1lcyBtb3JlIGFjY3VyYXRlbHkKIyAwNC4wOS4yMDA4CUpXQwl2MS4yLjEgVXBkYXRlZCBhZGRJZk5vdFRoZXJlKCkgZnVuY3Rpb24gdG8gZW5zdXJlIG11bHRpcGxlIHZhbHVlcyBhcmUgbm90IAojCQkJCQkJIGFkZGVkIHRvIHNpbmdsZS1jYXJkaW5hbGl0eSBzbG90cy4gQWRkZWQgc2V0U2xvdCgpIGZ1bmN0aW9uIHRvIGVuYWJsZSB0aGlzCiMgMjAuMDMuMjAwOQlKV0MJdjEuMyBBZGRlZCBzdXBwb3J0IGZvciBpbXBvcnRpbmcgLyBzeW5jaHJvbmlzaW5nIEVBX1JlbGF0aW9uIGFuZCA6RUFfR3JhcGhfUmVsYXRpb24gaW5zdGFuY2VzCiMgMjAuMDMuMjAwOQlKV0MJdjEuMy4xIEZpeGVkIHRoZSBoYW5kbGluZyBvZiB0aGUgMyBuYW1lIHNsb3QgdmFyaWFudHMKIyAyMC4wOS4yMDExICAgIEpXQyB2MS40IEhhbmRsZSBncmFwaCByZWxhdGlvbnMgdGhhdCBoYXZlIG5vIDpyZWxhdGlvbl9uYW1lIHZhbHVlIGluIHRoZSBzb3VyY2UuCiMgMDQuMTAuMjAxMSAgICBKV0MgdjEuNSBNaWdyYXRlZCB0byAucHksIGhhbmRsZSBub24tZXhpc3RlbnQgc2xvdHMuCiMgMzEuMTAuMjAxMSAgICBKV0MgdjEuNiBNb3ZlZCBndWFyZCBjb2RlIHRvIGFkZElmTm90VGhlcmUoKSBhbmQgc2V0U2xvdCgpIHRvIGF2b2lkIG51bGwgaW5zdGFuY2UuCiMgMjguMDkuMjAxMiAgICBKV0MgdjEuNyBDaGFuZ2VkIHRoZSBwcm9ncmVzcyBwcmludGluZyB0byByZW1vdmUgbmFtZXMgLyBleHRlcm5hbCByZWZlcmVuY2VzIHVzZWQgdG8gc3VwcG9ydCBVbmljb2RlLgojIDE5LjExLjIwMTIgICAgSldDIHYxLjggQWRkZWQgbmV3IEluc3RhbmNlIGNyZWF0aW5nIGFuZCBnZXR0aW5nIGZ1bmN0aW9ucy4KIyAyMS4xMS4yMDEyICAgIEpXQyB2MS45IEFkZGVkIHRoZSBFc3NlbnRpYWxHZXRJbnN0YW5jZSgpIGZ1bmN0aW9uIHRvIGludGVsbGlnZW50bHkgZmluZCB0aGUgY29ycmVjdCBpbnN0YW5jZQojIDEyLjEyLjIwMTIgICAgSldDIHYxLjEwIEFkZGVkIHRoZSBHZXRBY3RvclRvUm9sZSgpIGZ1bmN0aW9uCiMgMDQuMDQuMjAxNCAgICBKV0MgdjEuMTEgQWRkZWQgZnVuY3Rpb25zIHRvIHNldCBzbG90cyB0aGF0IHRha2UgQ2xhc3MgYW5kIFNsb3QgaW5zdGFuY2VzLiBBbHNvIGRlbGV0ZSAvIHJlbW92ZSBmdW5jdGlvbnMuCiMgMDkuMDUuMjAxNCAgICBKV0MgdjEuMTIgQWRkaXRpb25hbCBmdW5jdGlvbnMgdG8gc3VwcG9ydCB0aGUgZGVsZXRlIC8gcmVtb3ZlIG9wZXJhdGlvbnMgb2YgdGhlIEltcG9ydCBVdGlsaXR5CiMgMTYuMDUuMjAxNCAgICBKV0MgdjEuMTMgUmV3b3JrZWQgRXNzZW50aWFsRGVsZXRlSW5zdGFuY2UgdG8gZmlsdGVyIGJ5IHNsb3RzIHRoYXQgaGF2ZSBjb250ZW50cyAvIHZhbHVlcwojIDMxLjA1LjIwMTcgICAgSldDIHYxLjE0IE5ldyBmdW5jdGlvbnMgdG8gaGFuZGxlIGltcG9ydHMgb2YgQ2xhc3Nlcy4KIyAyNy4wNy4yMDE3ICAgIEpXQyB2Mi4wIFJldmlzZWQgYXBwcm9hY2ggdG8gZmluZGluZyBpbnN0YW5jZXMgb2YgQ2xhc3Nlcy4KIyAyNi4wMi4yMDIwICAgIEpXQyB2Mi4xIFVzZSBvZiB0aGUgbmV3IHJlZmVyZW5jZWRfaW5zdGFuY2Ugc2xvdCBmb3IgZXh0ZXJuYWwgcmVmZXJlbmNlcwojIDI3LjAyLjIwMjAgICAgSldDIHYyLjIuMSBCZXR0ZXIgcGVyZm9ybWFuY2UgdXBkYXRlIGFuZCBkcm9wIHRoZSBnZXRSZWZlcmVuY2VkSW5zdGFuY2UoKQojIAojIEVzc2VudGlhbCh0bSkgQXJjaGl0ZWN0dXJlIE1hbmFnZXIKIyBTdGFuZGFyZCBzZXQgb2YgZnVuY3Rpb25zIHRvIGJlIHVzZWQgYnkgdGhlIGludGVncmF0aW9uL2ltcG9ydCBzY3JpcHRzCiMKCmZyb20gamF2YS51dGlsIGltcG9ydCBEYXRlCmZyb20gamF2YS50ZXh0IGltcG9ydCBEYXRlRm9ybWF0CmZyb20gZWR1LnN0YW5mb3JkLnNtaS5wcm90ZWdlLm1vZGVsIGltcG9ydCBWYWx1ZVR5cGUKCiMgR2V0IGEgcmVmZXJlbmNlIHRvIHRoZSBpbnN0YW5jZSBvZiB0aGUgc3BlY2lmaWVkIGNsYXNzIHRoYXQgaGFzIHRoZSBzcGVjaWZpZWQgZXh0ZXJuYWwgcmVmZXJlbmNlIGluIHRoZQojIHNwZWNpZmllZCBleHRlcm5hbCByZXBvc2l0b3J5LiBJZiBzdWNoIGFuIGluc3RhbmNlIGNhbm5vdCBiZSBmb3VuZCwgY3JlYXRlIG9uZSB3aXRoIHRoZSBzcGVjaWZpZWQgCiMgbmFtZSAocmVhbCBuYW1lLCBub3QgaW5zdGFuY2UgbmFtZSkKIyB0aGVDbGFzc05hbWUgLSB0aGUgbmFtZSBvZiB0aGUgRXNzZW50aWFsIG1ldGEgY2xhc3MKIyB0aGVFeHRlcm5hbFJlZiAtIHRoZSB1bmlxdWUgcmVmZXJlbmNlL2luc3RhbmNlIElEIG9mIHRoZSBlbGVtZW50IGluIHRoZSBleHRlcm5hbCByZXBvc2l0b3J5CiMgdGhlRXh0ZXJuYWxSZXBvc2l0b3J5IC0gdGhlIG5hbWUgb2YgdGhlIGV4dGVybmFsIHJlcG9zaXRvcnkKIyB0aGVJbnN0YW5jZU5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBjcmVhdGVkL3VwZGF0ZWQgaW4gdGhlIGludGVncmF0aW9uCmRlZiBnZXRFc3NlbnRpYWxJbnN0YW5jZSh0aGVDbGFzc05hbWUsIHRoZUV4dGVybmFsUmVmLCB0aGVFeHRlcm5hbFJlcG9zaXRvcnksIHRoZUluc3RhbmNlTmFtZSk6Cglhbkluc3RMaXN0ID0ga2IuZ2V0Q2xzKHRoZUNsYXNzTmFtZSkuZ2V0RGlyZWN0SW5zdGFuY2VzKCkKCWZvciBhbkluc3QgaW4gYW5JbnN0TGlzdDoKCQlhbkV4dGVybmFsUmVmTGlzdCA9IGFuSW5zdC5nZXREaXJlY3RPd25TbG90VmFsdWVzKGtiLmdldFNsb3QoImV4dGVybmFsX3JlcG9zaXRvcnlfaW5zdGFuY2VfcmVmZXJlbmNlIikpCgkJaWYgYW5FeHRlcm5hbFJlZkxpc3QgIT0gTm9uZToKCQkJYW5FeHRlcm5hbFJlZiA9IGdldEV4dGVybmFsUmVmSW5zdChhbkV4dGVybmFsUmVmTGlzdCwgZ2V0RXh0ZXJuYWxSZXBvc2l0b3J5KHRoZUV4dGVybmFsUmVwb3NpdG9yeSkpCgkJCWlmIGFuRXh0ZXJuYWxSZWYgIT0gTm9uZToKCQkJCWFuRXh0ZXJuYWxJRCA9IGFuRXh0ZXJuYWxSZWYuZ2V0RGlyZWN0T3duU2xvdFZhbHVlKGtiLmdldFNsb3QoImV4dGVybmFsX2luc3RhbmNlX3JlZmVyZW5jZSIpKQoJCQkJaWYoYW5FeHRlcm5hbElEID09IHRoZUV4dGVybmFsUmVmKToKCQkJCQlhbkV4dGVybmFsUmVmLnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJleHRlcm5hbF91cGRhdGVfZGF0ZSIpLCB0aW1lc3RhbXAoKSkKCQkJCQlwcmludCAiVXBkYXRlZCBpbnN0YW5jZSB2aWEgbmFtZSBtYXRjaCwgb24gY2xhc3M6ICIgKyB0aGVDbGFzc05hbWUKCQkJCQlyZXR1cm4gYW5JbnN0CgkjIGlmIHdlJ3JlIGhlcmUsIHdlIGhhdmVuJ3QgZm91bmQgb25lLCBzbyBjcmVhdGUgb25lCglhTmV3SW5zdCA9IGtiLmNyZWF0ZUluc3RhbmNlKE5vbmUsIGtiLmdldENscyh0aGVDbGFzc05hbWUpKQoJYW5FeHRlcm5hbFJlZiA9IGNyZWF0ZUV4dGVybmFsUmVmSW5zdCh0aGVFeHRlcm5hbFJlcG9zaXRvcnksIHRoZUV4dGVybmFsUmVmKQoJCgkjIEhhbmRsZSB0aGUgMyB2YXJpYW50cyBvZiBuYW1lCglhTmFtZVNsb3QgPSBnZXROYW1lU2xvdChhTmV3SW5zdCkKCWFOZXdJbnN0LnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KGFOYW1lU2xvdCksIHRoZUluc3RhbmNlTmFtZSkJCglhTmV3SW5zdC5hZGRPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgiZXh0ZXJuYWxfcmVwb3NpdG9yeV9pbnN0YW5jZV9yZWZlcmVuY2UiKSwgYW5FeHRlcm5hbFJlZikKCXByaW50ICJDcmVhdGVkIG5ldyBpbnN0YW5jZSBvZiBjbGFzczogIiArIHRoZUNsYXNzTmFtZQoJcmV0dXJuIGFOZXdJbnN0CgojIFJldHVybiB0aGUgZXh0ZXJuYWwgcmVmZXJlbmNlIHRoYXQgYXBwbGllZCB0byB0aGUgc3BlY2lmaWVkIEV4dGVybmFsIFJlcG9zaXRvcnkgZnJvbSBhIGxpc3QgCiMgb2YgZXh0ZXJuYWwgcmVmZXJlbmNlcyBmcm9tIGFuIEVzc2VudGlhbCBpbnN0YW5jZS4KIyB0aGVFeHRlcm5hbFJlZkxpc3QgLSB0aGUgbGlzdCBvZiBleHRlcm5hbCByZWZlcmVuY2UgcmVjb3JkcyBmb3IgYW4gRXNzZW50aWFsSW5zdGFuY2UKIyB0aGVFeHRlcm5hbFJlcG9zaXRvcnkgLSB0aGUgaW5zdGFuY2Ugb2YgdGhlIGV4dGVybmFsIHJlcG9zaXRvcnkJCmRlZiBnZXRFeHRlcm5hbFJlZkluc3QodGhlRXh0ZXJuYWxSZWZMaXN0LCB0aGVFeHRlcm5hbFJlcG9zaXRvcnkpOgogICAgIyBTZWFyY2ggdGhlIGxpc3QgbG9va2luZyBmb3IgdGhlIGVudHJ5IGFib3V0IHRoZSBzcGVjaWZpZWQgRXh0ZXJuYWwgUmVwb3NpdG9yeQogICAgYVJlZiA9IGZpbHRlcihsYW1iZGEgeDogeC5nZXREaXJlY3RPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgiZXh0ZXJuYWxfcmVwb3NpdG9yeV9yZWZlcmVuY2UiKSkgPT0gdGhlRXh0ZXJuYWxSZXBvc2l0b3J5LCB0aGVFeHRlcm5hbFJlZkxpc3QpCQogICAgcmV0dXJuIGFSZWZbMF0KCiMgQ3JlYXRlIGEgbmV3IEV4dGVybmFsIFJlZmVyZW5jZSByZWNvcmQgdG8gYmUgYXNzb2NpYXRlZCB3aXRoIGFuIEVzc2VudGlhbCBpbnN0YW5jZS4KIyB0aGVFeHRlcm5hbFJlcG9zaXRvcnkgLSB0aGUgbmFtZSAoYSBTdHJpbmcpIG9mIHRoZSBleHRlcm5hbCByZXBvc2l0b3J5CiMgdGhlRXh0ZXJuYWxSZWZlcmVuY2UgLSB0aGUgcmVmZXJlbmNlIElEIHRoYXQgaXMgdXNlZCBpbiB0aGUgc3BlY2lmaWVkIGV4dGVybmFsIHJlcG9zaXRvcnkKZGVmIGNyZWF0ZUV4dGVybmFsUmVmSW5zdCh0aGVFeHRlcm5hbFJlcG9zaXRvcnlOYW1lLCB0aGVFeHRlcm5hbFJlZmVyZW5jZSk6CglhTmV3RXh0ZXJuYWxSZWYgPSBrYi5jcmVhdGVJbnN0YW5jZShOb25lLCBrYi5nZXRDbHMoIkV4dGVybmFsX0luc3RhbmNlX1JlZmVyZW5jZSIpKQoJYU5ld0V4dGVybmFsUmVmLnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJuYW1lIiksIHRoZUV4dGVybmFsUmVwb3NpdG9yeU5hbWUgKyAiOjoiICsgdGhlRXh0ZXJuYWxSZWZlcmVuY2UpCglhTmV3RXh0ZXJuYWxSZWYuYWRkT3duU2xvdFZhbHVlKGtiLmdldFNsb3QoImV4dGVybmFsX3JlcG9zaXRvcnlfcmVmZXJlbmNlIiksIGdldEV4dGVybmFsUmVwb3NpdG9yeSh0aGVFeHRlcm5hbFJlcG9zaXRvcnlOYW1lKSkKCWFOZXdFeHRlcm5hbFJlZi5zZXRPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgiZXh0ZXJuYWxfaW5zdGFuY2VfcmVmZXJlbmNlIiksIHRoZUV4dGVybmFsUmVmZXJlbmNlKQoJYU5ld0V4dGVybmFsUmVmLnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJleHRlcm5hbF91cGRhdGVfZGF0ZSIpLCB0aW1lc3RhbXAoKSkKCXJldHVybiBhTmV3RXh0ZXJuYWxSZWYKCiMgR2V0IGEgcmVmZXJlbmNlIHRvIHRoZSBpbnN0YW5jZSBvZiBFeHRlcm5hbF9SZXBvc2l0b3J5IHRoYXQgaGFzIHRoZSBzcGVjaWZpZWQgbmFtZQojIHRoZUV4dGVybmFsUmVwb3NpdG9yeU5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgZXh0ZXJuYWwgcmVwb3NpdG9yeQpkZWYgZ2V0RXh0ZXJuYWxSZXBvc2l0b3J5KHRoZUV4dGVybmFsUmVwb3NpdG9yeU5hbWUpOgogICAgYW5FeHRSZXBvcyA9IEdldEluc3RhbmNlT2ZDbGFzcygiRXh0ZXJuYWxfUmVwb3NpdG9yeSIsIHRoZUV4dGVybmFsUmVwb3NpdG9yeU5hbWUpCiAgICBpZiBhbkV4dFJlcG9zICE9IE5vbmU6CiAgICAgICAgcmV0dXJuIGFuRXh0UmVwb3MKICAgICAgICAKICAgICMgcmVwb3J0IGVycm9yIGlmIG5vdCBmb3VuZAogICAgcHJpbnQgIlJlcG9zaXRvcnk6ICIgKyB0aGVFeHRlcm5hbFJlcG9zaXRvcnlOYW1lICsgIiBub3QgZGVmaW5lZCBhcyBhbiBleHRlcm5hbCByZXBvc2l0b3J5IGZvciBpbnRlZ3JhdGlvbiBpbiB0aGlzIEVzc2VudGlhbEFNIG1vZGVsIgoJCQkKIyBSZXR1cm4gYSBzdHJpbmcgb2YgdGhlIGN1cnJlbnQgZGF0ZS90aW1lIHRvIGJlIHVzZWQgZm9yIHRpbWVzdGFtcGluZy4KZGVmIHRpbWVzdGFtcCgpOgoJcmV0dXJuIERhdGVGb3JtYXQuZ2V0RGF0ZVRpbWVJbnN0YW5jZSgpLmZvcm1hdChEYXRlKCkpCgkKIyBVcGRhdGUgdGhlIG5hbWVkIGF0dHJpYnV0ZSBhc3NvY2lhdGVkIHdpdGggdGhlIHNwZWNpZmllZCB0ZWNobm9sb2d5IGluc3RhbmNlIG9iamVjdAojIG9yIGNyZWF0ZSBpdCBpZiBpdCdzIG5vdCBhbHJlYWR5IGJlZW4gZGVmaW5lZApkZWYgc2V0T3JVcGRhdGVUZWNoSW5zdEF0dHJpYnV0ZUJ5TmFtZSh0aGVBdHRyaWJ1dGVOYW1lLCB0aGVBdHRyaWJ1dGVWYWx1ZSwgdGhlSW5zdGFuY2UpOgoJYW5BdHRyaWJ1dGVMaXN0ID0ga2IuZ2V0Q2xzKCJBdHRyaWJ1dGUiKS5nZXREaXJlY3RJbnN0YW5jZXMoKQoJYUZvdW5kQXR0cmlidXRlID0gTm9uZQoJZm9yIGFuQXR0cmlidXRlIGluIGFuQXR0cmlidXRlTGlzdDoKCQlpZihhbkF0dHJpYnV0ZS5nZXREaXJlY3RPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgibmFtZSIpKSA9PSB0aGVBdHRyaWJ1dGVOYW1lKToKCQkJYUZvdW5kQXR0cmlidXRlID0gYW5BdHRyaWJ1dGUKCWFuQXR0cmlidXRlVmFsTGlzdCA9IHRoZUluc3RhbmNlLmdldERpcmVjdE93blNsb3RWYWx1ZXMoa2IuZ2V0U2xvdCgidGVjaG5vbG9neV9pbnN0YW5jZV9hdHRyaWJ1dGVzIikpCglmb3IgYW5BdHRyaWJ1dGVWYWwgaW4gYW5BdHRyaWJ1dGVWYWxMaXN0OgoJCWlmKGFuQXR0cmlidXRlVmFsLmdldERpcmVjdE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJhdHRyaWJ1dGVfdmFsdWVfb2YiKSkgPT0gYUZvdW5kQXR0cmlidXRlKToKCQkJYW5BdHRyaWJ1dGVWYWwuc2V0T3duU2xvdFZhbHVlKGtiLmdldFNsb3QoImF0dHJpYnV0ZV92YWx1ZSIpLCB0aGVBdHRyaWJ1dGVWYWx1ZSkKCQkJYW5BdHRyaWJ1dGVWYWwuc2V0T3duU2xvdFZhbHVlKGtiLmdldFNsb3QoIm5hbWUiKSwgdGhlQXR0cmlidXRlTmFtZSArICIgPSAiICsgdGhlQXR0cmlidXRlVmFsdWUpCgkJCXJldHVybgoJIyBFbHNlIHRoaXMgaW5zdGFuY2UgaGFzIG5vIGF0dHJpYnV0ZSB2YWx1ZSBkZWZpbmVkIGZvciB0aGlzIGF0dHJpYnV0ZQoJYU5ld0FWID0ga2IuY3JlYXRlSW5zdGFuY2UoTm9uZSwga2IuZ2V0Q2xzKCJBdHRyaWJ1dGVfVmFsdWUiKSkKCWFOZXdBVi5hZGRPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgiYXR0cmlidXRlX3ZhbHVlX29mIiksIGFGb3VuZEF0dHJpYnV0ZSkKCWFOZXdBVi5zZXRPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgiYXR0cmlidXRlX3ZhbHVlIiksIHRoZUF0dHJpYnV0ZVZhbHVlKQoJYU5ld0FWLnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJuYW1lIiksIHRoZUF0dHJpYnV0ZU5hbWUgKyAiID0gIiArIHRoZUF0dHJpYnV0ZVZhbHVlKQoJdGhlSW5zdGFuY2UuYWRkT3duU2xvdFZhbHVlKGtiLmdldFNsb3QoInRlY2hub2xvZ3lfaW5zdGFuY2VfYXR0cmlidXRlcyIpLCBhTmV3QVYpCgkJCiMgVXBkYXRlIHRoZSBuYW1lZCBhdHRyaWJ1dGUgYXNzb2NpYXRlZCB3aXRoIHRoZSBzcGVjaWZpZWQgdGVjaG5vbG9neSBOb2RlICh0aGVJbnN0YW5jZSkgb2JqZWN0CiMgb3IgY3JlYXRlIGl0IGlmIGl0J3Mgbm90IGFscmVhZHkgYmVlbiBkZWZpbmVkCmRlZiBzZXRPclVwZGF0ZVRlY2hOb2RlQXR0cmlidXRlQnlOYW1lKHRoZUF0dHJpYnV0ZU5hbWUsIHRoZUF0dHJpYnV0ZVZhbHVlLCB0aGVJbnN0YW5jZSk6CglhbkF0dHJpYnV0ZUxpc3QgPSBrYi5nZXRDbHMoIkF0dHJpYnV0ZSIpLmdldERpcmVjdEluc3RhbmNlcygpCglhRm91bmRBdHRyaWJ1dGUgPSBOb25lCglmb3IgYW5BdHRyaWJ1dGUgaW4gYW5BdHRyaWJ1dGVMaXN0OgoJCWlmKGFuQXR0cmlidXRlLmdldERpcmVjdE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJuYW1lIikpID09IHRoZUF0dHJpYnV0ZU5hbWUpOgoJCQlhRm91bmRBdHRyaWJ1dGUgPSBhbkF0dHJpYnV0ZQoJYW5BdHRyaWJ1dGVWYWxMaXN0ID0gdGhlSW5zdGFuY2UuZ2V0RGlyZWN0T3duU2xvdFZhbHVlcyhrYi5nZXRTbG90KCJ0ZWNobm9sb2d5X25vZGVfYXR0cmlidXRlcyIpKQoJZm9yIGFuQXR0cmlidXRlVmFsIGluIGFuQXR0cmlidXRlVmFsTGlzdDoKCQlpZihhbkF0dHJpYnV0ZVZhbC5nZXREaXJlY3RPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgiYXR0cmlidXRlX3ZhbHVlX29mIikpID09IGFGb3VuZEF0dHJpYnV0ZSk6CgkJCWFuQXR0cmlidXRlVmFsLnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJhdHRyaWJ1dGVfdmFsdWUiKSwgdGhlQXR0cmlidXRlVmFsdWUpCgkJCWFuQXR0cmlidXRlVmFsLnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJuYW1lIiksIHRoZUF0dHJpYnV0ZU5hbWUgKyAiID0gIiArIHRoZUF0dHJpYnV0ZVZhbHVlKQoJCQlyZXR1cm4KCSMgRWxzZSB0aGlzIGluc3RhbmNlIGhhcyBubyBhdHRyaWJ1dGUgdmFsdWUgZGVmaW5lZCBmb3IgdGhpcyBhdHRyaWJ1dGUKCWFOZXdBViA9IGtiLmNyZWF0ZUluc3RhbmNlKE5vbmUsIGtiLmdldENscygiQXR0cmlidXRlX1ZhbHVlIikpCglhTmV3QVYuYWRkT3duU2xvdFZhbHVlKGtiLmdldFNsb3QoImF0dHJpYnV0ZV92YWx1ZV9vZiIpLCBhRm91bmRBdHRyaWJ1dGUpCglhTmV3QVYuc2V0T3duU2xvdFZhbHVlKGtiLmdldFNsb3QoImF0dHJpYnV0ZV92YWx1ZSIpLCB0aGVBdHRyaWJ1dGVWYWx1ZSkKCWFOZXdBVi5zZXRPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgibmFtZSIpLCB0aGVBdHRyaWJ1dGVOYW1lICsgIiA9ICIgKyB0aGVBdHRyaWJ1dGVWYWx1ZSkKCXRoZUluc3RhbmNlLmFkZE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJ0ZWNobm9sb2d5X25vZGVfYXR0cmlidXRlcyIpLCBhTmV3QVYpCgojIFNldCBhIHNsb3QgdmFsdWUgdG8gdGhlIHNwZWNpZmllZCB2YWx1ZS4gVG8gYmUgdXNlZCB3aXRoIHNpbmdsZS1jYXJkaW5hbGl0eSBzbG90cwojIG9ubHkKIyB0aGVJbnN0YW5jZSAtIHRoZSBpbnN0YW5jZSB0byB3aGljaCB3ZSB3aXNoIHRvIHNldCB0aGUgc2xvdCB0byBjb250YWluIHRoZUluc3RhbmNlVG9BZGQKIyB0aGVTbG90TmFtZSAtIHRoZSBuYW1lIG9mIHRoZSBzbG90IG9uIHRoZUluc3RhbmNlCiMgdGhlSW5zdGFuY2VUb0FkZCAtIHRoZSBpbnN0YW5jZSB0byBzZXQgaW4gdGhlU2xvdE5hbWUgc2xvdCBvbiB0aGVJbnN0YW5jZQojIDA0LjEwLjIwMTEgSldDIC0gY2hlY2sgdGhhdCBzbG90IGV4aXN0cyBmaXJzdAojIDMxLjEwLjIwMTEgSldDIC0gR3VhcmQgY29kZSwgQ2hlY2sgdGhlSW5zdGFuY2UgIT0gTm9uZQpkZWYgc2V0U2xvdCh0aGVJbnN0YW5jZSwgdGhlU2xvdE5hbWUsIHRoZUluc3RhbmNlVG9BZGQpOgogICAgaWYgdGhlSW5zdGFuY2UgPT0gTm9uZToKICAgICAgICByZXR1cm4KICAgIGFTbG90ID0ga2IuZ2V0U2xvdCh0aGVTbG90TmFtZSkKICAgIGlmIGFTbG90ICE9IE5vbmU6CiAgICAgICAgdGhlSW5zdGFuY2Uuc2V0T3duU2xvdFZhbHVlKGFTbG90LCB0aGVJbnN0YW5jZVRvQWRkKQogICAgZWxzZToKICAgICAgICBwcmludCAiV0FSTklORzogQXR0ZW1wdCB0byBzZXQgbm9uLWV4aXN0ZW50IHNsb3Q6ICIgKyB0aGVTbG90TmFtZQoKIyBBZGQgdGhlIHNsb3QgdmFsdWUgdG8gdGhlIHNwZWNpZmllZCBpbnN0YW5jZSBvbmx5IGlmIGl0J3Mgbm90IGFscmVhZHkgdGhlcmUuCiMgdGhlSW5zdGFuY2UgLSB0aGUgaW5zdGFuY2UgdG8gd2hpY2ggd2Ugd2lzaCB0byBhZGQgdGhlSW5zdGFuY2VUb0FkZAojIHRoZVNsb3ROYW1lIC0gdGhlIG5hbWUgb2YgdGhlIHNsb3Qgb24gdGhlSW5zdGFuY2UKIyB0aGVJbnN0YW5jZVRvQWRkIC0gdGhlIGluc3RhbmNlIHRvIGFkZCB0byB0aGVTbG90TmFtZSBzbG90IG9uIHRoZUluc3RhbmNlCiMgdjEuMi4xOiBJZiB0aGVTbG90TmFtZSBpcyBhIHNpbmdsZSBjYXJkaW5hbGl0eSBzbG90LCB1c2Ugc2V0U2xvdCgpCiMgMDQuMTAuMjAxMSBKV0MgLSBjaGVjayB0aGF0IHRoZSBzbG90IGV4aXN0cyBmaXJzdAojIDMxLjEwLjIwMTEgSldDIC0gR3VhcmQgY29kZSwgQ2hlY2sgdGhlSW5zdGFuY2UgIT0gTm9uZQpkZWYgYWRkSWZOb3RUaGVyZSh0aGVJbnN0YW5jZSwgdGhlU2xvdE5hbWUsIHRoZUluc3RhbmNlVG9BZGQpOgogICAgaWYgdGhlSW5zdGFuY2UgPT0gTm9uZToKICAgICAgICByZXR1cm4KICAgIGFTbG90ID0ga2IuZ2V0U2xvdCh0aGVTbG90TmFtZSkKICAgIGlmIGFTbG90ICE9IE5vbmU6CiAgICAgICAgaWYgYVNsb3QuZ2V0QWxsb3dzTXVsdGlwbGVWYWx1ZXMoKToKICAgICAgICAgICAgYW5JbnN0TGlzdCA9IHRoZUluc3RhbmNlLmdldERpcmVjdE93blNsb3RWYWx1ZXMoa2IuZ2V0U2xvdCh0aGVTbG90TmFtZSkpCiAgICAgICAgICAgIGZvciBhbkluc3QgaW4gYW5JbnN0TGlzdDoKICAgICAgICAgICAgICAgIGlmIGFuSW5zdCA9PSB0aGVJbnN0YW5jZVRvQWRkOgogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAjIGVsc2Ugd2UgaGF2ZW4ndCBnb3QgdGhpcyBhbHJlYWR5LCBzbyBhZGQgaXQKICAgICAgICAgICAgdGhlSW5zdGFuY2UuYWRkT3duU2xvdFZhbHVlKGtiLmdldFNsb3QodGhlU2xvdE5hbWUpLCB0aGVJbnN0YW5jZVRvQWRkKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNldFNsb3QodGhlSW5zdGFuY2UsIHRoZVNsb3ROYW1lLCB0aGVJbnN0YW5jZVRvQWRkKQogICAgZWxzZToKICAgICAgICBwcmludCAiV0FSTklORzogQXR0ZW1wdCB0byBzZXQgbm9uLWV4aXN0ZW50IHNsb3Q6ICIgKyB0aGVTbG90TmFtZQoKIyBGaW5kIHRoZSBpbnN0YW5jZSBieSBhIGNvbnRhaW5zIGNhc2Utc2Vuc2l0aXZlIG1hdGNoIG9uIHRoZSBpbnN0YW5jZSBuYW1lIGluIEVzc2VudGlhbCByZXBvc2l0b3J5CiMgVXNlIHRoaXMgZm9yIGdldHRpbmcgaW5zdGFuY2VzIHRoYXQgYXJlIGV4cGVjdGVkIHRvIGFscmVhZHkgYmUgaW4gdGhlIHJlcG9zaXRvcnkKIyBJZiBub3QgZm91bmQsIGNyZWF0ZSBhIG5ldyBvbmUuCiMgdGhlQ2xhc3NOYW1lIC0gdGhlIEVzc2VudGlhbCBjbGFzcyBmb3IgdGhlIGluc3RhbmNlCiMgdGhlRXh0ZXJuYWxSZWYgLSB0aGUgRXh0ZXJuYWwgUmVmZXJlbmNlIElEIGZvciB0aGlzIGluc3RhbmNlCiMgdGhlRXh0ZXJuYWxSZXBvc2l0b3J5IC0gdGhlIEV4dGVybmFsIFJlcG9zaXRvcnkgdGhhdCB0aGVFeHRlcm5hbFJlZiBhcHBsaWVzIHRvCiMgdGhlSW5zdGFuY2VOYW1lIC0gdGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIGluIHRoZSBFc3NlbnRpYWwgUmVwb3NpdG9yeQpkZWYgZ2V0RXNzZW50aWFsSW5zdGFuY2VDb250YWlucyh0aGVDbGFzc05hbWUsIHRoZUV4dGVybmFsUmVmLCB0aGVFeHRlcm5hbFJlcG9zaXRvcnksIHRoZUluc3RhbmNlTmFtZSk6CiAgICAjIDIwLjA5LjIwMTEgSldDIC0gaGFuZGxlIGVtcHR5IHRoZUluc3RhbmNlTmFtZQogICAgaWYgdGhlSW5zdGFuY2VOYW1lID09ICIiOgogICAgICAgIHRoZUluc3RhbmNlTmFtZSA9IHRoZUV4dGVybmFsUmVmCiAgICAgICAgcHJpbnQgIkhhbmRsaW5nIGVtcHR5IGluc3RhbmNlIG5hbWUgZm9yICIgKyB0aGVFeHRlcm5hbFJlZgogICAgCiAgICAjIDIwLjA5LjIwMTEgSldDIC0gTWFrZSBzdXJlIHRoYXQgdGhlIHNvdXJjZSBjbGFzcyBpcyBpbiB0aGUgdGFyZ2VydCByZXBvc2l0b3J5CiAgICBhQ2xzID0ga2IuZ2V0Q2xzKHRoZUNsYXNzTmFtZSkgICAgCiAgICAjIGlmIG5vdC1yZXBvcnQgYSB3YXJuaW5nIGFuZCBza2lwIHRoYXQgaW5zdGFuY2UuCiAgICBpZiBhQ2xzID09IE5vbmU6CiAgICAgICAgcHJpbnQgIldBUk5JTkc6IFNraXBwaW5nIGluc3RhbmNlIG9mIHVua25vd24gY2xhc3M6ICIgKyB0aGVDbGFzc05hbWUgKyAiIDogIiArIHRoZUluc3RhbmNlTmFtZQogICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIGFuSW5zdExpc3QgPSBrYi5nZXRDbHModGhlQ2xhc3NOYW1lKS5nZXREaXJlY3RJbnN0YW5jZXMoKQogICAgZm9yIGFuSW5zdCBpbiBhbkluc3RMaXN0OgogICAgICAgIGFuRXh0ZXJuYWxSZWZMaXN0ID0gYW5JbnN0LmdldERpcmVjdE93blNsb3RWYWx1ZXMoa2IuZ2V0U2xvdCgiZXh0ZXJuYWxfcmVwb3NpdG9yeV9pbnN0YW5jZV9yZWZlcmVuY2UiKSkKICAgICAgICBpZiBhbkV4dGVybmFsUmVmTGlzdCAhPSBOb25lOgkKICAgICAgICAgICAgYW5FeHRlcm5hbFJlZiA9IGdldEV4dGVybmFsUmVmSW5zdChhbkV4dGVybmFsUmVmTGlzdCwgZ2V0RXh0ZXJuYWxSZXBvc2l0b3J5KHRoZUV4dGVybmFsUmVwb3NpdG9yeSkpCiAgICAgICAgICAgIGlmIGFuRXh0ZXJuYWxSZWYgIT0gTm9uZToKICAgICAgICAgICAgICAgIGFuRXh0ZXJuYWxJRCA9IGFuRXh0ZXJuYWxSZWYuZ2V0RGlyZWN0T3duU2xvdFZhbHVlKGtiLmdldFNsb3QoImV4dGVybmFsX2luc3RhbmNlX3JlZmVyZW5jZSIpKQogICAgICAgICAgICAgICAgaWYoYW5FeHRlcm5hbElEID09IHRoZUV4dGVybmFsUmVmKToKICAgICAgICAgICAgICAgICAgICBhbkV4dGVybmFsUmVmLnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJleHRlcm5hbF91cGRhdGVfZGF0ZSIpLCB0aW1lc3RhbXAoKSkKICAgICAgICAgICAgICAgICAgICBwcmludCAiVXBkYXRlZCBJbnN0YW5jZSB2aWEgRXh0ZXJuYWwgUmVmZXJlbmNlIG9uIGNsYXNzOiAiICsgdGhlQ2xhc3NOYW1lCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFuSW5zdAoKCSMgSWYgd2UncmUgaGVyZSwgdGhpcyBleHRlcm5hbCByZWZlcmVuY2UgaGFzbid0IGJlZW4gZm91bmQuCgkjIFRyeSB0byBmaW5kIGJ5IGluc3RhbmNlX25hbWUgYW5kIGNhc2Ugc2Vuc2l0aXZlCiAgICBhTmFtZVNsb3QgPSBnZXROYW1lU2xvdEZvckNsYXNzKHRoZUNsYXNzTmFtZSkKICAgIGZvciBhbkluc3QgaW4gYW5JbnN0TGlzdDoKICAgICAgICBhTmFtZSA9IGFuSW5zdC5nZXREaXJlY3RPd25TbG90VmFsdWUoa2IuZ2V0U2xvdChhTmFtZVNsb3QpKQoJCQogICAgICAgIGlmIGFOYW1lICE9IE5vbmU6CiAgICAgICAgICAgIGlmKGFOYW1lLmZpbmQodGhlSW5zdGFuY2VOYW1lKSAhPSAtMSk6CiAgICAgICAgICAgICAgICAjIFdlIGhhdmUgZm91bmQgYSBtYXRjaAogICAgICAgICAgICAgICAgYW5FeHRlcm5hbFJlZiA9IGNyZWF0ZUV4dGVybmFsUmVmSW5zdCh0aGVFeHRlcm5hbFJlcG9zaXRvcnksIHRoZUV4dGVybmFsUmVmKQogICAgICAgICAgICAgICAgYW5JbnN0LmFkZE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJleHRlcm5hbF9yZXBvc2l0b3J5X2luc3RhbmNlX3JlZmVyZW5jZSIpLCBhbkV4dGVybmFsUmVmKQogICAgICAgICAgICAgICAgcHJpbnQgIlVwZGF0ZWQgaW5zdGFuY2UgdmlhIG5hbWUgbWF0Y2gsIG9uIGNsYXNzOiAiICsgdGhlQ2xhc3NOYW1lCiAgICAgICAgICAgICAgICByZXR1cm4gYW5JbnN0CgkJCQkKICAgICMgaWYgd2UncmUgaGVyZSwgd2UgaGF2ZW4ndCBmb3VuZCBvbmUsIHNvIGNyZWF0ZSBvbmUKICAgIGFOZXdJbnN0ID0ga2IuY3JlYXRlSW5zdGFuY2UoTm9uZSwga2IuZ2V0Q2xzKHRoZUNsYXNzTmFtZSkpCgkKCSMgSGFuZGxlIHRoZSAzIHZhcmlhbnRzIG9mIG5hbWUKCSNhTmFtZVNsb3QgPSBnZXROYW1lU2xvdChhTmV3SW5zdCkKICAgIGFOZXdJbnN0LnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KGFOYW1lU2xvdCksIHRoZUluc3RhbmNlTmFtZSkJCgkJCQkKICAgIGFuRXh0ZXJuYWxSZWYgPSBjcmVhdGVFeHRlcm5hbFJlZkluc3QodGhlRXh0ZXJuYWxSZXBvc2l0b3J5LCB0aGVFeHRlcm5hbFJlZikKICAgIGFOZXdJbnN0LmFkZE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJleHRlcm5hbF9yZXBvc2l0b3J5X2luc3RhbmNlX3JlZmVyZW5jZSIpLCBhbkV4dGVybmFsUmVmKQogICAgcHJpbnQgIkNyZWF0ZWQgbmV3IGluc3RhbmNlIG9mIGNsYXNzOiAiICsgdGhlQ2xhc3NOYW1lCiAgICByZXR1cm4gYU5ld0luc3QKCiMgRmluZCB0aGUgaW5zdGFuY2UgYnkgYSBjb250YWlucyBtYXRjaCAtIGlnbm9yaW5nIGNhc2UgLSBvbiB0aGUgaW5zdGFuY2UgbmFtZSBpbiBFc3NlbnRpYWwgcmVwb3NpdG9yeQojIFVzZSB0aGlzIGZvciBnZXR0aW5nIGluc3RhbmNlcyB0aGF0IGFyZSBleHBlY3RlZCB0byBhbHJlYWR5IGJlIGluIHRoZSByZXBvc2l0b3J5LiBVc2UgdGhlTWF0Y2hTdHJpbmcKIyB0byBzcGVjaWZ5IHRoZSBzdHJpbmcgdG8gdXNlIGFzIGEgbWF0Y2ggb24gZXhpc3RpbmcgaW5zdGFuY2VzLgojIElmIG5vdCBmb3VuZCwgY3JlYXRlIGEgbmV3IG9uZS4KIyB0aGVDbGFzc05hbWUgLSB0aGUgRXNzZW50aWFsIGNsYXNzIGZvciB0aGUgaW5zdGFuY2UKIyB0aGVFeHRlcm5hbFJlZiAtIHRoZSBFeHRlcm5hbCBSZWZlcmVuY2UgSUQgZm9yIHRoaXMgaW5zdGFuY2UKIyB0aGVFeHRlcm5hbFJlcG9zaXRvcnkgLSB0aGUgRXh0ZXJuYWwgUmVwb3NpdG9yeSB0aGF0IHRoZUV4dGVybmFsUmVmIGFwcGxpZXMgdG8KIyB0aGVJbnN0YW5jZU5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgaW4gdGhlIEVzc2VudGlhbCBSZXBvc2l0b3J5CiMgdGhlTWF0Y2hTdHJpbmcgLSB0aGUgc3RyaW5nIHRoYXQgc2hvdWxkIGJlIHVzZWQgdG8gbWF0Y2ggYWdhaW5zdCBhbmQgZmluZCB0aGUgaW5zdGFuY2UKZGVmIGdldEVzc2VudGlhbEluc3RhbmNlQ29udGFpbnNJZ25vcmVDYXNlKHRoZUNsYXNzTmFtZSwgdGhlRXh0ZXJuYWxSZWYsIHRoZUV4dGVybmFsUmVwb3NpdG9yeSwgdGhlSW5zdGFuY2VOYW1lLCB0aGVNYXRjaFN0cmluZyk6Cglhbkluc3RMaXN0ID0ga2IuZ2V0Q2xzKHRoZUNsYXNzTmFtZSkuZ2V0RGlyZWN0SW5zdGFuY2VzKCkKCWZvciBhbkluc3QgaW4gYW5JbnN0TGlzdDoKCQlhbkV4dGVybmFsUmVmTGlzdCA9IGFuSW5zdC5nZXREaXJlY3RPd25TbG90VmFsdWVzKGtiLmdldFNsb3QoImV4dGVybmFsX3JlcG9zaXRvcnlfaW5zdGFuY2VfcmVmZXJlbmNlIikpCgkJaWYgYW5FeHRlcm5hbFJlZkxpc3QgIT0gTm9uZToJCgkJCWFuRXh0ZXJuYWxSZWYgPSBnZXRFeHRlcm5hbFJlZkluc3QoYW5FeHRlcm5hbFJlZkxpc3QsIGdldEV4dGVybmFsUmVwb3NpdG9yeSh0aGVFeHRlcm5hbFJlcG9zaXRvcnkpKQoJCQlpZiBhbkV4dGVybmFsUmVmICE9IE5vbmU6CgkJCQlhbkV4dGVybmFsSUQgPSBhbkV4dGVybmFsUmVmLmdldERpcmVjdE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJleHRlcm5hbF9pbnN0YW5jZV9yZWZlcmVuY2UiKSkKCQkJCWlmKGFuRXh0ZXJuYWxJRCA9PSB0aGVFeHRlcm5hbFJlZik6CgkJCQkJYW5FeHRlcm5hbFJlZi5zZXRPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgiZXh0ZXJuYWxfdXBkYXRlX2RhdGUiKSwgdGltZXN0YW1wKCkpCgkJCQkJcHJpbnQgIlVwZGF0ZWQgSW5zdGFuY2UgdmlhIEV4dGVybmFsIFJlZmVyZW5jZSBvbiBjbGFzczogIiArIHRoZUNsYXNzTmFtZQoJCQkJCXJldHVybiBhbkluc3QKCQkJCQkKCSMgSWYgd2UncmUgaGVyZSwgdGhpcyBleHRlcm5hbCByZWZlcmVuY2UgaGFzbid0IGJlZW4gZm91bmQuCgkjIFRyeSB0byBmaW5kIGJ5IGluc3RhbmNlX25hbWUgLSBpZ25vcmluZyBjYXNlIG9mIGVhY2gKCWFOYW1lU2xvdCA9IGdldE5hbWVTbG90Rm9yQ2xhc3ModGhlQ2xhc3NOYW1lKQoJZm9yIGFuSW5zdCBpbiBhbkluc3RMaXN0OgoJCWFOYW1lID0gYW5JbnN0LmdldERpcmVjdE93blNsb3RWYWx1ZShrYi5nZXRTbG90KGFOYW1lU2xvdCkpCgkJaWYgYU5hbWUgIT0gTm9uZToKCQkJYU5hbWUgPSBhTmFtZS5sb3dlcigpCgkJCWFNYXRjaE5hbWUgPSB0aGVNYXRjaFN0cmluZy5sb3dlcigpCgkJCWlmKChhTmFtZS5maW5kKGFNYXRjaE5hbWUpICE9IC0xKSBvciAoYU1hdGNoTmFtZS5maW5kKGFOYW1lKSAhPSAtMSkpOgoJCQkJIyBXZSBoYXZlIGZvdW5kIGEgbWF0Y2gKCQkJCWFuRXh0ZXJuYWxSZWYgPSBjcmVhdGVFeHRlcm5hbFJlZkluc3QodGhlRXh0ZXJuYWxSZXBvc2l0b3J5LCB0aGVFeHRlcm5hbFJlZikKCQkJCWFuSW5zdC5hZGRPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgiZXh0ZXJuYWxfcmVwb3NpdG9yeV9pbnN0YW5jZV9yZWZlcmVuY2UiKSwgYW5FeHRlcm5hbFJlZikKCQkJCXByaW50ICJVcGRhdGVkIGluc3RhbmNlIHZpYSBuYW1lIG1hdGNoLCBvbiBjbGFzczogIiArIHRoZUNsYXNzTmFtZQoJCQkJcmV0dXJuIGFuSW5zdAoJCQkJCgkjIGlmIHdlJ3JlIGhlcmUsIHdlIGhhdmVuJ3QgZm91bmQgb25lLCBzbyBjcmVhdGUgb25lCglhTmV3SW5zdCA9IGtiLmNyZWF0ZUluc3RhbmNlKE5vbmUsIGtiLmdldENscyh0aGVDbGFzc05hbWUpKQoJYU5ld0luc3Quc2V0T3duU2xvdFZhbHVlKGtiLmdldFNsb3QoYU5hbWVTbG90KSwgdGhlSW5zdGFuY2VOYW1lKQkJCQoJYW5FeHRlcm5hbFJlZiA9IGNyZWF0ZUV4dGVybmFsUmVmSW5zdCh0aGVFeHRlcm5hbFJlcG9zaXRvcnksIHRoZUV4dGVybmFsUmVmKQoJYU5ld0luc3QuYWRkT3duU2xvdFZhbHVlKGtiLmdldFNsb3QoImV4dGVybmFsX3JlcG9zaXRvcnlfaW5zdGFuY2VfcmVmZXJlbmNlIiksIGFuRXh0ZXJuYWxSZWYpCglwcmludCAiQ3JlYXRlZCBuZXcgaW5zdGFuY2Ugb2YgY2xhc3M6ICIgKyB0aGVDbGFzc05hbWUKCXJldHVybiBhTmV3SW5zdAoJCiMgRGVmaW5lIGEgbmV3IEV4dGVybmFsIFJlcG9zaXRvcnkgb3IgaWdub3JlIGRlZmluaXRpb24gaWYgdGhlIHJlcG9zaXRvcnkgaXMgYWxyZWFkeSBrbm93bgojIHRoZUV4dGVybmFsUmVwb3NpdG9yeSAtIHRoZSBuYW1lIG9mIHRoZSBleHRlcm5hbCByZXBvc2l0b3J5CmRlZiBkZWZpbmVFeHRlcm5hbFJlcG9zaXRvcnkodGhlRXh0ZXJuYWxSZXBvc2l0b3J5LCB0aGVEZXNjcmlwdGlvbik6CiAgICBhbkluc3RhbmNlID0gR2V0SW5zdGFuY2VPZkNsYXNzKCJFeHRlcm5hbF9SZXBvc2l0b3J5IiwgdGhlRXh0ZXJuYWxSZXBvc2l0b3J5KQogICAgaWYgYW5JbnN0YW5jZSAhPSBOb25lOgogICAgICAgIHJldHVybiBhbkluc3RhbmNlCgoJIyBpZiB3ZSdyZSBoZXJlIGl0J3Mgbm90IGRlZmluZWQsIHNvIGRlZmluZSBpdC4KICAgIGFOZXdSZXBvcyA9IGtiLmNyZWF0ZUluc3RhbmNlKE5vbmUsIGtiLmdldENscygiRXh0ZXJuYWxfUmVwb3NpdG9yeSIpKQogICAgYU5ld1JlcG9zLnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJuYW1lIiksIHRoZUV4dGVybmFsUmVwb3NpdG9yeSkKICAgIGFOZXdSZXBvcy5zZXRPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgiZGVzY3JpcHRpb24iKSwgdGhlRGVzY3JpcHRpb24pCiAgICByZXR1cm4gYU5ld1JlcG9zCgkKIyBGdW5jdGlvbiB0byBhZGQgYSBuZXcgQXR0cmlidXRlIGluc3RhbmNlIHRvIHRoZSBFc3NlbnRpYWwgbW9kZWwuCiMgdGhlTmFtZSAtIHRoZSBuYW1lIG9mIHRoZSBBdHRyaWJ1dGUKIyB0aGVEZXNjcmlwdGlvbiAtIGEgZGVzY3JpcHRpb24gb2YgdGhlIGF0dHJpYnV0ZQojIHRoZVVuaXQgLSB0aGUgdW5pdHMgb2YgdGhlIGF0dHJpYnV0ZSB2YWx1ZSwgZS5nLiBNQiwgTWJwcywga2cgb3IgJ18nIG9yIHNwYWNlIGlmIG5vdCBhcHBsaWNhYmxlCmRlZiBhZGROZXdFQU1BdHRyaWJ1dGUodGhlTmFtZSwgdGhlRGVzY3JpcHRpb24sIHRoZVVuaXQpOgoJYW5BdHRyaWJ1dGVMaXN0ID0ga2IuZ2V0Q2xzKCJBdHRyaWJ1dGUiKS5nZXREaXJlY3RJbnN0YW5jZXMoKQoJYUZvdW5kQXR0cmlidXRlID0gTm9uZQoJZm9yIGFuQXR0cmlidXRlIGluIGFuQXR0cmlidXRlTGlzdDoKCQlpZihhbkF0dHJpYnV0ZS5nZXREaXJlY3RPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgibmFtZSIpKSA9PSB0aGVOYW1lKToKCQkJYUZvdW5kQXR0cmlidXRlID0gYW5BdHRyaWJ1dGUKCQkJYnJlYWsKCWlmIGFGb3VuZEF0dHJpYnV0ZSA9PSBOb25lOgoJCWFOZXdBdHRyaWJ1dGUgPSBrYi5jcmVhdGVJbnN0YW5jZShOb25lLCBrYi5nZXRDbHMoIkF0dHJpYnV0ZSIpKQoJCWFOZXdBdHRyaWJ1dGUuc2V0T3duU2xvdFZhbHVlKGtiLmdldFNsb3QoIm5hbWUiKSwgdGhlTmFtZSkKCQlhTmV3QXR0cmlidXRlLnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJkZXNjcmlwdGlvbiIpLCB0aGVEZXNjcmlwdGlvbikKCQlhTmV3QXR0cmlidXRlLnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJhdHRyaWJ1dGVfdmFsdWVfdW5pdCIpLCB0aGVVbml0KQoKIyBGdW5jdGlvbiB0byBmaW5kIFRlY2hub2xvZ3lfTm9kZSBpbnN0YW5jZXMgYnkgYSBuYW1lIG1hdGNoIChwcmVjaXNlLCBub3QgY29udGFpbnMpLCByZWdhcmRsZXNzIG9mIGNhc2UKIyBVc2UgdGhpcyBmb3IgZ2V0dGluZyBpbnN0YW5jZXMgdGhhdCBhcmUgZXhwZWN0ZWQgdG8gYWxyZWFkeSBiZSBpbiB0aGUgcmVwb3NpdG9yeS4gVXNlIHRoZU1hdGNoU3RyaW5nCiMgdG8gc3BlY2lmeSB0aGUgc3RyaW5nIHRvIHVzZSBhcyBhIG1hdGNoIG9uIGV4aXN0aW5nIGluc3RhbmNlcy4gTWF0Y2hpbmcgaXMgYmFzZWQgb24ganVzdCB0aGUgaG9zdG5hbWUKIyBhbmQgc3RyaXBzIGFueSB0cmFpbGluZyBkb21haW4gY29tcG9uZW50cyBmcm9tIHRoZSBuYW1lLCBhZnRlciB0aGUgZmlyc3QgJy4nCiMgSWYgbm90IGZvdW5kLCBjcmVhdGUgYSBuZXcgb25lLgojIHRoZUNsYXNzTmFtZSAtIHRoZSBFc3NlbnRpYWwgY2xhc3MgZm9yIHRoZSBpbnN0YW5jZQojIHRoZUV4dGVybmFsUmVmIC0gdGhlIEV4dGVybmFsIFJlZmVyZW5jZSBJRCBmb3IgdGhpcyBpbnN0YW5jZQojIHRoZUV4dGVybmFsUmVwb3NpdG9yeSAtIHRoZSBFeHRlcm5hbCBSZXBvc2l0b3J5IHRoYXQgdGhlRXh0ZXJuYWxSZWYgYXBwbGllcyB0bwojIHRoZUluc3RhbmNlTmFtZSAtIHRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSBpbiB0aGUgRXNzZW50aWFsIFJlcG9zaXRvcnkKIyB0aGVNYXRjaFN0cmluZyAtIHRoZSBzdHJpbmcgdGhhdCBzaG91bGQgYmUgdXNlZCB0byBtYXRjaCBhZ2FpbnN0IGFuZCBmaW5kIHRoZSBpbnN0YW5jZSAKZGVmIGdldEVzc2VudGlhbE5vZGVJbnN0YW5jZUlnbm9yZUNhc2UodGhlQ2xhc3NOYW1lLCB0aGVFeHRlcm5hbFJlZiwgdGhlRXh0ZXJuYWxSZXBvc2l0b3J5LCB0aGVJbnN0YW5jZU5hbWUsIHRoZU1hdGNoU3RyaW5nKToKCWFuSW5zdExpc3QgPSBrYi5nZXRDbHModGhlQ2xhc3NOYW1lKS5nZXREaXJlY3RJbnN0YW5jZXMoKQoJZm9yIGFuSW5zdCBpbiBhbkluc3RMaXN0OgoJCWFuRXh0ZXJuYWxSZWZMaXN0ID0gYW5JbnN0LmdldERpcmVjdE93blNsb3RWYWx1ZXMoa2IuZ2V0U2xvdCgiZXh0ZXJuYWxfcmVwb3NpdG9yeV9pbnN0YW5jZV9yZWZlcmVuY2UiKSkKCQlpZiBhbkV4dGVybmFsUmVmTGlzdCAhPSBOb25lOgkKCQkJYW5FeHRlcm5hbFJlZiA9IGdldEV4dGVybmFsUmVmSW5zdChhbkV4dGVybmFsUmVmTGlzdCwgZ2V0RXh0ZXJuYWxSZXBvc2l0b3J5KHRoZUV4dGVybmFsUmVwb3NpdG9yeSkpCgkJCWlmIGFuRXh0ZXJuYWxSZWYgIT0gTm9uZToKCQkJCWFuRXh0ZXJuYWxJRCA9IGFuRXh0ZXJuYWxSZWYuZ2V0RGlyZWN0T3duU2xvdFZhbHVlKGtiLmdldFNsb3QoImV4dGVybmFsX2luc3RhbmNlX3JlZmVyZW5jZSIpKQoJCQkJaWYoYW5FeHRlcm5hbElEID09IHRoZUV4dGVybmFsUmVmKToKCQkJCQlhbkV4dGVybmFsUmVmLnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJleHRlcm5hbF91cGRhdGVfZGF0ZSIpLCB0aW1lc3RhbXAoKSkKCQkJCQlwcmludCAiVXBkYXRlZCBJbnN0YW5jZSB2aWEgRXh0ZXJuYWwgUmVmZXJlbmNlIG9uIGNsYXNzOiAiICsgdGhlQ2xhc3NOYW1lCgkJCQkJcmV0dXJuIGFuSW5zdAoJCQkJCQoJIyBJZiB3ZSdyZSBoZXJlLCB0aGlzIGV4dGVybmFsIHJlZmVyZW5jZSBoYXNuJ3QgYmVlbiBmb3VuZC4KCSMgVHJ5IHRvIGZpbmQgYnkgaW5zdGFuY2VfbmFtZSAtIGlnbm9yaW5nIGNhc2Ugb2YgZWFjaAoJZm9yIGFuSW5zdCBpbiBhbkluc3RMaXN0OgoJCWFOYW1lID0gYW5JbnN0LmdldERpcmVjdE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJuYW1lIikpCgkJaWYgYU5hbWUgIT0gTm9uZToKCQkJYU5hbWUgPSBhTmFtZS5zcGxpdCgiLiIsIDEpWzBdLmxvd2VyKCkKCQkJYU1hdGNoTmFtZSA9IHRoZU1hdGNoU3RyaW5nLmxvd2VyKCkKCQkJaWYoYU5hbWUgPT0gYU1hdGNoTmFtZSk6CgkJCQkjIFdlIGhhdmUgZm91bmQgYSBtYXRjaAoJCQkJYW5FeHRlcm5hbFJlZiA9IGNyZWF0ZUV4dGVybmFsUmVmSW5zdCh0aGVFeHRlcm5hbFJlcG9zaXRvcnksIHRoZUV4dGVybmFsUmVmKQoJCQkJYW5JbnN0LmFkZE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJleHRlcm5hbF9yZXBvc2l0b3J5X2luc3RhbmNlX3JlZmVyZW5jZSIpLCBhbkV4dGVybmFsUmVmKQoJCQkJcHJpbnQgIlVwZGF0ZWQgaW5zdGFuY2UgdmlhIG5hbWUgbWF0Y2gsIG9uIGNsYXNzOiAiICsgdGhlQ2xhc3NOYW1lCgkJCQlyZXR1cm4gYW5JbnN0CgkJCQkKCSMgaWYgd2UncmUgaGVyZSwgd2UgaGF2ZW4ndCBmb3VuZCBvbmUsIHNvIGNyZWF0ZSBvbmUKCWFOZXdJbnN0ID0ga2IuY3JlYXRlSW5zdGFuY2UoTm9uZSwga2IuZ2V0Q2xzKHRoZUNsYXNzTmFtZSkpCglhTmV3SW5zdC5zZXRPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgibmFtZSIpLCB0aGVJbnN0YW5jZU5hbWUpCQkJCglhbkV4dGVybmFsUmVmID0gY3JlYXRlRXh0ZXJuYWxSZWZJbnN0KHRoZUV4dGVybmFsUmVwb3NpdG9yeSwgdGhlRXh0ZXJuYWxSZWYpCglhTmV3SW5zdC5hZGRPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgiZXh0ZXJuYWxfcmVwb3NpdG9yeV9pbnN0YW5jZV9yZWZlcmVuY2UiKSwgYW5FeHRlcm5hbFJlZikKCXByaW50ICJDcmVhdGVkIG5ldyBpbnN0YW5jZSBvZiBjbGFzczogIiArIHRoZUNsYXNzTmFtZQoJcmV0dXJuIGFOZXdJbnN0CgkKIyBGdW5jdGlvbiB0byBmaW5kIGluc3RhbmNlcyBieSBhIG5hbWUgbWF0Y2ggKHByZWNpc2UsIG5vdCBjb250YWlucyksIHJlZ2FyZGxlc3Mgb2YgY2FzZQojIFVzZSB0aGlzIGZvciBnZXR0aW5nIGluc3RhbmNlcyB0aGF0IGFyZSBleHBlY3RlZCB0byBhbHJlYWR5IGJlIGluIHRoZSByZXBvc2l0b3J5LiBVc2UgdGhlTWF0Y2hTdHJpbmcKIyB0byBzcGVjaWZ5IHRoZSBzdHJpbmcgdG8gdXNlIGFzIGEgbWF0Y2ggb24gZXhpc3RpbmcgaW5zdGFuY2VzLgojIElmIG5vdCBmb3VuZCwgY3JlYXRlIGEgbmV3IG9uZS4KIyB0aGVDbGFzc05hbWUgLSB0aGUgRXNzZW50aWFsIGNsYXNzIGZvciB0aGUgaW5zdGFuY2UKIyB0aGVFeHRlcm5hbFJlZiAtIHRoZSBFeHRlcm5hbCBSZWZlcmVuY2UgSUQgZm9yIHRoaXMgaW5zdGFuY2UKIyB0aGVFeHRlcm5hbFJlcG9zaXRvcnkgLSB0aGUgRXh0ZXJuYWwgUmVwb3NpdG9yeSB0aGF0IHRoZUV4dGVybmFsUmVmIGFwcGxpZXMgdG8KIyB0aGVJbnN0YW5jZU5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgaW4gdGhlIEVzc2VudGlhbCBSZXBvc2l0b3J5CiMgdGhlTWF0Y2hTdHJpbmcgLSB0aGUgc3RyaW5nIHRoYXQgc2hvdWxkIGJlIHVzZWQgdG8gbWF0Y2ggYWdhaW5zdCBhbmQgZmluZCB0aGUgaW5zdGFuY2UgCmRlZiBnZXRFc3NlbnRpYWxJbnN0YW5jZUlnbm9yZUNhc2UodGhlQ2xhc3NOYW1lLCB0aGVFeHRlcm5hbFJlZiwgdGhlRXh0ZXJuYWxSZXBvc2l0b3J5LCB0aGVJbnN0YW5jZU5hbWUsIHRoZU1hdGNoU3RyaW5nKToKICAgIGFuSW5zdExpc3QgPSBrYi5nZXRDbHModGhlQ2xhc3NOYW1lKS5nZXREaXJlY3RJbnN0YW5jZXMoKQogICAgZm9yIGFuSW5zdCBpbiBhbkluc3RMaXN0OgogICAgICAgIGFuRXh0ZXJuYWxSZWZMaXN0ID0gYW5JbnN0LmdldERpcmVjdE93blNsb3RWYWx1ZXMoa2IuZ2V0U2xvdCgiZXh0ZXJuYWxfcmVwb3NpdG9yeV9pbnN0YW5jZV9yZWZlcmVuY2UiKSkKICAgICAgICBpZiBhbkV4dGVybmFsUmVmTGlzdCAhPSBOb25lOgogICAgICAgICAgICBhbkV4dGVybmFsUmVmID0gZ2V0RXh0ZXJuYWxSZWZJbnN0KGFuRXh0ZXJuYWxSZWZMaXN0LCBnZXRFeHRlcm5hbFJlcG9zaXRvcnkodGhlRXh0ZXJuYWxSZXBvc2l0b3J5KSkKICAgICAgICAgICAgaWYgYW5FeHRlcm5hbFJlZiAhPSBOb25lOgogICAgICAgICAgICAgICAgYW5FeHRlcm5hbElEID0gYW5FeHRlcm5hbFJlZi5nZXREaXJlY3RPd25TbG90VmFsdWUoa2IuZ2V0U2xvdCgiZXh0ZXJuYWxfaW5zdGFuY2VfcmVmZXJlbmNlIikpCiAgICAgICAgICAgICAgICBpZihhbkV4dGVybmFsSUQgPT0gdGhlRXh0ZXJuYWxSZWYpOgogICAgICAgICAgICAgICAgICAgIGFuRXh0ZXJuYWxSZWYuc2V0T3duU2xvdFZhbHVlKGtiLmdldFNsb3QoImV4dGVybmFsX3VwZGF0ZV9kYXRlIiksIHRpbWVzdGFtcCgpKQogICAgICAgICAgICAgICAgICAgIHByaW50ICJVcGRhdGVkIEluc3RhbmNlIHZpYSBFeHRlcm5hbCBSZWZlcmVuY2Ugb24gY2xhc3M6ICIgKyB0aGVDbGFzc05hbWUKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYW5JbnN0CgkJCQkJCiAgICAjIElmIHdlJ3JlIGhlcmUsIHRoaXMgZXh0ZXJuYWwgcmVmZXJlbmNlIGhhc24ndCBiZWVuIGZvdW5kLgogICAgIyBUcnkgdG8gZmluZCBieSBpbnN0YW5jZV9uYW1lIC0gaWdub3JpbmcgY2FzZSBvZiBlYWNoCiAgICBhTmFtZVNsb3QgPSBnZXROYW1lU2xvdEZvckNsYXNzKHRoZUNsYXNzTmFtZSkKICAgIGZvciBhbkluc3QgaW4gYW5JbnN0TGlzdDoKICAgICAgICBhTmFtZSA9IGFuSW5zdC5nZXREaXJlY3RPd25TbG90VmFsdWUoa2IuZ2V0U2xvdChhTmFtZVNsb3QpKQogICAgICAgIGlmIGFOYW1lICE9IE5vbmU6CiAgICAgICAgICAgIGFOYW1lID0gYU5hbWUubG93ZXIoKQogICAgICAgICAgICBhTWF0Y2hOYW1lID0gdGhlTWF0Y2hTdHJpbmcubG93ZXIoKQogICAgICAgICAgICBpZihhTmFtZSA9PSBhTWF0Y2hOYW1lKToKICAgICAgICAgICAgICAgICMgV2UgaGF2ZSBmb3VuZCBhIG1hdGNoCiAgICAgICAgICAgICAgICBhbkV4dGVybmFsUmVmID0gY3JlYXRlRXh0ZXJuYWxSZWZJbnN0KHRoZUV4dGVybmFsUmVwb3NpdG9yeSwgdGhlRXh0ZXJuYWxSZWYpCiAgICAgICAgICAgICAgICBhbkluc3QuYWRkT3duU2xvdFZhbHVlKGtiLmdldFNsb3QoImV4dGVybmFsX3JlcG9zaXRvcnlfaW5zdGFuY2VfcmVmZXJlbmNlIiksIGFuRXh0ZXJuYWxSZWYpCiAgICAgICAgICAgICAgICBwcmludCAiVXBkYXRlZCBpbnN0YW5jZSB2aWEgbmFtZSBtYXRjaCwgb24gY2xhc3M6ICIgKyB0aGVDbGFzc05hbWUKICAgICAgICAgICAgICAgIHJldHVybiBhbkluc3QKCQkJCQogICAgIyBpZiB3ZSdyZSBoZXJlLCB3ZSBoYXZlbid0IGZvdW5kIG9uZSwgc28gY3JlYXRlIG9uZQogICAgYU5ld0luc3QgPSBrYi5jcmVhdGVJbnN0YW5jZShOb25lLCBrYi5nZXRDbHModGhlQ2xhc3NOYW1lKSkKICAgIGFOZXdJbnN0LnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KGFOYW1lU2xvdCksIHRoZUluc3RhbmNlTmFtZSkJCQkKICAgIGFuRXh0ZXJuYWxSZWYgPSBjcmVhdGVFeHRlcm5hbFJlZkluc3QodGhlRXh0ZXJuYWxSZXBvc2l0b3J5LCB0aGVFeHRlcm5hbFJlZikKICAgIGFOZXdJbnN0LmFkZE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJleHRlcm5hbF9yZXBvc2l0b3J5X2luc3RhbmNlX3JlZmVyZW5jZSIpLCBhbkV4dGVybmFsUmVmKQogICAgcHJpbnQgIkNyZWF0ZWQgbmV3IGluc3RhbmNlIG9mIGNsYXNzOiAiICsgdGhlQ2xhc3NOYW1lCiAgICByZXR1cm4gYU5ld0luc3QKCQojIEZpbmQgdGhlIHJpZ2h0IG5hbWUgc2xvdCBmb3IgYSBnaXZlbiBpbnN0YW5jZS4gSWYgaXQncyBhbiBFQV9DbGFzcyBpbnN0YW5jZSwgdGhlIAojIG5hbWUgc2xvdCB3aWxsIGJlIHJldHVybmVkLiBJZiBpdCdzIGFuIEVBX1JlbGF0aW9uIGluc3RhbmNlLCB0aGUgcmVsYXRpb25fbmFtZSBzbG90CiMgaXMgcmV0dXJuZWQuIElmIGl0J3MgYW4gaW5zdGFuY2Ugb2YgOkVBX0dyYXBoX1JlbGF0aW9uLCB0aGUgOnJlbGF0aW9uX25hbWUgc2xvdCBpcwojIHJldHVybmVkCiMgdGhlSW5zdGFuY2UgdGhlIGluc3RhbmNlIGZvciB3aGljaCB0aGUgY29ycmVjdCBuYW1lIHNsb3QgaXMgcmVxdWlyZWQuCiMgcmV0dXJucyBhIHN0cmluZyBuYW1lIG9mIHRoZSBjb3JyZWN0IHNsb3QgdG8gdXNlLgpkZWYgZ2V0TmFtZVNsb3QodGhlSW5zdGFuY2UpOgoJYUNvcnJlY3ROYW1lU2xvdCA9ICJuYW1lIgoJZm9yIGFTbG90IGluIHRoZUluc3RhbmNlLmdldE93blNsb3RzKCk6CgkJaWYoYVNsb3QgPT0ga2IuZ2V0U2xvdCgibmFtZSIpKToKCQkJYUNvcnJlY3ROYW1lU2xvdCA9ICJuYW1lIgoJCWVsaWYoYVNsb3QgPT0ga2IuZ2V0U2xvdCgicmVsYXRpb25fbmFtZSIpKToKCQkJYUNvcnJlY3ROYW1lU2xvdCA9ICJyZWxhdGlvbl9uYW1lIgoJCWVsaWYoYVNsb3QgPT0ga2IuZ2V0U2xvdCgiOnJlbGF0aW9uX25hbWUiKSk6CgkJCWFDb3JyZWN0TmFtZVNsb3QgPSAiOnJlbGF0aW9uX25hbWUiCgoJcmV0dXJuIGFDb3JyZWN0TmFtZVNsb3QKCQojIEZpbmQgdGhlIHJpZ2h0IG5hbWUgc2xvdCBmb3IgYSBnaXZlbiBjbGFzcy4gSWYgaXQncyBhbiBFQV9DbGFzcywgdGhlIAojIG5hbWUgc2xvdCB3aWxsIGJlIHJldHVybmVkLiBJZiBpdCdzIGFuIEVBX1JlbGF0aW9uIGNsYXNzLCB0aGUgcmVsYXRpb25fbmFtZSBzbG90CiMgaXMgcmV0dXJuZWQuIElmIGl0J3MgYW4gY2xhc3Mgb2YgOkVBX0dyYXBoX1JlbGF0aW9uLCB0aGUgOnJlbGF0aW9uX25hbWUgc2xvdCBpcwojIHJldHVybmVkCiMgdGhlQ2xhc3NOYW1lIHRoZSBuYW1lIG9mIHRoZSBjbGFzcyBmb3Igd2hpY2ggdGhlIGNvcnJlY3QgbmFtZSBzbG90IGlzIHJlcXVpcmVkLgojIHJldHVybnMgYSBzdHJpbmcgbmFtZSBvZiB0aGUgY29ycmVjdCBzbG90IHRvIHVzZS4KZGVmIGdldE5hbWVTbG90Rm9yQ2xhc3ModGhlQ2xhc3NOYW1lKToKCWFDb3JyZWN0TmFtZVNsb3QgPSAibmFtZSIKCWZvciBhU2xvdCBpbiBrYi5nZXRDbHModGhlQ2xhc3NOYW1lKS5nZXRUZW1wbGF0ZVNsb3RzKCk6CgkJaWYoYVNsb3QgPT0ga2IuZ2V0U2xvdCgibmFtZSIpKToKCQkJYUNvcnJlY3ROYW1lU2xvdCA9ICJuYW1lIgoJCWVsaWYoYVNsb3QgPT0ga2IuZ2V0U2xvdCgicmVsYXRpb25fbmFtZSIpKToKCQkJYUNvcnJlY3ROYW1lU2xvdCA9ICJyZWxhdGlvbl9uYW1lIgoJCWVsaWYoYVNsb3QgPT0ga2IuZ2V0U2xvdCgiOnJlbGF0aW9uX25hbWUiKSk6CgkJCWFDb3JyZWN0TmFtZVNsb3QgPSAiOnJlbGF0aW9uX25hbWUiCgoJcmV0dXJuIGFDb3JyZWN0TmFtZVNsb3QKCQojCmRlZiBDcmVhdGVOZXdFc3NlbnRpYWxJbnN0YW5jZSh0aGVDbGFzc05hbWUsIHRoZUluc3RhbmNlTmFtZSk6CiAgICAiIiIgQ3JlYXRlIGEgbmV3IGluc3RhbmNlIGluIHRoZSByZXBvc2l0b3J5IHdpdGhvdXQgc2VhcmNoaW5nIGZvciBhbnkKICAgICAgICBleGlzdGluZyBpbnN0YW5jZXMgYW5kIHdpdGhvdXQgYXNzb2NpYXRpbmcgYW4gZXh0ZXJuYWwgcmVwb3NpdG9yeSAKICAgICAgICByZWZlcmVuY2UKICAgICAgICAKICAgICAgICB0aGVDbGFzc05hbWUgLSB0aGUgbmFtZSBvZiB0aGUgQ2xhc3Mgb2Ygd2hpY2ggdG8gY3JlYXRlIHRoZSBpbnN0YW5jZQogICAgICAgIHRoZUluc3RhbmNlTmFtZSAtIHRoZSB2YWx1ZSBvZiB0aGUgIm5hbWUiIHNsb3Qgb24gdGhlIG5ldyBFc3NlbnRpYWwgaW5zdGFuY2UKICAgICAgICAKICAgICAgICByZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBuZXcgaW5zdGFuY2UKICAgICAgICAKICAgICAgICAxOS4xMS4yMDEyIEpXQwogICAgIiIiCiAgICBhTmV3SW5zdCA9IENyZWF0ZU5ld0Vzc2VudGlhbEluc3RhbmNlV2l0aElEKHRoZUNsYXNzTmFtZSwgdGhlSW5zdGFuY2VOYW1lLCBOb25lKSAKICAgIHJldHVybiBhTmV3SW5zdAogICAgCiMKZGVmIENyZWF0ZU5ld0Vzc2VudGlhbEluc3RhbmNlV2l0aElEKHRoZUNsYXNzTmFtZSwgdGhlSW5zdGFuY2VOYW1lLCB0aGVJbnN0YW5jZUlEKToKICAgICIiIiBDcmVhdGUgYSBuZXcgaW5zdGFuY2UgaW4gdGhlIHJlcG9zaXRvcnkgd2l0aG91dCBzZWFyY2hpbmcgZm9yIGFueQogICAgICAgIGV4aXN0aW5nIGluc3RhbmNlcyBhbmQgd2l0aG91dCBhc3NvY2lhdGluZyBhbiBleHRlcm5hbCByZXBvc2l0b3J5IAogICAgICAgIHJlZmVyZW5jZQogICAgICAgIAogICAgICAgIHRoZUNsYXNzTmFtZSAtIHRoZSBuYW1lIG9mIHRoZSBDbGFzcyBvZiB3aGljaCB0byBjcmVhdGUgdGhlIGluc3RhbmNlCiAgICAgICAgdGhlSW5zdGFuY2VOYW1lIC0gdGhlIHZhbHVlIG9mIHRoZSAibmFtZSIgc2xvdCBvbiB0aGUgbmV3IEVzc2VudGlhbCBpbnN0YW5jZQogICAgICAgIHRoZUluc3RhbmNlSUQgLSB0aGUgaW50ZXJuYWwsIFByb3RlZ2UgSUQgdGhhdCBzaG91bGQgYmUgdXNlZCBmb3IgdGhpcyBpbnN0YW5jZQogICAgICAgIAogICAgICAgIHJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIG5ldyBpbnN0YW5jZQogICAgICAgIAogICAgICAgIDE5LjExLjIwMTIgSldDCiAgICAiIiIKICAgICMgaWYgd2UncmUgaGVyZSwgd2UgaGF2ZW4ndCBmb3VuZCBvbmUsIHNvIGNyZWF0ZSBvbmUKICAgIGFOZXdJbnN0ID0ga2IuY3JlYXRlSW5zdGFuY2UodGhlSW5zdGFuY2VJRCwga2IuZ2V0Q2xzKHRoZUNsYXNzTmFtZSkpCgkKICAgICMgSGFuZGxlIHRoZSAzIHZhcmlhbnRzIG9mIG5hbWUKICAgIGFOYW1lU2xvdCA9IGdldE5hbWVTbG90KGFOZXdJbnN0KQogICAgYU5ld0luc3Quc2V0T3duU2xvdFZhbHVlKGtiLmdldFNsb3QoYU5hbWVTbG90KSwgdGhlSW5zdGFuY2VOYW1lKQkKICAgIHByaW50ICJDcmVhdGVkIG5ldyBpbnN0YW5jZSBvZiBjbGFzczogIiArIHRoZUNsYXNzTmFtZQogICAgcmV0dXJuIGFOZXdJbnN0CgojCmRlZiBHZXRFc3NlbnRpYWxJbnN0YW5jZUJ5SUQodGhlQ2xhc3NOYW1lLCB0aGVJbnN0YW5jZU5hbWUsIHRoZUluc3RhbmNlSUQpOgogICAgIiIiIEZpbmQgdGhlIGluc3RhbmNlIGluIHRoZSByZXBvc2l0b3J5IHdpdGggdGhlIHNwZWNpZmllZCBpbnRlcm5hbCBJRAogICAgICAgIElmIG5vdCBmb3VuZCwgY3JlYXRlIG9uZSBpbiB0aGUgcmVwb3NpdG9yeSB3aXRoIHRoYXQgaW50ZXJuYWwgSUQgYW5kIHdpdGggCiAgICAgICAgdGhlIHNwZWNpZmllZCB0eXBlIGFuZCBuYW1lLgogICAgICAgIAogICAgICAgIHRoZUNsYXNzTmFtZSAtIHRoZSBuYW1lIG9mIHRoZSBDbGFzcyBvZiB3aGljaCB0byBjcmVhdGUgdGhlIGluc3RhbmNlCiAgICAgICAgdGhlSW5zdGFuY2VOYW1lIC0gdGhlIHZhbHVlIG9mIHRoZSAibmFtZSIgc2xvdCBvbiB0aGUgbmV3IEVzc2VudGlhbCBJbnN0YW5jZQogICAgICAgIHRoZUluc3RhbmNlSUQgLSB0aGUgaW50ZXJuYWwsIFByb3RlZ2UgSUQgdGhhdCBpcyBiZWluZyBzZWFyY2hlZCBmb3IgYW5kIHVzZWQKICAgICAgICBmb3IgYW55IG5ldyBpbnN0YW5jZQogICAgICAgIAogICAgICAgIHJldHVybnMgdGhlIG5ldyBpbnN0YW5jZSBpZGVudGlmaWVkIGJ5IElECiAgICAgICAgCiAgICAgICAgMTkuMTEuMjAxMiBKV0MKICAgICIiIgogICAgIyBGaW5kIGFuIGluc3RhbmNlIGluIHRoZSByZXBvc2l0b3J5IHdpdGggaW50ZXJuYWwgSUQgPSB0aGVJbnN0YW5jZUlECiAgICBhbkluc3RhbmNlID0ga2IuZ2V0SW5zdGFuY2UodGhlSW5zdGFuY2VJRCkKICAgIGlmIGFuSW5zdGFuY2UgIT0gTm9uZToKICAgICAgICBwcmludCAiRm91bmQgaW5zdGFuY2UgYnkgSUQgb24gY2xhc3M6ICIgKyB0aGVDbGFzc05hbWUKICAgICAgICAgCiAgICAjIElmIG5vdCBmb3VuZCwgY3JlYXRlIGl0CiAgICBpZiBhbkluc3RhbmNlID09IE5vbmU6CiAgICAgICAgYW5JbnN0YW5jZSA9IENyZWF0ZU5ld0Vzc2VudGlhbEluc3RhbmNlV2l0aElEKHRoZUNsYXNzTmFtZSwgdGhlSW5zdGFuY2VOYW1lLCB0aGVJbnN0YW5jZUlEKQogICAgCiAgICByZXR1cm4gYW5JbnN0YW5jZQojCgojIEludGVsbGlnZW50IEVzc2VudGlhbCBHZXQgSW5zdGFuY2UgZnVuY3Rpb24uCmRlZiBFc3NlbnRpYWxHZXRJbnN0YW5jZSh0aGVDbGFzc05hbWUsIHRoZUluc3RhbmNlSUQsIHRoZUluc3RhbmNlTmFtZSwgdGhlRXh0ZXJuYWxJRCwgdGhlRXh0ZXJuYWxSZXBvc2l0b3J5TmFtZSk6CiAgICAiIiIgR2V0IHRoZSBFc3NlbnRpYWwgaW5zdGFuY2UgZnJvbSB0aGUgY3VycmVudCByZXBvc2l0b3J5IG9mIHRoZSBzcGVjaWZpZWQgQ2xhc3MuIAogICAgICAgIEZpcnN0bHksIHRoZSByZXBvc2l0b3J5IHdpbGwgYmUgc2VhcmNoZWQgZm9yIHRoZSBzcGVjaWZpZWQgaW5zdGFuY2UgSUQgKGludGVybmFsIFByb3RlZ2UgbmFtZSkuIAogICAgICAgIElmIG5vIHN1Y2ggaW5zdGFuY2UgY2FuIGJlIGZvdW5kLCB0aGUgcmVwb3NpdG9yeSBpcyBzZWFyY2hlZCBmb3IgYW4gaW5zdGFuY2Ugd2l0aCB0aGUgc3BlY2lmaWVkIGV4dGVybmFsIAogICAgICAgIHJlcG9zaXRvcnkgaW5zdGFuY2UgcmVmZXJlbmNlLiAKICAgICAgICBJZiBubyBzdWNoIGluc3RhbmNlIGNhbiBiZSBmb3VuZCwgdGhlIHJlcG9zaXRvcnkgaXMgc2VhcmNoZWQgaXMgZm9yIGluc3RhbmNlcyBvZiB0aGUgU3BlY2lmaWVkIGNsYXNzIHRoYXQKICAgICAgICBoYXMgYSBuYW1lIHRoYXQgZXhhY3RseSAoY2FzZSBhbmQgZnVsbCBuYW1lKSBtYXRjaGVzIHRoZSBzcGVjaWZpZWQgaW5zdGFuY2UgbmFtZS4KICAgICAgICBJZiBubyBzdWNoIGluc3RhbmNlIGNhbiBiZSBmb3VuZCwgYSBuZXcgaW5zdGFuY2Ugd2l0aCB0aGUgYWJvdmUgdGhlIHBhcmFtZXRlcnMgaXMgY3JlYXRlZC4gSW4gdGhpcyBjYXNlCiAgICAgICAgUHJvdGVnZSB3aWxsIGF1dG9tYXRpY2FsbHkgYXNzaWduIGEgbmV3IGluc3RhbmNlIElELgogICAgICAgIAogICAgICAgIHRoZUNsYXNzTmFtZSAtIHRoZSBuYW1lIG9mIHRoZSBjbGFzcyBvZiB0aGUgaW5zdGFuY2UgdG8gZmluZC4gU2VhcmNoIGlzIHNjb3BlZCBieSBjbGFzcwogICAgICAgIHRoZUluc3RhbmNlSUQgLSB0aGUgaW50ZXJuYWwgUHJvdGVnZSBuYW1lIC8gSUQgZm9yIHRoZSBpbnN0YW5jZS4gU2V0IHRvICIiIHRvIGJ5cGFzcyBzZWFyY2ggYnkgaW5zdGFuY2UgSUQKICAgICAgICB0aGVJbnN0YW5jZU5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgc3BlY2lmaWVkIGluc3RhbmNlLiBXaGVuIGFuIGluc3RhbmNlIGlzIGZvdW5kIGJ5IGluc3RhbmNlIElEIG9yIEV4dGVybmFsCiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlLCB0aGlzIHBhcmFtZXRlciBjYW4gYmUgdXNlZCB0byB1cGRhdGUgdGhlIG5hbWUgKEVzc2VudGlhbCBuYW1lIHNsb3QpIG9mIHRoZSAKICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS4KICAgICAgICB0aGVFeHRlcm5hbElEIC0gdGhlIElEIHRoYXQgdGhlIGluc3RhbmNlIGhhcyBpbiB0aGUgc3BlY2lmaWVkIGV4dGVybmFsIHNvdXJjZSByZXBvc2l0b3J5CiAgICAgICAgdGhlRXh0ZXJuYWxSZXBvc2l0b3J5TmFtZSAtIHRoZSBuYW1lIG9mIHRoZSBleHRlcm5hbCBzb3VyY2UgcmVwb3NpdG9yeSAgICAgICAgIAogICAgICAgIAogICAgICAgIHJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIGNvcnJlY3QgRXNzZW50aWFsIEluc3RhbmNlIG9yIE5vbmUgaWYgYW4gYXR0ZW1wdCBpcyBtYWRlIHRvIGNyZWF0ZSBhbiBpbnN0YW5jZQogICAgICAgIG9mIGFuIHVua25vd24gY2xhc3MuCiAgICAgICAgCiAgICAgICAgMjAuMTEuMjAxMiBKV0MKICAgICIiIgogICAgYW5Fc3NlbnRpYWxJbnN0YW5jZSA9IE5vbmUKICAgIAogICAgIyAyMC4wOS4yMDExIEpXQyAtIE1ha2Ugc3VyZSB0aGF0IHRoZSBzb3VyY2UgY2xhc3MgaXMgaW4gdGhlIHRhcmdlcnQgcmVwb3NpdG9yeQogICAgYUNsYXNzID0ga2IuZ2V0Q2xzKHRoZUNsYXNzTmFtZSkgICAgCiAgICAjIGlmIG5vdC1yZXBvcnQgYSB3YXJuaW5nIGFuZCBza2lwIHRoYXQgaW5zdGFuY2UuCiAgICBpZiBhQ2xhc3MgPT0gTm9uZToKICAgICAgICBwcmludCAiV0FSTklORzogU2tpcHBpbmcgaW5zdGFuY2Ugb2YgdW5rbm93biBjbGFzczogIiArIHRoZUNsYXNzTmFtZQogICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIGlmIHRoZUluc3RhbmNlSUQgIT0gTm9uZToKICAgICAgICBhbkVzc2VudGlhbEluc3RhbmNlID0gRmluZEVzc2VudGlhbEluc3RhbmNlQnlJRCh0aGVJbnN0YW5jZUlEKSAgICAgICAgCiAgICAgICAgUHJvY2Vzc0ZvdW5kSW5zdGFuY2UoYW5Fc3NlbnRpYWxJbnN0YW5jZSwgdGhlSW5zdGFuY2VOYW1lLCB0aGVFeHRlcm5hbFJlcG9zaXRvcnlOYW1lLCB0aGVFeHRlcm5hbElEKQogICAgICAgIGlmIGFuRXNzZW50aWFsSW5zdGFuY2UgIT0gTm9uZToKICAgICAgICAgICAgcHJpbnQgIlVwZGF0ZWQgaW5zdGFuY2UgdmlhIGluc3RhbmNlIElELCBvbiBjbGFzczogIiArIHRoZUNsYXNzTmFtZQogICAgICAgICAgICAKICAgICMgSWYgbm90IGZvdW5kLCBzZWFyY2ggYnkgZXh0ZXJuYWwgcmVwb3NpdG9yeSByZWZlcmVuY2UKICAgIGlmIGFuRXNzZW50aWFsSW5zdGFuY2UgPT0gTm9uZToKICAgICAgICAjIGFuRXNzZW50aWFsSW5zdGFuY2UgPSBGaW5kRXNzZW50aWFsSW5zdGFuY2VCeUV4dGVybmFsUmVmKGFDbGFzcywgdGhlRXh0ZXJuYWxSZXBvc2l0b3J5TmFtZSwgdGhlRXh0ZXJuYWxJRCkKICAgICAgICAjIFByb2Nlc3NGb3VuZEluc3RhbmNlKGFuRXNzZW50aWFsSW5zdGFuY2UsIHRoZUluc3RhbmNlTmFtZSwgdGhlRXh0ZXJuYWxSZXBvc2l0b3J5TmFtZSwgdGhlRXh0ZXJuYWxJRCkKICAgICAgICAjIGlmIGFuRXNzZW50aWFsSW5zdGFuY2UgIT0gTm9uZToKICAgICAgICAjICAgICBwcmludCAiVXBkYXRlZCBpbnN0YW5jZSB2aWEgZXh0ZXJuYWwgcmVwb3NpdG9yeSByZWZlcmVuY2UsIG9uIGNsYXNzOiAiICsgdGhlQ2xhc3NOYW1lCiAgICAgICAgCiAgICAgICAgIyBJZiBub3QgZm91bmQsIHNlYXJjaCBieSBuYW1lCiAgICAgICAgaWYgYW5Fc3NlbnRpYWxJbnN0YW5jZSA9PSBOb25lOgogICAgICAgICAgICBhbkVzc2VudGlhbEluc3RhbmNlID0gRmluZEVzc2VudGlhbEluc3RhbmNlQnlOYW1lKGFDbGFzcywgdGhlSW5zdGFuY2VOYW1lKQogICAgICAgICAgICBVcGRhdGVPckFkZEV4dGVybmFsUmVmKGFuRXNzZW50aWFsSW5zdGFuY2UsIHRoZUV4dGVybmFsUmVwb3NpdG9yeU5hbWUsIHRoZUV4dGVybmFsSUQpCiAgICAgICAgICAgIGlmIGFuRXNzZW50aWFsSW5zdGFuY2UgIT0gTm9uZToKICAgICAgICAgICAgICAgIHByaW50ICJVcGRhdGVkIGluc3RhbmNlIHZpYSBuYW1lLCBvbiBjbGFzczogIiArIHRoZUNsYXNzTmFtZQogICAgICAgIAogICAgICAgICMgSWYgbm90IGZvdW5kLCBjcmVhdGUgYSBuZXcgaW5zdGFuY2UKICAgICAgICBpZiBhbkVzc2VudGlhbEluc3RhbmNlID09IE5vbmU6ICAgICAgICAgICAgCiAgICAgICAgICAgIGFuRXNzZW50aWFsSW5zdGFuY2UgPSBDcmVhdGVOZXdFc3NlbnRpYWxJbnN0YW5jZSh0aGVDbGFzc05hbWUsIHRoZUluc3RhbmNlTmFtZSkKICAgICAgICAgICAgQWRkRXh0ZXJuYWxSZWZlcmVuY2VJRChhbkVzc2VudGlhbEluc3RhbmNlLCB0aGVFeHRlcm5hbElELCB0aGVFeHRlcm5hbFJlcG9zaXRvcnlOYW1lKQogICAgCiAgICAjIFJldHVybiB0aGUgcmVzdWx0cyBvZiB0aGUgc2VhcmNoZXMuICAgICAgICAgICAgCiAgICByZXR1cm4gYW5Fc3NlbnRpYWxJbnN0YW5jZQojCgpkZWYgRmluZEVzc2VudGlhbEluc3RhbmNlQnlJRCh0aGVJbnN0YW5jZUlEKToKICAgICIiIiBGaW5kIHRoZSBpbnN0YW5jZSBvZiB0aGUgc3BlY2lmaWVkIGNsYXNzIHRoYXQgaGFzIHRoZSBpbnRlcm5hbCBJRCBzcGVjaWZpZWQuCiAgICAgICAgSWYgbm90IGZvdW5kIHJldHVybnMgTm9uZQogICAgICAgIAogICAgICAgIHRoZUNsYXNzIC0gdGhlIGNsYXNzIG9mIHRoZSBpbnN0YW5jZSB0byBmaW5kCiAgICAgICAgdGhlSW5zdGFuY2VJRCAtIHRoZSBpbnRlcm5hbCwgUHJvdGVnZSBuYW1lIG9mIHRoZSBpbnN0YW5jZQogICAgIAogICAgICAgIHJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIGZvdW5kIGluc3RhbmNlIG9yIE5vbmUgaWYgbm90IGZvdW5kCiAgICAgICAgCiAgICAgICAgMjAuMTEuMjAxMiBKV0MKICAgICIiIgogICAgYW5JbnN0YW5jZSA9IE5vbmUKICAgIGlmIHRoZUluc3RhbmNlSUQgIT0gTm9uZSBhbmQgbGVuKHRoZUluc3RhbmNlSUQpID4gMDoKICAgICAgICBhbkluc3RhbmNlID0ga2IuZ2V0SW5zdGFuY2UodGhlSW5zdGFuY2VJRCkKICAgICAgICAKICAgIHJldHVybiBhbkluc3RhbmNlCiMKCmRlZiBGaW5kRXNzZW50aWFsSW5zdGFuY2VCeUV4dGVybmFsUmVmKHRoZUNsYXNzLCB0aGVFeHRlcm5hbFJlcG9zaXRvcnlOYW1lLCB0aGVFeHRlcm5hbElEKToKICAgICIiIiBGaW5kIHRoZSBFc3NlbnRpYWwgaW5zdGFuY2Ugb2YgdGhlIHNwZWNpZmllZCBjbGFzcyBpbiB0aGUgcmVwb3NpdG9yeSwgdGhhdCBoYXMKICAgICAgICB0aGUgc3BlY2lmaWVkIGV4dGVybmFsIHJlZmVyZW5jZS4KICAgICAgICAKICAgICAgICB0aGVDbGFzcyAtIHRoZSBjbGFzcyBvZiB0aGUgcmVxdWlyZWQgaW5zdGFuY2UKICAgICAgICB0aGVFeHRlcm5hbFJlcG9zaXRvcnlOYW1lIC0gdGhlIGV4dGVybmFsIHJlcG9zaXRvcnkgbmFtZSB0aGF0IGNvbnRhaW5zIHRoZSBleHRlcm5hbCBJRAogICAgICAgIHRoZUV4dGVybmFsSUQgLSB0aGUgSUQgb2YgdGhlIHJlcXVpcmVkIGluc3RhbmNlIGluIHRoZSBzcGVjaWZpZWQgZXh0ZXJuYWwgc291cmNlIHJlcG9zaXRvcnkKICAgICAgICAKICAgICAgICByZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBmb3VuZCBpbnN0YW5jZSBvciBOb25lIGlmIG5vdCBmb3VuZAogICAgICAgIDIwLjExLjIwMTIgSldDCiAgICAgICAgMjYuMDIuMjAyMCBKV0MgdXBkYXRlZCB0byB1c2UgdGhlIGdldFJlZmVyZW5jZWRJbnN0YW5jZSgpIGFwcHJvYWNoIGlmIGF2YWlsYWJsZQogICAgICAgIDI3LjAyLjIwMjAgSldDIHVwZGF0ZWQgYWdhaW4gdG8gZHJvcCB0aGUgYWJvdmUgYW5kIGp1c3QgdXNlIHRoZSBzbG90LiBFdmVuIGZhc3RlcgogICAgIiIiCiAgICAjCiAgICBhbkV4dGVybmFsUmVmID0gTm9uZQogICAgYW5JbnN0YW5jZSA9IE5vbmUKICAgIGFuRXh0ZXJuYWxSZXBvcyA9IEdldEluc3RhbmNlT2ZDbGFzcygiRXh0ZXJuYWxfUmVwb3NpdG9yeSIsIHRoZUV4dGVybmFsUmVwb3NpdG9yeU5hbWUpCiAgICBhbkV4dGVybmFsUmVmZXJlbmNlSURMaXN0ID0ga2IuZ2V0RnJhbWVzV2l0aFZhbHVlKGtiLmdldFNsb3QoImV4dGVybmFsX2luc3RhbmNlX3JlZmVyZW5jZSIpLCBOb25lLCAwLCB0aGVFeHRlcm5hbElEKQogICAgaWYgYW5FeHRlcm5hbFJlZmVyZW5jZUlETGlzdC5zaXplKCkgPiAwOgogICAgICAgIGFuSW5zdGFuY2VMaXN0ID0gZmlsdGVyKGxhbWJkYSB4OiB4LmdldERpcmVjdE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJleHRlcm5hbF9yZXBvc2l0b3J5X3JlZmVyZW5jZSIpKSA9PSBhbkV4dGVybmFsUmVwb3MsIGFuRXh0ZXJuYWxSZWZlcmVuY2VJRExpc3QpCiAgICAgICAgaWYgbGVuKGFuSW5zdGFuY2VMaXN0KSA+IDA6CiAgICAgICAgICAgIGFuRXh0ZXJuYWxSZWYgPSBhbkluc3RhbmNlTGlzdFswXQogICAgICAgICAgICAKICAgICAgICAgICAgIyBHb3QgdGhlIGV4dGVybmFsIHJlZmVyZW5jZSBvYmplY3QuIE5vdyBmaW5kIGluc3RhbmNlIHRvIHdoaWNoIHRoaXMgaXMgYXNzb2NpYXRlZAogICAgICAgICAgICAjIElmIHRoZSByZWZlcmVuY2VkX2luc3RhbmNlIHNsb3QgaXMgYXZhaWxhYmxlLCB1c2UgdGhhdCB0byBmaW5kIHRoZSBpbnN0YW5jZQogICAgICAgICAgICBpZiBrYi5nZXRTbG90KCdyZWZlcmVuY2VkX2luc3RhbmNlJykgIT0gTm9uZToKICAgICAgICAgICAgICAgIGFuSW5zdGFuY2UgPSBhbkV4dGVybmFsUmVmLmdldERpcmVjdE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCdyZWZlcmVuY2VkX2luc3RhbmNlJykpCiAgICAgICAgICAgICAgICBVcGRhdGVFeHRlcm5hbFJlZmVyZW5jZUlEKGFuRXh0ZXJuYWxSZWYpCiAgICAgICAgICAgICMgZWxzZSB1c2UgdGhlIG9sZCBhcHByb2FjaAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYW5JbnN0TGlzdCA9IHRoZUNsYXNzLmdldERpcmVjdEluc3RhbmNlcygpCiAgICAgICAgICAgICAgICBhbkluc3RhbmNlU2V0ID0gZmlsdGVyKGxhbWJkYSB4OiB4LmdldERpcmVjdE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJleHRlcm5hbF9yZXBvc2l0b3J5X2luc3RhbmNlX3JlZmVyZW5jZSIpKSA9PSBhbkV4dGVybmFsUmVmLCBhbkluc3RMaXN0KQogICAgICAgICAgICAgICAgaWYgbGVuKGFuSW5zdGFuY2VTZXQpID4gMDoKICAgICAgICAgICAgICAgICAgICBhbkluc3RhbmNlID0gYW5JbnN0YW5jZVNldFswXQogICAgICAgICAgICAgICAgICAgIFVwZGF0ZUV4dGVybmFsUmVmZXJlbmNlSUQoYW5FeHRlcm5hbFJlZikKCiAgICAjICAgICAgICAgICAgICAgCiAgICByZXR1cm4gYW5JbnN0YW5jZQogICAgCiMKZGVmIEZpbmRFc3NlbnRpYWxJbnN0YW5jZUJ5TmFtZSh0aGVDbGFzcywgdGhlSW5zdGFuY2VOYW1lKToKICAgICIiIiBGaW5kIHRoZSBFc3NlbnRpYWwgaW5zdGFuY2Ugb2YgdGhlIHNwZWNpZmllZCBjbGFzcyBpbiB0aGUgcmVwb3NpdG9yeSB0aGF0IGhhcwogICAgICAgIGEgbmFtZSB0aGF0IGV4YWN0bHkgbWF0Y2hlcyB0aGUgc3BlY2lmaWVkIG5hbWUKICAgICAgICAKICAgICAgICB0aGVDbGFzcyAtIHRoZSBjbGFzcyBvZiB0aGUgcmVxdWlyZWQgaW5zdGFuY2UKICAgICAgICB0aGVJbnN0YW5jZSAtIHRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0byBmaW5kCiAgICAgICAgCiAgICAgICAgcmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGUgZm91bmQgaW5zdGFuY2Ugb3IgTm9uZSBpZiBub3QgZm91bmQKICAgICAgICAKICAgICAgICAyMC4xMS4yMDEyIEpXQwogICAgIiIiCiAgICBhbkluc3RhbmNlID0gTm9uZSAKICAgIGlmIHRoZUluc3RhbmNlTmFtZSAhPSBOb25lOgogICAgICAgIGFuSW5zdGFuY2UgPSBHZXRJbnN0YW5jZU9mQ2xhc3ModGhlQ2xhc3MuZ2V0TmFtZSgpLCB0aGVJbnN0YW5jZU5hbWUuc3RyaXAoKSkKICAgCiAgICByZXR1cm4gYW5JbnN0YW5jZQojCmRlZiBBZGRFeHRlcm5hbFJlZmVyZW5jZUlEKHRoZUluc3RhbmNlLCB0aGVFeHRlcm5hbElELCB0aGVFeHRlcm5hbFJlcG9zaXRvcnkpOgogICAgIiIiIEFkZCB0aGUgc3BlY2lmaWVkIGV4dGVybmFsIHJlcG9zaXRvcnkgaW5zdGFuY2UgcmVmZXJlbmNlIHRvIHRoZSBzcGVjaWZpZWQgaW5zdGFuY2UKICAgIAogICAgICAgIHRoZUluc3RhbmNlIC0gdGhlIFByb3RlZ2UgaW5zdGFuY2UgdG8gd2hpY2ggdGhlIGV4dGVybmFsIHJlZmVyZW5jZSBzaG91bGQgYmUgY3JlYXRlZCBhbmQgYWRkZWQKICAgICAgICB0aGVFeHRlcm5hbElEIC0gdGhlIElEIGZyb20gdGhlIGV4dGVybmFsIHJlcG9zaXRvcnkgZm9yIHRoZSBzcGVjaWZpZWQgaW5zdGFuY2UKICAgICAgICB0aGVFeHRlcm5hbFJlcG9zaXRvcnkgLSB0aGUgZXh0ZXJuYWwgcmVwb3NpdG9yeSB0byB3aGljaCB0aGUgZXh0ZXJuYWwgSUQgYmVsb25ncwogICAgICAgIAogICAgICAgIDIwLjExLjIwMTIgSldDCiAgICAiIiIKICAgIGFuRXh0ZXJuYWxSZWYgPSBjcmVhdGVFeHRlcm5hbFJlZkluc3QodGhlRXh0ZXJuYWxSZXBvc2l0b3J5LCB0aGVFeHRlcm5hbElEKQogICAgdGhlSW5zdGFuY2UuYWRkT3duU2xvdFZhbHVlKGtiLmdldFNsb3QoImV4dGVybmFsX3JlcG9zaXRvcnlfaW5zdGFuY2VfcmVmZXJlbmNlIiksIGFuRXh0ZXJuYWxSZWYpCiMKIwpkZWYgRmluZEV4dGVybmFsUmVmZXJlbmNlSUQodGhlSW5zdGFuY2UsIHRoZUV4dGVybmFsSUQsIHRoZUV4dGVybmFsUmVwb3NpdG9yeU5hbWUpOgogICAgIiIiIEZpbmQgdGhlIHNwZWNpZmllZCBleHRlcm5hbCByZWZlcmVuY2UgZm9yIHRoZSBJbnN0YW5jZSB3aXRoIHRoZSBzcGVjaWZpZWQgZXh0ZXJuYWwgSUQgb24gdGhlCiAgICAgICAgc3BlY2lmaWVkIGV4dGVybmFsIHJlcG9zaXRvcnkgb3IgcmV0dXJuIE5vbmUKICAgIAogICAgICAgIHRoZUluc3RhbmNlIC0gdGhlIGluc3RhbmNlIHRvIHdoaWNoIHRoZSBleHRlcm5hbCBJRCByZWxhdGVzCiAgICAgICAgdGhlRXh0ZXJuYWxJRCAtIHRoZSBJRCBvZiB0aGlzIGluc3RhbmNlIGluIHRoZSBleHRlcm5hbCByZXBvc2l0b3J5CiAgICAgICAgdGhlRXh0ZXJuYWxSZXBvc2l0b3J5TmFtZSAtIHRoZSBleHRlcm5hbCBzb3VyY2UgcmVwb3NpdG9yeSBmcm9tIHdoaWNoIHRoZSBpbnN0YW5jZSBpcyBiZWluZyBpbXBvcnRlZAogICAgCiAgICAgICAgcmV0dXJucyBhIHJlZmVyZW5jZSB0aGUgZXh0ZXJuYWwgcmVwb3NpdG9yeSBvYmplY3Qgb3IgTm9uZSBpZiBub3QgZm91bmQuCiAgICAgICAgCiAgICAgICAgMjEuMTEuMjAxMiBKV0MKICAgICIiIgogICAgYW5FeHRlcm5hbFJlZiA9IE5vbmUKICAgIGFuRXh0ZXJuYWxSZXBvcyA9IGdldEV4dGVybmFsUmVwb3NpdG9yeSh0aGVFeHRlcm5hbFJlcG9zaXRvcnlOYW1lKQogICAgCiAgICBhbkV4dGVybmFsUmVmTGlzdCA9IHRoZUluc3RhbmNlLmdldERpcmVjdE93blNsb3RWYWx1ZXMoa2IuZ2V0U2xvdCgiZXh0ZXJuYWxfcmVwb3NpdG9yeV9pbnN0YW5jZV9yZWZlcmVuY2UiKSkKICAgIGFSZWYgPSBmaWx0ZXIobGFtYmRhIHg6IHguZ2V0RGlyZWN0T3duU2xvdFZhbHVlKGtiLmdldFNsb3QoImV4dGVybmFsX3JlcG9zaXRvcnlfcmVmZXJlbmNlIikpID09IGFuRXh0ZXJuYWxSZXBvcywgYW5FeHRlcm5hbFJlZkxpc3QpCiAgICBpZiBsZW4oYVJlZikgPiAwOgogICAgICAgIGFuRXh0ZXJuYWxSZWYgPSBhUmVmWzBdCiAgICAKICAgIHJldHVybiBhbkV4dGVybmFsUmVmCiAgICAgICAgICAgIAojCmRlZiBVcGRhdGVFeHRlcm5hbFJlZmVyZW5jZUlEKHRoZUV4dGVybmFsUmVwb3NpdG9yeVJlZik6CiAgICAiIiIgVXBkYXRlIHRoZSB0aW1lc3RhbXAgb24gdGhlIHNwZWNpZmllZCBleHRlcm5hbCByZXBvc2l0b3J5IHJlZmVyZW5jZQogICAgCiAgICAgICAgdGhlRXh0ZXJuYWxSZXBvc2l0b3J5UmVmIC0gdGhlIGV4dGVybmFsIHJlcG9zaXRvcnkgcmVmZXJlbmNlIHRvIHVwZGF0ZS4KICAgICAgICAKICAgICAgICAyMS4xMS4yMDEyIEpXQwogICAgIiIiCiAgICB0aGVFeHRlcm5hbFJlcG9zaXRvcnlSZWYuc2V0T3duU2xvdFZhbHVlKGtiLmdldFNsb3QoImV4dGVybmFsX3VwZGF0ZV9kYXRlIiksIHRpbWVzdGFtcCgpKQogICAgCiMKZGVmIFVwZGF0ZUVzc2VudGlhbEluc3RhbmNlTmFtZSh0aGVJbnN0YW5jZSwgdGhlSW5zdGFuY2VOYW1lKToKICAgICIiIiBVcGRhdGUgdGhlIG5hbWUgb2YgdGhlIHNwZWNpZmllZCBpbnN0YW5jZSB0byB1c2UgdGhlIG5ldyBuYW1lIHNwZWNpZmllZAogICAgICAgIGJ1dCBvbmx5IGlmIHRoZSBuYW1lcyBkbyBub3QgbWF0Y2gKICAgICAgICAKICAgICAgICB0aGVJbnN0YW5jZSAtIHRoZSBpbnN0YW5jZSB0byBiZSB1cGRhdGVkCiAgICAgICAgdGhlSW5zdGFuY2VOYW1lIC0gdGhlIG5ldyBuYW1lIHRvIHVzZQogICAgICAgIAogICAgICAgIDIxLjExLjIwMTIgSldDCiAgICAiIiIKICAgIGlmIHRoZUluc3RhbmNlICE9IE5vbmU6CiAgICAgICAgaWYgKHRoZUluc3RhbmNlTmFtZSAhPSBOb25lKSBhbmQgKGxlbih0aGVJbnN0YW5jZU5hbWUpID4gMCk6CiAgICAgICAgICAgIHRoZUluc3RhbmNlLnNldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJuYW1lIiksIHRoZUluc3RhbmNlTmFtZSkKIwoKZGVmIFVwZGF0ZU9yQWRkRXh0ZXJuYWxSZWYodGhlSW5zdGFuY2UsIHRoZUV4dGVybmFsUmVwb3NpdG9yeU5hbWUsIHRoZUV4dGVybmFsSUQpOgogICAgIiIiIEZpbmQgdGhlIGNvcnJlY3QgRXh0ZXJuYWwgcmVmZXJlbmNlIGZvciB0aGUgc3BlY2lmaWVkIGluc3RhbmNlIGluIHRoZSBzcGVjaWZpZWQKICAgICAgICByZXBvc2l0b3J5IHdpdGggdGhlIHNwZWNpZmllZCBJRCBhbmQgdXBkYXRlIGl0LiBJZiBubyBzdWNoIGV4dGVybmFsIGluc3RhbmNlIHJlZmVyZW5jZQogICAgICAgIGV4aXN0cywgY3JlYXRlIGl0CiAgICAgICAgCiAgICAgICAgdGhlSW5zdGFuY2UgLSB0aGUgaW5zdGFuY2UgZm9yIHdoaWNoIHRoZSBleHRlcm5hbCByZWZlcmVuY2Ugc2hvdWxkIGJlIHVwZGF0ZWQgb3IgYWRkZWQKICAgICAgICB0aGVFeHRlcm5hbFJlcG9zaXRvcnlOYW1lIC0gdGhlIG5hbWUgb2YgdGhlIGV4dGVybmFsIHJlcG9zaXRvcnkKICAgICAgICB0aGVFeHRlcm5hbElEIC0gdGhlIGV4dGVybmFsIElEIGluIHRoZSBleHRlcm5hbCByZXBvc2l0b3J5IGZvciB0aGUgaW5zdGFuY2UKICAgICAgICAKICAgICAgICAyMS4xMS4yMDEyIEpXQwogICAgIiIiCiAgICBpZiB0aGVJbnN0YW5jZSAhPSBOb25lOgogICAgICAgIGFuRXh0ZXJuYWxSZXBvc1JlZiA9IEZpbmRFeHRlcm5hbFJlZmVyZW5jZUlEKHRoZUluc3RhbmNlLCB0aGVFeHRlcm5hbElELCB0aGVFeHRlcm5hbFJlcG9zaXRvcnlOYW1lKQogICAgICAgIGlmIGFuRXh0ZXJuYWxSZXBvc1JlZiAhPSBOb25lOiAgICAgICAgICAgIAogICAgICAgICAgICBVcGRhdGVFeHRlcm5hbFJlZmVyZW5jZUlEKGFuRXh0ZXJuYWxSZXBvc1JlZikKICAgICAgICBlbHNlOgogICAgICAgICAgICBBZGRFeHRlcm5hbFJlZmVyZW5jZUlEKHRoZUluc3RhbmNlLCB0aGVFeHRlcm5hbElELCB0aGVFeHRlcm5hbFJlcG9zaXRvcnlOYW1lKQojCgpkZWYgUHJvY2Vzc0ZvdW5kSW5zdGFuY2UodGhlSW5zdGFuY2UsIHRoZUluc3RhbmNlTmFtZSwgdGhlRXh0ZXJuYWxSZXBvc2l0b3J5TmFtZSwgdGhlRXh0ZXJuYWxJRCk6CiAgICAiIiIgUHJvY2VzcyBhbiBFc3NlbnRpYWwgaW5zdGFuY2UgdGhhdCBoYXMgYmVlbiBmb3VuZCBieSB1cGRhdGluZyB0aGUgcmVsZXZhbnQgZXh0ZXJuYWwgcmVwb3NpdG9yeSBpbnN0YW5jZQogICAgICAgIHJlZmVyZW5jZS4gSWYgdGhlSW5zdGFuY2VOYW1lIGNvbnRhaW5zIGEgbm9uLWVtcHR5IHZhbHVlLCBjaGFuZ2UgdGhlIEVzc2VudGlhbCBuYW1lIHNsb3QgdmFsdWUKICAgICAgICBmb3IgdGhlSW5zdGFuY2UKICAgICAgICAKICAgICAgICB0aGVJbnN0YW5jZSAtIHRoZSBFc3NlbnRpYWwgaW5zdGFuY2UgdG8gcHJvY2VzcwogICAgICAgIHRoZUluc3RhbmNlTmFtZSAtIHRoZSBuZXcvdXBkYXRlZCBuYW1lIGZvciB0aGUgaW5zdGFuY2UuIFNldHMgdGhlIEVzc2VudGlhbCBNZXRhIE1vZGVsIG5hbWUgc2xvdAogICAgICAgIHRoZUV4dGVybmFsUmVwb3NpdG9yeU5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgZXh0ZXJuYWwgc291cmNlIHJlcG9zaXRvcnkKICAgICAgICB0aGVFeHRlcm5hbElEIC0gdGhlIElEIHRoYXQgdGhlIHNwZWNpZmllZCBpbnN0YW5jZSBoYXMgaW4gdGhlIGV4dGVybmFsIHNvdXJjZSByZXBvc2l0b3J5CiAgICAgICAgCiAgICAgICAgMjEuMTEuMjAxMiBKV0MgICAgICAgCiAgICAiIiIKICAgIGlmIHRoZUluc3RhbmNlICE9IE5vbmU6CiAgICAgICAgIyBVcGRhdGUgdGhlIGV4dGVybmFsIHJlZmVyZW5jZSBpbnN0YW5jZSBmb3IgdGhlIGluc3RhbmNlCiAgICAgICAgVXBkYXRlT3JBZGRFeHRlcm5hbFJlZih0aGVJbnN0YW5jZSwgdGhlRXh0ZXJuYWxSZXBvc2l0b3J5TmFtZSwgdGhlRXh0ZXJuYWxJRCkKICAgICAgICAKICAgICAgICAjIElmIHRoZUluc3RhbmNlTmFtZSBpcyBwb3B1bGF0ZWQgKG5vdCBOb25lIG9yICIiKSBjaGFuZ2UgdGhlIG5hbWUgb2YgdGhlSW5zdGFuY2UKICAgICAgICBpZiAodGhlSW5zdGFuY2VOYW1lICE9IE5vbmUpIGFuZCAobGVuKHRoZUluc3RhbmNlTmFtZSkgPiAwKToKICAgICAgICAgICAgVXBkYXRlRXNzZW50aWFsSW5zdGFuY2VOYW1lKHRoZUluc3RhbmNlLCB0aGVJbnN0YW5jZU5hbWUpCiMKIyBHZXQgYW4gZXhpc3Rpbmcgb3IgbmV3IEFjdG9yIFRvIFJvbGUgcmVsYXRpb24gZm9yIHRoZSBzcGVjaWZpZWQgQWN0b3IgYW5kIFJvbGUKZGVmIEdldEFjdG9yVG9Sb2xlKHRoZUFjdG9yLCB0aGVSb2xlLCB0aGVFeHRSZXBvcyk6CiAgICAiIiIgR2V0IGFuIGV4aXN0aW5nIG9yIG5ldyBBY3RvciBUbyBSb2xlIHJlbGF0aW9uIGZvciB0aGUgc3BlY2lmaWVkIEFjdG9yIGFuZCBSb2xlCiAgICAKICAgICAgICB0aGVBY3RvciAtIHRoZSBBY3RvciBpbnN0YW5jZSB0byBhZGQgdG8gdGhlIHJvbGUKICAgICAgICB0aGVSb2xlIC0gdGhlIFJvbGUgdGhhdCB0aGUgQWN0b3IgaXMgdG8gcGxheQogICAgICAgIHRoZUV4dFJlcG9zIC0gdGhlIG5hbWUgb2YgdGhlIEV4dGVybmFsIHJlcG9zaXRvcnkgZnJvbSB3aGljaCB0aGUgYWN0b3JzIGFuZCByb2xlcyBhcmUgYmVpbmcKICAgICAgICAgICAgICAgICAgICAgIGltcG9ydGVkLgogICAgCiAgICAgICAgcmV0dXJucyB0aGUgcmVsZXZhbnQgQWN0b3JUb1JvbGUgcmVsYXRpb24gb3IgTm9uZSBpZiBBY3RvciBvciBSb2xlIGlzIGludmFsaWQKICAgICIiIgogICAgYW5BY3RUb1JvbGUgPSBOb25lCiAgICBpZiAodGhlQWN0b3IgIT0gTm9uZSkgYW5kICh0aGVSb2xlICE9IE5vbmUpOgogICAgICAgIGFuQWN0b3JOYW1lID0gdGhlQWN0b3IuZ2V0T3duU2xvdFZhbHVlKGtiLmdldFNsb3QoIm5hbWUiKSkKICAgICAgICBhUm9sZU5hbWUgPSB0aGVSb2xlLmdldE93blNsb3RWYWx1ZShrYi5nZXRTbG90KCJuYW1lIikpCiAgICAgICAgYW5BY3RUb1JvbGVOYW1lID0gYW5BY3Rvck5hbWUgKyAiIGFzICIgKyBhUm9sZU5hbWUKICAgICAgICBhbkFjdFRvUm9sZSA9IEVzc2VudGlhbEdldEluc3RhbmNlKCJBQ1RPUl9UT19ST0xFX1JFTEFUSU9OIiwgIiIsIGFuQWN0VG9Sb2xlTmFtZSwgYW5BY3RUb1JvbGVOYW1lLCB0aGVFeHRSZXBvcykKICAgICAgICBhZGRJZk5vdFRoZXJlKGFuQWN0VG9Sb2xlLCAiYWN0X3RvX3JvbGVfZnJvbV9hY3RvciIsIHRoZUFjdG9yKSAgICAgICAgCiAgICAgICAgYWRkSWZOb3RUaGVyZShhbkFjdFRvUm9sZSwgImFjdF90b19yb2xlX3RvX3JvbGUiLCB0aGVSb2xlKQogICAgICAgICAgICAKICAgIHJldHVybiBhbkFjdFRvUm9sZQojCgojIEZ1bmN0aW9ucyB0byBhZGQgQ2xhc3MgaW5zdGFuY2VzIGFuZCBTbG90IGluc3RhbmNlcyB0byBTbG90cyBvbiBhbiBpbnN0YW5jZQpkZWYgYWRkQ2xhc3NUb1Nsb3QodGhlSW5zdGFuY2UsIHRoZVNsb3ROYW1lLCB0aGVDbGFzc05hbWUpOgogICAgIiIiIEFkZCBhIENsYXNzIGluc3RhbmNlIHRvIGEgU2xvdCBvbiB0aGUgc3BlY2lmaWVkIGluc3RhbmNlLCB3aGVyZSB0aGUgU2xvdCB0YWtlcyBhIENsYXNzIHR5cGUuCiAgICAKICAgICAgICB0aGVJbnN0YW5jZSAtIHRoZSBpbnN0YW5jZSBvbiB3aGljaCB0byBzZXQgdGhlIHNsb3QKICAgICAgICB0aGVTbG90TmFtZSAtIHRoZSBzbG90IHRvIHdoaWNoIHRoZSBDbGFzcyBzaG91bGQgYmUgYWRkZWQKICAgICAgICB0aGVDbGFzc05hbWUgLSB0aGUgbmFtZSBvZiB0aGUgQ2xhc3MgaW5zdGFuY2UgdG8gYWRkIHRvIHRoZSBzbG90CiAgICAiIiIKICAgIGlmIHRoZUluc3RhbmNlID09IE5vbmU6CiAgICAgICAgcmV0dXJuCiAgICAKICAgIGFDbHMgPSBrYi5nZXRDbHModGhlQ2xhc3NOYW1lKQogICAgYWRkSWZOb3RUaGVyZSh0aGVJbnN0YW5jZSwgdGhlU2xvdE5hbWUsIGFDbHMpCiAgICAKZGVmIGFkZFNsb3RUb1Nsb3QodGhlSW5zdGFuY2UsIHRoZVNsb3ROYW1lLCB0aGVTbG90SW5zdGFuY2VOYW1lKToKICAgICIiIiBBZGQgYSBTbG90IGluc3RhbmNlIHRvIGEgU2xvdCBvbiB0aGUgc3BlY2lmaWVkLCB3aGVyZSB0aGUgU2xvdCB0YWtlcyBhIFNsb3QgdHlwZQogICAgCiAgICAgICAgdGhlSW5zdGFuY2UgLSB0aGUgaW5zdGFuY2Ugb24gd2hpY2ggdG8gc2V0IHRoZSBzbG90CiAgICAgICAgdGhlU2xvdE5hbWUgLSB0aGUgc2xvdCB0byB3aGljaCB0aGUgQ2xhc3Mgc2hvdWxkIGJlIGFkZGVkCiAgICAgICAgdGhlU2xvdEluc3RhbmNlTmFtZSAtIHRoZSBuYW1lIG9mIHRoZSBTbG90IGluc3RhbmNlIHRvIGFkZCB0byB0aGUgc2xvdAogICAgIiIiCiAgICBpZiB0aGVJbnN0YW5jZSA9PSBOb25lOgogICAgICAgIHJldHVybgogICAgICAgIAogICAgYVNsb3QgPSBrYi5nZXRTbG90KHRoZVNsb3RJbnN0YW5jZU5hbWUpCiAgICBhZGRJZk5vdFRoZXJlKHRoZUluc3RhbmNlLCB0aGVTbG90TmFtZSwgYVNsb3QpCgoKIyBGaW5kIHRoZSBzcGVjaWZpZWQgaW5zdGFuY2UgaW4gdGhlIHNwZWNpZmllZCBzbG90IG9mIHRoZVJlbGF0ZWRJbnN0bmFjZSBhbmQgcmVtb3ZlIGlmIHRoZXJlLgpkZWYgZmluZEFuZFJlbW92ZUluc3RhbmNlRnJvbVNsb3QodGhlSW5zdGFuY2VUb1JlbW92ZSwgdGhlUmVsYXRlZEluc3RhbmNlLCB0aGVTbG90KToKICAgIGlmICh0aGVSZWxhdGVkSW5zdGFuY2UgIT0gTm9uZSkgYW5kICh0aGVTbG90ICE9IE5vbmUpOgogICAgICAgIGFuSW5zdExpc3QgPSB0aGVSZWxhdGVkSW5zdGFuY2UuZ2V0T3duU2xvdFZhbHVlcyh0aGVTbG90KQogICAgICAgIGlmIGFuSW5zdExpc3QgIT0gTm9uZToKICAgICAgICAgICAgaWYgYW5JbnN0TGlzdC5jb250YWlucyh0aGVJbnN0YW5jZVRvUmVtb3ZlKToKICAgICAgICAgICAgICAgIHRoZVJlbGF0ZWRJbnN0YW5jZS5yZW1vdmVPd25TbG90VmFsdWUodGhlU2xvdCwgdGhlSW5zdGFuY2VUb1JlbW92ZSkKICAgICAgICAgICAgICAgIAojIFJlbW92ZSBzcGVjaWZpZWQgaW5zdGFuY2UgZnJvbSBhbGwgYXJjaGl0ZWN0dXJlIHN0YXRlcwpkZWYgcmVtb3ZlSW5zdGFuY2VGcm9tU3RhdGVzKHRoZUluc3RhbmNlKToKICAgICMgRG8gdGhpcyBmcm9tIHRoZSBzdGF0ZSBlbmQgb2YgdGhpbmdzIC0gYSBiaXQgYnJ1dGUgZm9yY2UgYnV0IHByb2JhYmx5IHNhZmVyCiAgICBhU3RhdGVMaXN0ID0ga2IuZ2V0Q2xzKCJBcmNoaXRlY3R1cmVfU3RhdGUiKS5nZXREaXJlY3RJbnN0YW5jZXMoKQogICAgZm9yIGFTdGF0ZSBpbiBhU3RhdGVMaXN0OgogICAgICAgICMgTG9vayBmb3IgdGhlIGluc3RhbmNlIGluIGVhY2ggc3RhdGUgc2xvdCBhbmQgcmVtb3ZlIGlmIGl0J3MgdGhlcmUgICAgICAgIAogICAgICAgIGZpbmRBbmRSZW1vdmVJbnN0YW5jZUZyb21TbG90KHRoZUluc3RhbmNlLCBhU3RhdGUsIGtiLmdldFNsb3QoImFyY2hfc3RhdGVfYXBwbGljYXRpb25fY29uY2VwdHVhbCIpKQogICAgICAgIGZpbmRBbmRSZW1vdmVJbnN0YW5jZUZyb21TbG90KHRoZUluc3RhbmNlLCBhU3RhdGUsIGtiLmdldFNsb3QoImFyY2hfc3RhdGVfYXBwbGljYXRpb25fbG9naWNhbCIpKQogICAgICAgIGZpbmRBbmRSZW1vdmVJbnN0YW5jZUZyb21TbG90KHRoZUluc3RhbmNlLCBhU3RhdGUsIGtiLmdldFNsb3QoImFyY2hfc3RhdGVfYXBwbGljYXRpb25fcGh5c2ljYWwiKSkKICAgICAgICBmaW5kQW5kUmVtb3ZlSW5zdGFuY2VGcm9tU2xvdCh0aGVJbnN0YW5jZSwgYVN0YXRlLCBrYi5nZXRTbG90KCJhcmNoX3N0YXRlX2FwcGxpY2F0aW9uX3JlbGF0aW9ucyIpKQogICAgICAgIGZpbmRBbmRSZW1vdmVJbnN0YW5jZUZyb21TbG90KHRoZUluc3RhbmNlLCBhU3RhdGUsIGtiLmdldFNsb3QoImFyY2hfc3RhdGVfYnVzaW5lc3NfY29uY2VwdHVhbCIpKQogICAgICAgIGZpbmRBbmRSZW1vdmVJbnN0YW5jZUZyb21TbG90KHRoZUluc3RhbmNlLCBhU3RhdGUsIGtiLmdldFNsb3QoImFyY2hfc3RhdGVfYnVzaW5lc3NfbG9naWNhbCIpKQogICAgICAgIGZpbmRBbmRSZW1vdmVJbnN0YW5jZUZyb21TbG90KHRoZUluc3RhbmNlLCBhU3RhdGUsIGtiLmdldFNsb3QoImFyY2hfc3RhdGVfYnVzaW5lc3NfcGh5c2ljYWwiKSkKICAgICAgICBmaW5kQW5kUmVtb3ZlSW5zdGFuY2VGcm9tU2xvdCh0aGVJbnN0YW5jZSwgYVN0YXRlLCBrYi5nZXRTbG90KCJhcmNoX3N0YXRlX2J1c2luZXNzX3JlbGF0aW9ucyIpKQogICAgICAgIGZpbmRBbmRSZW1vdmVJbnN0YW5jZUZyb21TbG90KHRoZUluc3RhbmNlLCBhU3RhdGUsIGtiLmdldFNsb3QoImFyY2hfc3RhdGVfaW5mb3JtYXRpb25fY29uY2VwdHVhbCIpKQogICAgICAgIGZpbmRBbmRSZW1vdmVJbnN0YW5jZUZyb21TbG90KHRoZUluc3RhbmNlLCBhU3RhdGUsIGtiLmdldFNsb3QoImFyY2hfc3RhdGVfaW5mb3JtYXRpb25fbG9naWNhbCIpKQogICAgICAgIGZpbmRBbmRSZW1vdmVJbnN0YW5jZUZyb21TbG90KHRoZUluc3RhbmNlLCBhU3RhdGUsIGtiLmdldFNsb3QoImFyY2hfc3RhdGVfcGh5c2ljYWxfaW5mb3JtYXRpb24iKSkKICAgICAgICBmaW5kQW5kUmVtb3ZlSW5zdGFuY2VGcm9tU2xvdCh0aGVJbnN0YW5jZSwgYVN0YXRlLCBrYi5nZXRTbG90KCJhcmNoX3N0YXRlX3NlY3VyaXR5X21hbmFnZW1lbnQiKSkKICAgICAgICBmaW5kQW5kUmVtb3ZlSW5zdGFuY2VGcm9tU2xvdCh0aGVJbnN0YW5jZSwgYVN0YXRlLCBrYi5nZXRTbG90KCJhcmNoX3N0YXRlX3RlY2hub2xvZ3lfY29uY2VwdHVhbCIpKQogICAgICAgIGZpbmRBbmRSZW1vdmVJbnN0YW5jZUZyb21TbG90KHRoZUluc3RhbmNlLCBhU3RhdGUsIGtiLmdldFNsb3QoImFyY2hfc3RhdGVfdGVjaG5vbG9neV9sb2dpY2FsIikpCiAgICAgICAgZmluZEFuZFJlbW92ZUluc3RhbmNlRnJvbVNsb3QodGhlSW5zdGFuY2UsIGFTdGF0ZSwga2IuZ2V0U2xvdCgiYXJjaF9zdGF0ZV90ZWNobm9sb2d5X3BoeXNpY2FsIikpCiAgICAgICAgZmluZEFuZFJlbW92ZUluc3RhbmNlRnJvbVNsb3QodGhlSW5zdGFuY2UsIGFTdGF0ZSwga2IuZ2V0U2xvdCgiYXJjaF9zdGF0ZV90ZWNobm9sb2d5X3JlbGF0aW9ucyIpKSAgICAgICAgCgogICAgICAgIAoKZGVmIGRlbGV0ZUluc3RhbmNlKHRoZUluc3RhbmNlKToKICAgICIiIiBEZWxldGUgdGhlIHNwZWNpZmllZCBpbnN0YW5jZSBmcm9tIHRoZSBLQgogICAgCiAgICAgICAgdGhlSW5zdGFuY2UgLSB0aGUgaW5zdGFuY2UgdG8gZGVsZXRlCiAgICAiIiIKICAgIGlmIHRoZUluc3RhbmNlICE9IE5vbmU6CiAgICAgICAgIyBSZW1vdmUgZnJvbSBUYXhvbm9taWVzCiAgICAgICAgYVNsb3QgPSBrYi5nZXRTbG90KCJlbGVtZW50X2NsYXNzaWZpZWRfYnkiKQogICAgICAgIGFDbGFzc2lmaWVkTGlzdCA9IHRoZUluc3RhbmNlLmdldE93blNsb3RWYWx1ZXMoYVNsb3QpCiAgICAgICAgZm9yIGFUYXggaW4gYUNsYXNzaWZpZWRMaXN0OgogICAgICAgICAgICB0aGVJbnN0YW5jZS5yZW1vdmVPd25TbG90VmFsdWUoYVNsb3QsIGFUYXgpCiAgICAgICAgICAgIAogICAgICAgICMgUmVtb3ZlIGZyb20gQXJjaGl0ZWN0dXJlIFN0YXRlcwogICAgICAgIHJlbW92ZUluc3RhbmNlRnJvbVN0YXRlcyh0aGVJbnN0YW5jZSkKICAgICAgICAKICAgICAgICAjIFJlbW92ZSBhbnkgYXNzb2NpYXRlZCBleHRlcm5hbCByZWZlcmVuY2VzCiAgICAgICAgYVJlZlNsb3QgPSBrYi5nZXRTbG90KCJleHRlcm5hbF9yZXBvc2l0b3J5X2luc3RhbmNlX3JlZmVyZW5jZSIpCiAgICAgICAgYVJlZkxpc3QgPSB0aGVJbnN0YW5jZS5nZXRPd25TbG90VmFsdWVzKGFSZWZTbG90KQogICAgICAgIGZvciBhUmVmIGluIGFSZWZMaXN0OgogICAgICAgICAgICB0aGVJbnN0YW5jZS5yZW1vdmVPd25TbG90VmFsdWUoYVJlZlNsb3QsIGFSZWYpCiAgICAgICAgICAgIGtiLmRlbGV0ZUluc3RhbmNlKGFSZWYpCiAgICAgICAgICAgIAogICAgICAgIGtiLmRlbGV0ZUluc3RhbmNlKHRoZUluc3RhbmNlKQoKZGVmIHJlbW92ZUluc3RhbmNlRnJvbVNsb3QodGhlSW5zdGFuY2UsIHRoZVNsb3ROYW1lLCB0aGVJbnN0YW5jZVRvUmVtb3ZlKToKICAgICIiIiBSZW1vdmUgdGhlIHNwZWNpZmllZCBpbnN0YW5jZSBmcm9tIHRoZSBzbG90IG9uIHRoZUluc3RhbmNlCiAgICAKICAgICAgICB0aGVJbnN0YW5jZSAtIHRoZSBpbnN0YW5jZSB0byB1cGRhdGUsIG9uIHdoaWNoIHRoZUluc3RhbmNlVG9SZW1vdmUgc2hvdWxkIGJlIHJlbW92ZWQgZnJvbSB0aGVTbG90CiAgICAgICAgdGhlU2xvdE5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgU2xvdCBmcm9tIHdoaWNoIHRoZUluc3RhbmNlVG9SZW1vdmUgc2hvdWxkIGJlIHJlbW92ZWQKICAgICAgICB0aGVJbnN0YW5jZVRvUmVtb3ZlIC0gdGhlIGluc3RhbmNlIHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQgZnJvbSB0aGVTbG90TmFtZSwgYnJlYWtpbmcgYSByZWxhdGlvbnNoaXAKICAgICAgICAKICAgICIiIgogICAgYVNsb3QgPSBrYi5nZXRTbG90KHRoZVNsb3ROYW1lKQogICAgaWYoYVNsb3QgIT0gTm9uZSk6CiAgICAgICAgZmluZEFuZFJlbW92ZUluc3RhbmNlRnJvbVNsb3QodGhlSW5zdGFuY2VUb1JlbW92ZSwgdGhlSW5zdGFuY2UsIGFTbG90KQogICAgCmRlZiBjbGVhclByaW1pdGl2ZVNsb3RWYWx1ZSh0aGVJbnN0YW5jZSwgdGhlU2xvdE5hbWUpOgogICAgIiIiIENsZWFyIHRoZSB2YWx1ZSBvZiB0aGUgc3BlY2lmaWVkIHByaW1pdGl2ZSBTbG90LCBpLmUuIGEgU3RyaW5nLCBJbnRlZ2VyLCBGbG9hdCwgQm9vbGVhbiwgU3ltYm9sIHNsb3QKICAgIAogICAgICAgIHRoZUluc3RhbmNlIC0gdGhlIGluc3RhbmNlIG9uIHdoaWNoIHRvIGNsZWFyIHRoZSBzcGVjaWZpZWQgc2xvdAogICAgICAgIHRoZVNsb3ROYW1lIC0gdGhlIG5hbWUgb2YgdGhlIHNsb3QgdG8gY2xlYXIKICAgICIiIgogICAgCiAgICBpZiAodGhlSW5zdGFuY2UgIT0gTm9uZSk6CiAgICAgICAgYVNsb3QgPSBrYi5nZXRTbG90KHRoZVNsb3ROYW1lKQogICAgICAgIAogICAgICAgIGlmIHRoZUluc3RhbmNlLmdldE93blNsb3RWYWx1ZVR5cGUoYVNsb3QpID09IFZhbHVlVHlwZS5GTE9BVDoKICAgICAgICAgICAgdGhlSW5zdGFuY2Uuc2V0T3duU2xvdFZhbHVlKGFTbG90LCBOb25lKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGFDdXJyZW50T2JqZWN0ID0gdGhlSW5zdGFuY2UuZ2V0RGlyZWN0T3duU2xvdFZhbHVlKGFTbG90KQogICAgICAgICAgICBpZihhQ3VycmVudE9iamVjdCAhPSBOb25lKToKICAgICAgICAgICAgICAgIHRoZUluc3RhbmNlLnJlbW92ZU93blNsb3RWYWx1ZShhU2xvdCwgYUN1cnJlbnRPYmplY3QpCgoKZGVmIGRlbGV0ZUluc3RhbmNlSWZFbXB0eVNsb3RzKHRoZUluc3RhbmNlLCB0aGVTbG90TGlzdCk6CiAgICAiIiIKICAgICAgICBEZWxldGUgdGhlIHNwZWNpZmllZCBpbnN0YW5jZSBidXQgb25seSBpZiB0aGVyZSBhcmUgbm8gdmFsdWVzIGluIHRoZSBzbG90cwogICAgICAgIGRlZmluZWQgaW4gdGhlU2xvdExpc3QKICAgICAgICAKICAgICAgICB0aGVJbnN0YW5jZSAtIHRoZSBpbnN0YW5jZSB0byBkZWxldGUKICAgICAgICB0aGVTbG90TGlzdCAtIGEgbGlzdCBvZiBzbG90IG5hbWVzIHRvIGNoZWNrIGZvciBlbXB0eSB2YWx1ZXMKICAgICAgICAKICAgICIiIgogICAgaXNWYWx1ZUluU2xvdCA9IEZhbHNlCiAgICAKICAgIGlmKHRoZUluc3RhbmNlICE9IE5vbmUpOgogICAgICAgIGlmKHRoZVNsb3RMaXN0ICE9IE5vbmUpOgogICAgCiAgICAgICAgICAgIGZvciBhU2xvdCBpbiB0aGVTbG90TGlzdDoKICAgICAgICAgICAgICAgIGlmIChhU2xvdCAhPSBOb25lKSBhbmQgKGxlbihhU2xvdCkgPiAgMCk6CiAgICAgICAgICAgICAgICAgICAgYVZhbHVlID0gdGhlSW5zdGFuY2UuZ2V0RGlyZWN0T3duU2xvdFZhbHVlKGtiLmdldFNsb3QoYVNsb3QpKSAgICAKICAgICAgICAgICAgICAgICAgICBpZihhVmFsdWUgIT0gTm9uZSk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlzVmFsdWVJblNsb3QgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgCiAgICAgICAgaWYobm90KGlzVmFsdWVJblNsb3QpKToKICAgICAgICAgICAgZGVsZXRlSW5zdGFuY2UodGhlSW5zdGFuY2UpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAoKZGVmIEVzc2VudGlhbERlbGV0ZUluc3RhbmNlKHRoZUNsYXNzTmFtZSwgdGhlSW5zdGFuY2VJRCwgdGhlSW5zdGFuY2VOYW1lLCB0aGVFeHRlcm5hbElELCB0aGVFeHRlcm5hbFJlcG9zaXRvcnlOYW1lLCB0aGVTbG90TGlzdD1Ob25lKToKICAgICIiIiBHZXQgYW5kIHRoZW4gZGVsZXRlIHRoZSBFc3NlbnRpYWwgaW5zdGFuY2UgZnJvbSB0aGUgY3VycmVudCByZXBvc2l0b3J5IG9mIHRoZSBzcGVjaWZpZWQgQ2xhc3MuIAogICAgICAgIEZpcnN0bHksIHRoZSByZXBvc2l0b3J5IHdpbGwgYmUgc2VhcmNoZWQgZm9yIHRoZSBzcGVjaWZpZWQgaW5zdGFuY2UgSUQgKGludGVybmFsIFByb3RlZ2UgbmFtZSkuIAogICAgICAgIElmIG5vIHN1Y2ggaW5zdGFuY2UgY2FuIGJlIGZvdW5kLCB0aGUgcmVwb3NpdG9yeSBpcyBzZWFyY2hlZCBmb3IgYW4gaW5zdGFuY2Ugd2l0aCB0aGUgc3BlY2lmaWVkIGV4dGVybmFsIAogICAgICAgIHJlcG9zaXRvcnkgaW5zdGFuY2UgcmVmZXJlbmNlLiAKICAgICAgICBJZiBubyBzdWNoIGluc3RhbmNlIGNhbiBiZSBmb3VuZCwgdGhlIHJlcG9zaXRvcnkgaXMgc2VhcmNoZWQgaXMgZm9yIGluc3RhbmNlcyBvZiB0aGUgU3BlY2lmaWVkIGNsYXNzIHRoYXQKICAgICAgICBoYXMgYSBuYW1lIHRoYXQgZXhhY3RseSAoY2FzZSBhbmQgZnVsbCBuYW1lKSBtYXRjaGVzIHRoZSBzcGVjaWZpZWQgaW5zdGFuY2UgbmFtZS4KICAgICAgICBJZiBubyBzdWNoIGluc3RhbmNlIGNhbiBiZSBmb3VuZCwgbm8gYWN0aW9uIHdpbGwgYmUgdGFrZW4uCiAgICAgICAgCiAgICAgICAgdGhlQ2xhc3NOYW1lIC0gdGhlIG5hbWUgb2YgdGhlIGNsYXNzIG9mIHRoZSBpbnN0YW5jZSB0byBmaW5kLiBTZWFyY2ggaXMgc2NvcGVkIGJ5IGNsYXNzCiAgICAgICAgdGhlSW5zdGFuY2VJRCAtIHRoZSBpbnRlcm5hbCBQcm90ZWdlIG5hbWUgLyBJRCBmb3IgdGhlIGluc3RhbmNlLiBTZXQgdG8gIiIgdG8gYnlwYXNzIHNlYXJjaCBieSBpbnN0YW5jZSBJRAogICAgICAgIHRoZUluc3RhbmNlTmFtZSAtIHRoZSBuYW1lIG9mIHRoZSBzcGVjaWZpZWQgaW5zdGFuY2UuIFdoZW4gYW4gaW5zdGFuY2UgaXMgZm91bmQgYnkgaW5zdGFuY2UgSUQgb3IgRXh0ZXJuYWwKICAgICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2UsIHRoaXMgcGFyYW1ldGVyIGNhbiBiZSB1c2VkIHRvIHVwZGF0ZSB0aGUgbmFtZSAoRXNzZW50aWFsIG5hbWUgc2xvdCkgb2YgdGhlIAogICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLgogICAgICAgIHRoZUV4dGVybmFsSUQgLSB0aGUgSUQgdGhhdCB0aGUgaW5zdGFuY2UgaGFzIGluIHRoZSBzcGVjaWZpZWQgZXh0ZXJuYWwgc291cmNlIHJlcG9zaXRvcnkKICAgICAgICB0aGVFeHRlcm5hbFJlcG9zaXRvcnlOYW1lIC0gdGhlIG5hbWUgb2YgdGhlIGV4dGVybmFsIHNvdXJjZSByZXBvc2l0b3J5CiAgICAgICAgdGhlU2xvdExpc3QgLSBhIGxpc3Qgb2YgbmFtZXMgdGhhdCBkZWZpbmVzIGEgc2V0IHNsb3RzIHRoYXQgbXVzdCBiZSB0ZXN0ZWQgZm9yIGFueSB2YWx1ZXMgb24gdGhlIGluc3RhbmNlCiAgICAgICAgICAgICAgICAgICAgICAgIElmIGFueSB2YWx1ZXMgYXJlIGZvdW5kIGluIGFueSBvZiB0aGUgc2xvdHMgaW4gdGhlIGxpc3Qgb24gdGhlIGluc3RhbmNlLCB0aGUgaW5zdGFuY2Ugd2lsbCBOT1QgCiAgICAgICAgICAgICAgICAgICAgICAgIGJlIGRlbGV0ZWQuIEVtcHR5IG9yIE5vbmUgbGlzdCByZXN1bHRzIGluIGRlbGV0ZSBvZiBpbnN0YW5jZSB3aGV0aGVyIGl0IGhhcyB2YWx1ZXMgb3Igbm90IGluIGl0cyBTbG90cyAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAwOS4wNS4yMDE0IEpXQwogICAgICAgIDE2LjA1LjIwMTQgSldDIEFkZGVkIHRoZVNsb3RMaXN0CiAgICAiIiIKICAgIGFuRXNzZW50aWFsSW5zdGFuY2UgPSBOb25lCiAgICAKICAgICMgMjAuMDkuMjAxMSBKV0MgLSBNYWtlIHN1cmUgdGhhdCB0aGUgc291cmNlIGNsYXNzIGlzIGluIHRoZSB0YXJnZXJ0IHJlcG9zaXRvcnkKICAgIGFDbGFzcyA9IGtiLmdldENscyh0aGVDbGFzc05hbWUpICAgIAogICAgIyBpZiBub3QtcmVwb3J0IGEgd2FybmluZyBhbmQgc2tpcCB0aGF0IGluc3RhbmNlLgogICAgaWYgYUNsYXNzID09IE5vbmU6CiAgICAgICAgcHJpbnQgIldBUk5JTkc6IFNraXBwaW5nIGluc3RhbmNlIG9mIHVua25vd24gY2xhc3M6ICIgKyB0aGVDbGFzc05hbWUKICAgICAgICByZXR1cm4KICAgIAogICAgaWYgdGhlSW5zdGFuY2VJRCAhPSBOb25lOgogICAgICAgIGFuRXNzZW50aWFsSW5zdGFuY2UgPSBGaW5kRXNzZW50aWFsSW5zdGFuY2VCeUlEKHRoZUluc3RhbmNlSUQpICAgICAgICAKICAgICAgICBpZiBhbkVzc2VudGlhbEluc3RhbmNlICE9IE5vbmU6CiAgICAgICAgICAgIGRlbGV0ZUluc3RhbmNlSWZFbXB0eVNsb3RzKGFuRXNzZW50aWFsSW5zdGFuY2UsIHRoZVNsb3RMaXN0KQogICAgICAgICAgICBwcmludCAiRGVsZXRlZCBpbnN0YW5jZSB2aWEgaW5zdGFuY2UgSUQsIG9uIGNsYXNzOiAiICsgdGhlQ2xhc3NOYW1lCiAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICMgSWYgbm90IGZvdW5kLCBzZWFyY2ggYnkgZXh0ZXJuYWwgcmVwb3NpdG9yeSByZWZlcmVuY2UKICAgIGlmIGFuRXNzZW50aWFsSW5zdGFuY2UgPT0gTm9uZToKICAgICAgICBhbkVzc2VudGlhbEluc3RhbmNlID0gRmluZEVzc2VudGlhbEluc3RhbmNlQnlFeHRlcm5hbFJlZihhQ2xhc3MsIHRoZUV4dGVybmFsUmVwb3NpdG9yeU5hbWUsIHRoZUV4dGVybmFsSUQpCiAgICAgICAgaWYgYW5Fc3NlbnRpYWxJbnN0YW5jZSAhPSBOb25lOgogICAgICAgICAgICBkZWxldGVJbnN0YW5jZUlmRW1wdHlTbG90cyhhbkVzc2VudGlhbEluc3RhbmNlLCB0aGVTbG90TGlzdCkKICAgICAgICAgICAgcHJpbnQgIkRlbGV0ZSBpbnN0YW5jZSB2aWEgZXh0ZXJuYWwgcmVwb3NpdG9yeSByZWZlcmVuY2UsIG9uIGNsYXNzOiAiICsgdGhlQ2xhc3NOYW1lCiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgICMgSWYgbm90IGZvdW5kLCBzZWFyY2ggYnkgbmFtZQogICAgICAgIGlmIGFuRXNzZW50aWFsSW5zdGFuY2UgPT0gTm9uZToKICAgICAgICAgICAgYW5Fc3NlbnRpYWxJbnN0YW5jZSA9IEZpbmRFc3NlbnRpYWxJbnN0YW5jZUJ5TmFtZShhQ2xhc3MsIHRoZUluc3RhbmNlTmFtZSkgICAgICAgICAgICAKICAgICAgICAgICAgaWYgYW5Fc3NlbnRpYWxJbnN0YW5jZSAhPSBOb25lOgogICAgICAgICAgICAgICAgZGVsZXRlSW5zdGFuY2VJZkVtcHR5U2xvdHMoYW5Fc3NlbnRpYWxJbnN0YW5jZSwgdGhlU2xvdExpc3QpCiAgICAgICAgICAgICAgICBwcmludCAiRGVsZXRlZCBpbnN0YW5jZSB2aWEgbmFtZSwgb24gY2xhc3M6ICIgKyB0aGVDbGFzc05hbWUKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgICMgSWYgbm90IGZvdW5kLCBjcmVhdGUgYSBuZXcgaW5zdGFuY2UKICAgICAgICBpZiBhbkVzc2VudGlhbEluc3RhbmNlID09IE5vbmU6ICAgICAgICAgICAgCiAgICAgICAgICAgIHByaW50ICJEZWxldGUgaW5zdGFuY2UgZmFpbGVkOiBVbmFibGUgdG8gZmluZCBzcGVjaWZpZWQgaW5zdGFuY2Ugb2YgY2xhc3M6ICIgKyB0aGVDbGFzc05hbWUKICAgIAogICAgcmV0dXJuCgojIFJlbW92ZSBhbmQgRGVsZXRlIGFuIGluc3RhbmNlIGZyb20gYSBzbG90CmRlZiBkZWxldGVJbnN0YW5jZUZyb21TbG90KHRoZUluc3RhbmNlLCB0aGVTbG90TmFtZSwgdGhlSW5zdGFuY2VUb0RlbGV0ZSk6CiAgICAiIiIKICAgICAgICBSZW1vdmUgYW5kIGRlbGV0ZSB0aGUgc3BlY2lmaWVkIGluc3RhbmNlIGZyb20gdGhlIG5hbWVkIHNsb3Qgb24gYSBzZWxlY3RlZCBpbnN0YW5jZQogICAgICAgIAogICAgICAgIHRoZUluc3RhbmNlIC0gdGhlIGluc3RhbmNlIGZyb20gd2hpY2ggdGhlIHNwZWNpZmllZCBpbnN0YW5jZSBpcyB0byBiZSBkZWxldGVkCiAgICAgICAgdGhlU2xvdE5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgc2xvdCBvbiB0aGVJbnN0YW5jZSBmcm9tIHdoaWNoIHRoZUluc3RhbmNlVG9EZWxldGUgaXMgdG8gYmUgZGVsZXRlZAogICAgICAgIHRoZUluc3RhbmNlVG9EZWxldGUgLSB0aGUgaW5zdGFuY2UgdGhhdCBpcyB0byBiZSBkZWxldGVkCiAgICAgICAgCiAgICAiIiIKICAgICMgQ2hlY2sgdGhhdCB0aGVJbnN0YW5jZVRvRGVsZXRlIGlzIHRoZXJlIGluIHRoZSBzcGVjaWZpZWQgc2xvdCAKICAgIHRoZVNsb3QgPSBrYi5nZXRTbG90KHRoZVNsb3ROYW1lKQogICAKICAgIGlmICh0aGVJbnN0YW5jZSAhPSBOb25lKSBhbmQgKHRoZVNsb3QgIT0gTm9uZSk6CiAgICAgICAgYW5JbnN0TGlzdCA9IHRoZUluc3RhbmNlLmdldE93blNsb3RWYWx1ZXModGhlU2xvdCkKICAgICAgICBpZiBhbkluc3RMaXN0ICE9IE5vbmU6CiAgICAgICAgICAgIGlmIGFuSW5zdExpc3QuY29udGFpbnModGhlSW5zdGFuY2VUb0RlbGV0ZSk6CiAgICAgICAgICAgICAgICBkZWxldGVJbnN0YW5jZSh0aGVJbnN0YW5jZVRvRGVsZXRlKQogICAgICAgICAgICAgICAgcHJpbnQgIkRlbGV0ZWQgaW5zdGFuY2UgZnJvbSBzbG90OiAiICsgdGhlU2xvdE5hbWUKCiMgUmVtb3ZlIGFsbCBvZiB0aGUgdmFsdWVzIGZyb20gYSBzbG90IG9uIGFuIGluc3RuYWNlCmRlZiByZW1vdmVBbGxWYWx1ZXNGcm9tU2xvdCh0aGVJbnN0YW5jZSwgdGhlU2xvdE5hbWUpOgogICAgIiIiCiAgICAgICAgUmVtb3ZlIGFsbCB0aGUgdmFsdWVzIGZyb20gdGhlIHNsb3QgZGVmaW5lZCBieSB0aGVTbG90TmFtZSBvbiB0aGUgc3BlY2lmaWVkIGluc3RhbmNlLgogICAgICAgIFNsb3QgdmFsdWVzIGNhbiBiZSBwcmltaXRpdmVzIG9yIGluc3RhbmNlcwogICAgICAgIAogICAgICAgIHRoZUluc3RhbmNlIC0gdGhlIGluc3RhbmNlIGZyb20gd2hpY2ggdG8gY2xlYXIgdGhlIHNwZWNpZmllZCBzbG90CiAgICAgICAgdGhlU2xvdE5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgc2xvdCBmcm9tIHdoaWNoIHRvIGNsZWFyIGFsbCB0aGUgdmFsdWVzCiAgICAiIiIKICAgIGFTbG90ID0ga2IuZ2V0U2xvdCh0aGVTbG90TmFtZSkKICAgIGlmICh0aGVJbnN0YW5jZSAhPSBOb25lKSBhbmQgKGFTbG90ICE9IE5vbmUpOgogICAgICAgIGFTbG90VHlwZSA9IHRoZUluc3RhbmNlLmdldE93blNsb3RWYWx1ZVR5cGUoYVNsb3QpCiAgICAgICAgaWYgYVNsb3RUeXBlID09IFZhbHVlVHlwZS5JTlNUQU5DRToKICAgICAgICAgICAgYVZhbHVlTGlzdCA9IHRoZUluc3RhbmNlLmdldE93blNsb3RWYWx1ZXMoYVNsb3QpCiAgICAgICAgICAgIGlmIGFWYWx1ZUxpc3QgIT0gTm9uZToKICAgICAgICAgICAgICAgIGZvciBhVmFsIGluIGFWYWx1ZUxpc3Q6CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlSW5zdGFuY2VGcm9tU2xvdCh0aGVJbnN0YW5jZSwgdGhlU2xvdE5hbWUsIGFWYWwpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY2xlYXJQcmltaXRpdmVTbG90VmFsdWUodGhlSW5zdGFuY2UsIHRoZVNsb3ROYW1lKQoKCiMgRGVsZXRlIGFsbCBvZiB0aGUgdmFsdWVzIGZyb20gYSBzbG90IG9uIGFuIGluc3RhbmNlCmRlZiBkZWxldGVBbGxWYWx1ZXNGcm9tU2xvdCh0aGVJbnN0YW5jZSwgdGhlU2xvdE5hbWUpOgogICAgIiIiIAogICAgICAgIFJlbW92ZSBhbmQgZGVsZXRlIGFsbCB0aGUgdmFsdWVzIGZyb20gdGhlIHNsb3QgZGVmaW5lZCBieSB0aGVTbG90TmFtZSBvbiB0aGUgc3BlY2lmaWVkIGluc3RhbmNlLgogICAgICAgIFNsb3QgdmFsdWVzIGNhbiBiZSBwcmltaXRpdmVzIC0gaW4gd2hpY2ggY2FzZSB0aGUgdmFsdWVzIGFyZSBjbGVhcmVkIC0gb3IgaW5zdGFuY2VzIHRoYXQgYXJlIHRoZW4gZGVsZXRlZAogICAgICAgIAogICAgICAgIHRoZUluc3RhbmNlIC0gdGhlIGluc3RhbmNlIGZyb20gd2hpY2ggdG8gY2xlYXIgdGhlIHNwZWNpZmllZCBzbG90CiAgICAgICAgdGhlU2xvdE5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgc2xvdCBmcm9tIHdoaWNoIHRvIGRlbGV0ZSBhbGwgb2YgdGhlIHZhbHVlcwogICAgIiIiCiAgICBhU2xvdCA9IGtiLmdldFNsb3QodGhlU2xvdE5hbWUpCiAgICBpZiAodGhlSW5zdGFuY2UgIT0gTm9uZSkgYW5kIChhU2xvdCAhPSBOb25lKToKICAgICAgICBhU2xvdFR5cGUgPSB0aGVJbnN0YW5jZS5nZXRPd25TbG90VmFsdWVUeXBlKGFTbG90KQogICAgICAgIGlmIGFTbG90VHlwZSA9PSBWYWx1ZVR5cGUuSU5TVEFOQ0U6ICAgICAgICAKICAgICAgICAgICAgYVZhbHVlTGlzdCA9IHRoZUluc3RhbmNlLmdldE93blNsb3RWYWx1ZXMoYVNsb3QpCiAgICAgICAgICAgIGlmIGFWYWx1ZUxpc3QgIT0gTm9uZToKICAgICAgICAgICAgICAgIGZvciBhVmFsIGluIGFWYWx1ZUxpc3Q6ICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBkZWxldGVJbnN0YW5jZUZyb21TbG90KHRoZUluc3RhbmNlLCB0aGVTbG90TmFtZSwgYVZhbCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBjbGVhclByaW1pdGl2ZVNsb3RWYWx1ZSh0aGVJbnN0YW5jZSwgdGhlU2xvdE5hbWUpCgojIEdldE5hbWVTbG90KCkKZGVmIEdldE5hbWVTbG90KHRoZUNsYXNzTmFtZSk6CiAgICAiIiIgR2V0IHRoZSBzbG90IHRoYXQgdGhlIG5hbWVkIGNsYXNzIHVzZXMgZm9yIHRoZSBuYW1lLgogICAgICAgIGZvciA6TUVUQS1DTEFTUyB0aGluZ3MgdGhpcyBpcyA6TkFNRQogICAgICAgIGZvciBFQV9DbGFzcyB0aGlzIGlzIG5hbWUKICAgICAgICBmb3IgRUFfUmVsYXRpb24gdGhpcyBpcyByZWxhdGlvbl9uYW1lCiAgICAgICAgZm9yIDpFQV9HcmFwaF9SZWxhdGlvbiB0aGlzIGlzIDpyZWxhdGlvbl9uYW1lCiAgICAKICAgICAgICB0aGVDbGFzc05hbWU6IHRoZSBuYW1lIG9mIHRoZSBjbGFzcyB0byBnZXQgdGhlIG5hbWUgc2xvdCBmb3IKICAgICAgICByZXR1cm5zIHRoZSBTbG90IG9iamVjdCBmb3IgdGhlIGNvcnJlY3QgbmFtZSBzbG90CiAgICAiIiIKICAgIGFDbGFzcyA9IGtiLmdldENscyh0aGVDbGFzc05hbWUpCiAgICBhTmFtZVNsb3QgPSBrYi5nZXRTbG90KCJuYW1lIikKICAgIGlmIGFDbGFzcyAhPSBOb25lOgogICAgICAgIGlmIGFDbGFzcy5oYXNTdXBlcmNsYXNzKGtiLmdldENscygiRUFfUmVsYXRpb24iKSk6CiAgICAgICAgICAgIGFOYW1lU2xvdCA9IGtiLmdldFNsb3QoInJlbGF0aW9uX25hbWUiKQogICAgICAgIGVsaWYgYUNsYXNzLmhhc1N1cGVyY2xhc3Moa2IuZ2V0Q2xzKCI6RUFfR3JhcGhfUmVsYXRpb24iKSk6CiAgICAgICAgICAgIGFOYW1lU2xvdCA9IGtiLmdldFNsb3QoIjpyZWxhdGlvbl9uYW1lIikKICAgICAgICBlbGlmIGFDbGFzcy5oYXNTdXBlcmNsYXNzKGtiLmdldENscygiOk1FVEEtQ0xBU1MiKSk6CiAgICAgICAgICAgIGFOYW1lU2xvdCA9IGtiLmdldFNsb3QoIjpOQU1FIikKCiAgICByZXR1cm4gYU5hbWVTbG90CgojIGdldEluc3RhbmNlQnlOYW1lKHRoZUNsYXNzTmFtZSwgdGhlSW5zdGFuY2VOYW1lKQpkZWYgZ2V0SW5zdGFuY2VCeU5hbWUodGhlQ2xhc3NOYW1lLCB0aGVJbnN0YW5jZU5hbWUpOgogICAgIiIiCiAgICAgICAgTG9vayBmb3IgYW4gaW5zdGFuY2Ugb2YgdGhlQ2xhc3NOYW1lIHdpdGggbmFtZSBzbG90ID0gdGhlSW5zdGFuY2VOYW1lLgogICAgICAgIElmIGZvdW5kLCByZXR1cm4gdGhhdCBpbnN0YW5jZSwgb3RoZXJ3aXNlIGNyZWF0ZSBpdC4KICAgICAgICAKICAgICAgICB0aGVDbGFzc05hbWUgLSB0aGUgbmFtZSBvZiB0aGUgQ2xhc3Mgb2Ygd2hpY2ggd2UgYXJlIHNlYXJjaGluZyBmb3IgYW4gaW5zdGFuY2UKICAgICAgICB0aGVJbnN0YW5jZU5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgSW5zdGFuY2UgdGhhdCB3ZSBhcmUgc2VhcmNoaW5nIGZvci4KICAgICIiIiAgICAKICAgIGFuSW5zdCA9IEdldEluc3RhbmNlT2ZDbGFzcyh0aGVDbGFzc05hbWUsIHRoZUluc3RhbmNlTmFtZSkKICAgIGlmIGFuSW5zdCAhPSBOb25lOgogICAgICAgIHJldHVybiBhbkluc3QKICAgICAgICAKICAgICMgb3RoZXJ3aXNlLCBhbiBpbnN0YW5jZSBvZiB0aGUgY2xhc3Mgd2l0aCBuYW1lPXRoZUluc3RhbmNlTmFtZSBoYXMgbm90IGJlZW4gZm91bmQKICAgICMgSGFuZGxlIGF0dGVtcHRzIHRvIGNyZWF0ZSBpbnN0YW5jZXMgb2YgOlNUQU5EQVJELUNMQVNTIG9yIDpTVEFOREFSRC1TTE9UCiAgICBhQ2xhc3MgPSBrYi5nZXRDbHModGhlQ2xhc3NOYW1lKQogICAgaWYgYUNsYXNzID09IE5vbmU6CiAgICAgICAgcmV0dXJuIE5vbmUKICAgIGlmIGFDbGFzcy5oYXNTdXBlcmNsYXNzKGtiLmdldENscygiOk1FVEEtQ0xBU1MiKSk6CiAgICAgICAgcHJpbnQgIioqKiBZb3VyIG1ldGEgbW9kZWwgaXMgaW5jb21wYXRpYmxlIHdpdGggdGhpcyBzY3JpcHQuIEF0dGVtcHQgdG8gY3JlYXRlIGluc3RhbmNlIG9mIENsYXNzIG9yIFNsb3QgdGhhdCBpcyBub3QgaW4geW91ciB0YXJnZXQgcmVwb3NpdG9yeS4iCiAgICAgICAgcHJpbnQgIi0tLS0tLSBNZXRhIENsYXNzOiAiICsgdGhlQ2xhc3NOYW1lICsgIiBJbnN0YW5jZTogIiArIHRoZUluc3RhbmNlTmFtZSAKICAgICAgICBpZih0aGVDbGFzc05hbWUgPT0gIjpTVEFOREFSRC1DTEFTUyIpOgogICAgICAgICAgICBhTmV3SW5zdCA9IEdldEluc3RhbmNlQnlOYW1lKHRoZUNsYXNzTmFtZSwgIkVBX0NsYXNzIikKICAgICAgICAgICAgcmV0dXJuIGFOZXdJbnN0CiAgICAgICAgZWxpZih0aGVDbGFzc05hbWUgPT0gIjpTVEFOREFSRC1TTE9UIik6CiAgICAgICAgICAgIGFOZXdJbnN0ID0gR2V0SW5zdGFuY2VCeU5hbWUodGhlQ2xhc3NOYW1lLCAibmFtZSIpCiAgICAgICAgICAgIHJldHVybiBhTmV3SW5zdAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBOb25lCgkgICAgIyBGaW5pc2hlZCBoYW5kbGluZyBpbnN0YW5jZXMgb2YgY2xhc3NlcyBhbmQgc2xvdHMKICAgIGFOZXdJbnN0ID0ga2IuY3JlYXRlSW5zdGFuY2UoTm9uZSwga2IuZ2V0Q2xzKHRoZUNsYXNzTmFtZSkpCiAgICBhTmV3SW5zdC5zZXREaXJlY3RPd25TbG90VmFsdWUoYU5hbWVTbG90LCB0aGVJbnN0YW5jZU5hbWUpCiAgICByZXR1cm4gYU5ld0luc3QKCiMgR2V0SW5zdGFuY2VPZkNsYXNzKHRoZUNsYXNzTmFtZSwgdGhlSW5zdGFuY2VOYW1lKQpkZWYgR2V0SW5zdGFuY2VPZkNsYXNzKHRoZUNsYXNzTmFtZSwgdGhlSW5zdGFuY2VOYW1lKToKICAgICIiIgogICAgICAgIE5ld2VzdCBpbXBsZW1lbnRhdGlvbiBvZiBpbnN0YW5jZSBmaW5kaW5nIGZ1bmN0aW9uLiBEZXNpZ25lZCB0byBwZXJmb3JtCiAgICAgICAgYmV0dGVyIGVuIG1hc3NlLCB1c2luZyB0aGUgSmF2YSBBUEkgYW5kIFB5dGhvbiBmaWx0ZXIoKSBmdW5jdGlvbi4KICAgICAgICBGaW5kIHRoZSBpbnN0YW5jZSBvZiB0aGUgc3BlY2lmaWVkIGNsYXNzIHRoYXQgaGFzIGl0J3MgbmFtZSA9IHRoZUluc3RhbmNlTmFtZQogICAgICAgIElmIGZvdW5kLCByZXR1cm4gdGhhdCBJbnN0YW5jZSwgb3RoZXJ3aXNlIHJldHVybiBOb25lCiAgICAgICAgCiAgICAgICAgdGhlQ2xhc3NOYW1lIC0gdGhlIG5hbWUgb2YgdGhlIENsYXNzIG9mIHdoaWNoIHdlIGFyZSBzZWFyY2hpbmcgZm9yIGFuIGluc3RhbmNlCiAgICAgICAgdGhlSW5zdGFuY2VOYW1lIC0gdGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRoYXQgd2UgYXJlIHNlYXJjaGluZyBmb3IKICAgICIiIiAgICAKICAgIGFuSW5zdGFuY2UgPSBOb25lCiAgICBhTmFtZVNsb3QgPSBHZXROYW1lU2xvdCh0aGVDbGFzc05hbWUpCiAgICBhbkluc3RhbmNlTGlzdCA9IGtiLmdldEZyYW1lc1dpdGhWYWx1ZShhTmFtZVNsb3QsIE5vbmUsIDAsIHRoZUluc3RhbmNlTmFtZSkKICAgIGlmIGFuSW5zdGFuY2VMaXN0LnNpemUoKSA+IDA6CiAgICAgICAgYW5JbnN0YW5jZXNPZkNsYXNzID0gZmlsdGVyKGxhbWJkYSB4OiB4Lmhhc0RpcmVjdFR5cGUoa2IuZ2V0Q2xzKHRoZUNsYXNzTmFtZSkpLCBhbkluc3RhbmNlTGlzdCkKICAgICAgICBpZiBsZW4oYW5JbnN0YW5jZXNPZkNsYXNzKSA+IDA6CiAgICAgICAgICAgIGFuSW5zdGFuY2UgPSBhbkluc3RhbmNlc09mQ2xhc3NbMF0KICAgIHJldHVybiBhbkluc3RhbmNlCiMK</script>
  <script type="application/xml" id="update-info-xml"><?xml version="1.0" encoding="UTF-8"?>
<updatepack xmlns="http://www.enterprise-architecture.org/essential/updatepack"
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 xsi:schemaLocation="http://www.enterprise-architecture.org/essential/updatepack updatepack.xsd">
    
    <!-- Describe the update pack -->
    <updatename>Data Import</updatename>
    <updatedescription></updatedescription>
    
    <!-- Define any standard functions packs -->
    <pack name="Common Functions" sequence="0">
        <description>Pack of instance update functions</description>
        <filename>standardFunctions.py</filename>
    </pack>
    
    <!-- The script generated by the Import Utility -->
    <pack name="Data Import" sequence="1">
        <description></description>
        <filename>dup_import_script.py</filename>
        <chunktoken>###-CHUNK-###</chunktoken>
    </pack>

    
</updatepack>
</script>
  <script type="application/xml" id="updatepack-xsd-xml"><?xml version="1.0" encoding="UTF-8"?>
<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns="http://www.enterprise-architecture.org/essential/updatepack"
    targetNamespace="http://www.enterprise-architecture.org/essential/updatepack"           
    elementFormDefault="qualified">
    
    <!-- 
        * Copyright (c)2012 Enterprise Architecture Solutions ltd.
        * This file is part of Essential Architecture Manager, 
        * the Essential Architecture Meta Model and The Essential Project.
        *
        * Essential Architecture Manager is free software: you can redistribute it and/or modify
        * it under the terms of the GNU General Public License as published by
        * the Free Software Foundation, either version 3 of the License, or
        * (at your option) any later version.
        *
        * Essential Architecture Manager is distributed in the hope that it will be useful,
        * but WITHOUT ANY WARRANTY; without even the implied warranty of
        * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        * GNU General Public License for more details.
        *
        * You should have received a copy of the GNU General Public License
        * along with Essential Architecture Manager.  If not, see <http://www.gnu.org/licenses/>.
        * 
        Schema for the update pack definition document that is used as the specification for the Essential Update Tab 
    -->
    <!-- 04.04.2012    JWC    1st coding-->
    <xs:element name="updatepack">
        <xs:complexType>
            <xs:sequence>
            	<xs:element name="updatename" type="xs:string" minOccurs="1" maxOccurs="1"></xs:element>
                <xs:element name="updatedescription" type="xs:string" minOccurs="1" maxOccurs="1"></xs:element>
                <xs:element name="pack" type="packdefinition" minOccurs="1" maxOccurs="unbounded"></xs:element>
            </xs:sequence>
        </xs:complexType>
    </xs:element>
    
    <xs:complexType name="packdefinition">
        <xs:complexContent>
            <xs:extension base="packdetails">
                <xs:attribute name="name" type="xs:string" use="required"></xs:attribute>
                <xs:attribute name="sequence" type="xs:int" use="required"></xs:attribute>
            </xs:extension>
        </xs:complexContent>    
    </xs:complexType>
    
    <xs:complexType name="packdetails">        
        <xs:sequence>    
            <xs:element minOccurs="0" maxOccurs="1" type="xs:string" name="description"></xs:element>
            <xs:element minOccurs="1" maxOccurs="1" type="xs:string" name="filename"></xs:element>
            <xs:element minOccurs="0" maxOccurs="1" type="xs:string" name="chunktoken"></xs:element>
        </xs:sequence>
    </xs:complexType>
</xs:schema>
</script>
  <script type="application/x-python" id="dup-import-script-header"># -*- coding: UTF-8 -*-
# Copyright (c)2009-2018 Enterprise Architecture Solutions Ltd - Essential Architecture Manager Import Script #
# generated by Essential Excel Import Manager: Fri Jun 12 10:56:58 UTC 2020 #
 
from java.lang import Boolean
from java.lang import Integer
from java.lang import Float
from java.lang import Double
 
# Define the external repository instance #
externalRepository = "Value Stream Editor"
defineExternalRepository(externalRepository, "")
</script>

  <script>(function () {
  const VSE = (window.VSE = window.VSE || {});
  VSE.state = { box1: [], box2: [], box3: [], box4: [], box5: [], box6: [], sum1: [], sum2: [], sum3: [], sum4: [], sum5: [], sum6: [] };
  VSE.labels = { box1:'Suppliers', box2:'Locations', box3:'Value Stream', box4:'Org', box5:'Info', box6:'Applications', sum1:'Initiators', sum2:'Initiation Events', sum3:'Initiation Conditions', sum4:'Outcome Conditions', sum5:'Outcomes', sum6:'Impacted Business Services' };
  VSE.vsRows = ['Value Stages','Participants','Supporting Business Capabilities','Supporting Business Processes','Target Emotions','Entrance Events','Entrance Conditions','Exit Events','Exit Conditions','KPIs'];
  VSE.flowDescription = '';
  VSE.PROCESS_ROW_INDEX = VSE.vsRows.indexOf('Supporting Business Processes');
  VSE.KPI_ROW_INDEX = VSE.vsRows.indexOf('KPIs');
  VSE.vsStages = []; VSE.vsStageMeta = []; VSE.processesMap = {}; VSE.supplierApps = {}; VSE.clientAdvertLinks = {};
  VSE.$ = (sel, root=document) => root.querySelector(sel);
  VSE.$$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  VSE.escapeHtml = (s)=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  VSE.uniquePush=(a,v)=>{if(!a.includes(v))a.push(v);};
  VSE.bulletize=(ls)=>ls.map(l=>'• '+l).join('\n');
  VSE.unbulletize=(t)=>(t||'').split(/\r?\n/).map(s=>s.replace(/^\s*•\s?/,'').trim()).filter(Boolean);
  VSE.updateFlowNameLine=function(){ const el=VSE.$('#flowNameValue'); if(!el) return; const n=(VSE.labels.box3||'').trim(); el.textContent = n && n.toLowerCase()!=='value stream' ? n : '<Set>'; };
  VSE.updateFlowDescriptionLine=function(){ const el=VSE.$('#flowDescValue'); if(!el) return; const d=(VSE.flowDescription||'').trim(); el.textContent = d ? d : '<None>'; };
  VSE.selectTab=function(id){ const tabs=VSE.$('#tabs'); if(!tabs) return; VSE.$$('#tabs .tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.target===id)); const panels={'tab-canvas':VSE.$('#tab-canvas'),'tab-summary':VSE.$('#tab-summary')}; Object.entries(panels).forEach(([pid,el])=>{ if(!el) return; if(pid===id) el.removeAttribute('hidden'); else el.setAttribute('hidden',''); }); };
  // KPI validation: "<Text>: <Number><Unit>" e.g., "Time to create: 2000Minutes"
  VSE.isValidKpiItem = function(s){
    const str = String(s||'').trim();
    // Require: any text without colon, then colon+space, then integer number, then letters for unit
    return /^[^:]+: [0-9]+[A-Za-z]+$/.test(str);
  };
})();</script>
  <script>(function(){const{$}=window.VSE;const root=$('#modals-root');const tpl=`
<dialog id="inputModal" aria-labelledby="inputModalTitle">
  <div class="modal-header" id="inputModalTitle">Add item</div>
  <form method="dialog" id="inputForm">
    <div class="modal-body">
      <div class="field"><label for="itemName">Item name</label><input id="itemName" name="itemName" type="text" placeholder="Type the name" required /><div class="muted">Enter confirms, Esc cancels.</div></div>
    </div>
    <div class="modal-actions"><button class="btn-secondary" type="button" id="cancelBtn">Cancel</button><button value="ok">Add</button></div>
  </form>
</dialog>
<dialog id="linkClientAdvertModal" aria-labelledby="linkClientAdvertTitle">
  <div class="modal-header" id="linkClientAdvertTitle">Associate Org, Applications and Info</div>
  <form method="dialog" id="linkClientAdvertForm">
  <div class="modal-body">
      <div class="muted" style="margin-bottom:8px;">Item: <strong id="linkClientAdvertName"></strong></div>
      <div class="field"><label>Org (select one)</label><div id="clientOrgRadios" class="checkbox-grid"></div></div>
      <div class="field"><label>Location (select one)</label><div id="clientLocationRadios" class="checkbox-grid"></div></div>
      <div class="field"><label>Applications (select one or more)</label><div id="clientAppsCheckboxes" class="checkbox-grid"></div></div>
      <div class="field"><label>Info (select one or more)</label><div id="clientInfoCheckboxes" class="checkbox-grid"></div></div>
    </div>
    <div class="modal-actions"><button type="button" class="btn-secondary" id="cancelClientAdvertBtn">Cancel</button><button value="ok">Save</button></div>
  </form>
</dialog>
<dialog id="exportModal" aria-labelledby="exportModalTitle">
  <div class="modal-header" id="exportModalTitle">Export JSON</div>
  <div class="modal-body">
    <div class="field"><label for="exportTextarea">Generated structure</label><textarea id="exportTextarea" readonly></textarea><div class="muted">Copy the content to save as a .json file.</div></div>
  </div>
  <div class="modal-actions"><button id="copyBtn" class="btn-secondary" type="button">Copy</button><button id="closeExportBtn">Close</button></div>
</dialog>
<dialog id="importModal" aria-labelledby="importModalTitle">
  <div class="modal-header" id="importModalTitle">Import JSON</div>
  <form method="dialog" id="importForm">
    <div class="modal-body">
      <div class="field"><label for="importFile">File (.json) — optional</label><input id="importFile" type="file" accept=".json,application/json" /></div>
      <div class="field"><label for="importTextarea">Paste JSON here</label><textarea id="importTextarea" placeholder='{"Suppliers":["Acme"],"Locations":["SP"],"Value Stream":["Map"],"Org":[],"Info":[],"Applications":[],"Value Stream Name":"Payments Flow"}'></textarea><div class="muted">The format must use the same keys as Export JSON.</div></div>
    </div>
    <div class="modal-actions"><button class="btn-secondary" type="button" id="cancelImportBtn">Cancel</button><button value="ok">Load</button></div>
  </form>
</dialog>
<dialog id="editTitleModal" aria-labelledby="editTitleModalTitle">
  <div class="modal-header" id="editTitleModalTitle">Edit title</div>
  <form method="dialog" id="editTitleForm">
    <div class="modal-body">
      <div class="field"><label for="titleInput">New title</label><input id="titleInput" name="titleInput" type="text" placeholder="Type the new title" required /><div class="muted">Enter confirms, Esc cancels.</div></div>
    </div>
    <div class="modal-actions"><button class="btn-secondary" type="button" id="cancelEditTitleBtn">Cancel</button><button value="ok">Save</button></div>
  </form>
</dialog>
<dialog id="editDescModal" aria-labelledby="editDescModalTitle">
  <div class="modal-header" id="editDescModalTitle">Edit flow description</div>
  <form method="dialog" id="editDescForm">
    <div class="modal-body">
      <div class="field"><label for="flowDescInput">Flow description</label><input id="flowDescInput" name="flowDescInput" type="text" placeholder="Type the flow description" /><div class="muted">Enter confirms, Esc cancels.</div></div>
    </div>
    <div class="modal-actions"><button class="btn-secondary" type="button" id="cancelEditDescBtn">Cancel</button><button value="ok">Save</button></div>
  </form>
</dialog>
<dialog id="editItemModal" aria-labelledby="editItemModalTitle">
  <div class="modal-header" id="editItemModalTitle">Edit item</div>
  <form method="dialog" id="editItemForm">
    <div class="modal-body">
      <div class="field"><label for="editItemName">Item name</label><input id="editItemName" name="editItemName" type="text" placeholder="Update the name" required /><div class="muted">Enter confirms, Esc cancels.</div></div>
    </div>
    <div class="modal-actions"><button class="btn-secondary" type="button" id="cancelEditItemBtn">Cancel</button><button value="ok">Save</button></div>
  </form>
</dialog>
<dialog id="addStageModal" aria-labelledby="addStageModalTitle">
  <div class="modal-header" id="addStageModalTitle">Add Value Stage</div>
  <form method="dialog" id="addStageForm">
    <div class="modal-body">
      <div class="field"><label for="stageName">Stage name</label><input id="stageName" name="stageName" type="text" placeholder="e.g., Discover, Design, Build..." required /><div class="muted">The new column will use this name in the first row.</div></div>
      <div class="field"><label for="stageDesc">Description</label><input id="stageDesc" name="stageDesc" type="text" placeholder="Optional description" /></div>
      <div class="field"><label for="stageRoles">Business role types</label><input id="stageRoles" name="stageRoles" type="text" placeholder="Comma-separated, e.g., Business Division, Consumer" /></div>
    </div>
    <div class="modal-actions"><button class="btn-secondary" type="button" id="cancelAddStageBtn">Cancel</button><button value="ok">Add</button></div>
  </form>
</dialog>
<dialog id="editStageModal" aria-labelledby="editStageModalTitle">
  <div class="modal-header" id="editStageModalTitle">Rename Value Stage</div>
  <form method="dialog" id="editStageForm">
    <div class="modal-body">
      <div class="field"><label for="editStageName">New name</label><input id="editStageName" name="editStageName" type="text" placeholder="e.g., Discover, Design, Build..." required /></div>
      <div class="field"><label for="editStageDesc">Description</label><input id="editStageDesc" name="editStageDesc" type="text" placeholder="Optional description" /></div>
      <div class="field"><label for="editStageRoles">Business role types</label><input id="editStageRoles" name="editStageRoles" type="text" placeholder="Comma-separated, e.g., Business Division, Consumer" /></div>
    </div>
    <div class="modal-actions"><button class="btn-secondary" type="button" id="cancelEditStageBtn">Cancel</button><button value="ok">Save</button></div>
  </form>
</dialog>
<dialog id="removeStageModal" aria-labelledby="removeStageModalTitle">
  <div class="modal-header" id="removeStageModalTitle">Remove Value Stage</div>
  <div class="modal-body">Are you sure you want to remove column <strong id="removeStageName"></strong>? This action cannot be undone.</div>
  <div class="modal-actions"><button class="btn-secondary" type="button" id="cancelRemoveStageBtn">Cancel</button><button type="button" id="confirmRemoveStageBtn">Remove</button></div>
</dialog>
<dialog id="addCellTextModal" aria-labelledby="addCellTextTitle">
  <div class="modal-header" id="addCellTextTitle">Add text to cell</div>
  <form method="dialog" id="addCellTextForm">
    <div class="modal-body"><div class="field"><label for="cellTextInput">Text</label><input id="cellTextInput" name="cellTextInput" type="text" placeholder="Type a new text" required /></div></div>
    <div class="modal-actions"><button class="btn-secondary" type="button" id="cancelAddCellTextBtn">Cancel</button><button value="ok">Add</button></div>
  </form>
</dialog>
<dialog id="editCellModal" aria-labelledby="editCellTitle">
  <div class="modal-header" id="editCellTitle">Edit cell content</div>
  <form method="dialog" id="editCellForm">
    <div class="modal-body"><div class="field"><label for="cellTextarea">Content</label><textarea id="cellTextarea" name="cellTextarea" placeholder="Enter content. One line per item."></textarea></div></div>
    <div class="modal-actions"><button class="btn-secondary" type="button" id="cancelEditCellBtn">Cancel</button><button value="ok">Save</button></div>
  </form>
</dialog>
<dialog id="addVSProcessModal" aria-labelledby="addVSProcessTitle">
  <div class="modal-header" id="addVSProcessTitle">Add Process to Value Stream</div>
  <form method="dialog" id="addVSProcessForm">
    <div class="modal-body">
      <div class="field"><label for="vsProcessName">Process name</label><input id="vsProcessName" name="vsProcessName" type="text" placeholder="e.g., Approve Order" required /></div>
      <div class="field"><label for="vsProcessStage">Value Stage</label><select id="vsProcessStage" name="vsProcessStage" required></select><div class="muted">Associate the process with an existing Value Stage.</div></div>
    </div>
    <div class="modal-actions"><button class="btn-secondary" type="button" id="cancelVSProcessBtn">Cancel</button><button value="ok">Add</button></div>
  </form>
</dialog>
<dialog id="linkSuppliersModal" aria-labelledby="linkSuppliersTitle">
  <div class="modal-header" id="linkSuppliersTitle">Associate Applications</div>
  <form method="dialog" id="linkSuppliersForm">
    <div class="modal-body"><div class="muted" style="margin-bottom:8px;">Supplier: <strong id="linkSupplierName"></strong></div><div id="appsCheckboxes" class="checkbox-grid"></div></div>
    <div class="modal-actions"><button type="button" class="btn-secondary" id="cancelLinkBtn">Cancel</button><button value="ok">Save</button></div>
  </form>
</dialog>
<dialog id="confirmClear" aria-labelledby="confirmClearTitle">
  <div class="modal-header" id="confirmClearTitle">Clear everything</div>
  <div class="modal-body">Are you sure you want to clear all boxes and the matrix? This action cannot be undone.</div>
  <div class="modal-actions"><button class="btn-secondary" type="button" id="cancelClearBtn">Cancel</button><button type="button" id="confirmClearBtn">Clear</button></div>
</dialog>`; root.innerHTML=tpl;})();</script>
  <script>(function(){const V=window.VSE;const{$,escapeHtml,uniquePush}=V;const grid=$('#grid');
function getClientAdvertKey(){for(let i=1;i<=6;i++){const key=`box${i}`;if((V.labels[key]||'').trim()==='Client Advert to Engage')return key;}return null;}
// Expose for other script blocks (export/import handlers)
window.getClientAdvertKey = getClientAdvertKey;
function renderAll(){grid.innerHTML='';for(let i=1;i<=6;i++){const key=`box${i}`;const boxEl=document.createElement('div');boxEl.className='box'+((i===3||i===6)?' span-2':'');boxEl.dataset.key=key;boxEl.innerHTML=`
  <div class="box-header">
    <div class="box-title">${V.labels[key]}</div>
    <div class="actions">
      <button class="btn-secondary addBtn" data-key="${key}" title="Add item to ${V.labels[key]}">+ Add</button>
    </div>
  </div>
  <div class="list" id="list-${key}"></div>`;grid.appendChild(boxEl);if(key==='box3'){const actionsEl=boxEl.querySelector('.box-header .actions');const editBtn=document.createElement('button');editBtn.className='btn-secondary editTitleBtn';editBtn.dataset.key=key;editBtn.title='Edit title';editBtn.textContent='✎ Title';actionsEl.prepend(editBtn);}renderBox(key);if(key==='box3')setupDndForBox3();}}V.renderCanvasAll=renderAll;
function applyInvalidDecoration(key){
  if(key==='box1'){
    const appsSet=new Set(V.state.box6);
    Object.keys(V.supplierApps).forEach(s=>{V.supplierApps[s]=(V.supplierApps[s]||[]).filter(a=>appsSet.has(a));});
    const list=$('#list-box1');if(!list)return;
    [...list.children].forEach((el,idx)=>{const name=V.state.box1[idx];const apps=(V.supplierApps[name]||[]);el.classList.toggle('invalid',apps.length===0);});
  }else if(key==='box6'){
    const usedApps=new Set();Object.values(V.supplierApps).forEach(arr=>(arr||[]).forEach(a=>usedApps.add(a)));
    const list=$('#list-box6');if(!list)return;
    [...list.children].forEach((el,idx)=>{const app=V.state.box6[idx];el.classList.toggle('invalid',!usedApps.has(app));});
  }else if(key===getClientAdvertKey()){
    const list=$(`#list-${key}`);if(!list)return;
    [...list.children].forEach((el,idx)=>{
      const item=V.state[key][idx];
      const assoc=V.clientAdvertLinks[item]||{org:'',apps:[],info:[],location:''};
      const okOrg=!!assoc.org; const okLoc=!!assoc.location;
      // Only Org and Location are mandatory; Applications and Info optional
      el.classList.toggle('invalid',!(okOrg&&okLoc));
    });
  }
}
function renderBox(key){const list=$(`#list-${key}`);if(!list)return;list.innerHTML='';V.state[key].forEach((name,idx)=>{const item=document.createElement('div');item.className='item';item.innerHTML=`
  <span class="label" title="${escapeHtml(name)}">${escapeHtml(name)}</span>
  <div class="btns" style="display:flex; gap:6px;">
    ${key==='box1'?'<button class="remove" data-action="link" data-key="'+key+'" data-index="'+idx+'" title="Associate Applications">⌖</button>':''}
    
    ${key===getClientAdvertKey()?'<button class="remove" data-action="link-client" data-key="'+key+'" data-index="'+idx+'" title="Associate Org, Applications and Info" aria-label="Associate">⌖</button>':''}
    <button class="remove" data-action="edit" data-key="${key}" data-index="${idx}" title="Edit">✎</button>
    <button class="remove danger" data-action="remove" data-key="${key}" data-index="${idx}" title="Remove">&minus;</button>
  </div>`;if(key==='box3'){item.setAttribute('draggable','true');item.dataset.index=idx;}list.appendChild(item);});if(key==='box1'||key==='box6'||key===getClientAdvertKey())applyInvalidDecoration(key);}V.renderBox=renderBox;
function addItem(key,name){if(!name)return;V.state[key].push(name.trim());renderBox(key);if(key==='box1'||key==='box6'){renderBox('box1');renderBox('box6');}}
function removeItem(key,index){const removed=V.state[key][index];V.state[key].splice(index,1);
  if(key==='box4'){
    // Clear org selection in clientAdvert links
    Object.keys(V.clientAdvertLinks).forEach(it=>{if(V.clientAdvertLinks[it]?.org===removed)V.clientAdvertLinks[it].org='';});
  } else if(key==='box2'){
    // Clear location selection in clientAdvert links
    Object.keys(V.clientAdvertLinks).forEach(it=>{if(V.clientAdvertLinks[it]?.location===removed)V.clientAdvertLinks[it].location='';});
  } else if(key==='box6'){
    // Remove application from any clientAdvert associations
    Object.keys(V.clientAdvertLinks).forEach(it=>{V.clientAdvertLinks[it].apps=(V.clientAdvertLinks[it].apps||[]).filter(a=>a!==removed);});
  } else if(key==='box5'){
    // Remove info from any clientAdvert associations
    Object.keys(V.clientAdvertLinks).forEach(it=>{V.clientAdvertLinks[it].info=(V.clientAdvertLinks[it].info||[]).filter(a=>a!==removed);});
  }
  renderBox(key);
  if(key==='box1'||key==='box6'){renderBox('box1');renderBox('box6');}
  const cKey=getClientAdvertKey();if(cKey)renderBox(cKey);
}V.addItem=addItem;V.removeItem=removeItem;
let dndFromIndex=-1;function setupDndForBox3(){const list=$('#list-box3');if(!list||list.dataset.dndBound==='true')return;list.dataset.dndBound='true';list.addEventListener('dragstart',e=>{const item=e.target.closest('.item');if(!item)return;dndFromIndex=[...list.children].indexOf(item);item.classList.add('dragging');try{e.dataTransfer.setData('text/plain','drag');}catch{}e.dataTransfer.effectAllowed='move';});list.addEventListener('dragover',e=>{e.preventDefault();const dragging=list.querySelector('.dragging');if(!dragging)return;const after=getDragAfterElement(list,e.clientY);if(after==null)list.appendChild(dragging);else list.insertBefore(dragging,after);});list.addEventListener('drop',e=>{e.preventDefault();const dragging=list.querySelector('.dragging');if(!dragging)return;dragging.classList.remove('dragging');const newIndex=[...list.children].indexOf(dragging);if(newIndex>-1&&dndFromIndex>-1&&newIndex!==dndFromIndex){const arr=V.state.box3;const[moved]=arr.splice(dndFromIndex,1);arr.splice(newIndex,0,moved);renderBox('box3');}dndFromIndex=-1;});list.addEventListener('dragend',()=>{const dragging=list.querySelector('.dragging');if(dragging)dragging.classList.remove('dragging');dndFromIndex=-1;});}
function getDragAfterElement(container,y){const els=[...container.querySelectorAll('.item:not(.dragging)')];let closest={offset:Number.NEGATIVE_INFINITY,element:null};for(const el of els){const box=el.getBoundingClientRect();const offset=y-box.top-box.height/2;if(offset<0&&offset>closest.offset){closest={offset,element:el};}}return closest.element;}
const linkModal=$('#linkSuppliersModal');const linkForm=$('#linkSuppliersForm');const linkSupplierNameEl=$('#linkSupplierName');const appsCheckboxes=$('#appsCheckboxes');const cancelLinkBtn=$('#cancelLinkBtn');let linkingSupplier=null;
// Org-Location modal elements
// (Removed Org-Location modal)
// Client Advert modal elements
const linkClientAdvertModal=$('#linkClientAdvertModal');
const linkClientAdvertForm=$('#linkClientAdvertForm');
const linkClientAdvertNameEl=$('#linkClientAdvertName');
const clientOrgRadios=$('#clientOrgRadios');
const clientAppsCheckboxes=$('#clientAppsCheckboxes');
const clientLocationRadios=$('#clientLocationRadios');
const clientInfoCheckboxes=$('#clientInfoCheckboxes');
const cancelClientAdvertBtn=$('#cancelClientAdvertBtn');
let linkingClientItem=null;
function openLinkModal(name){linkingSupplier=name;linkSupplierNameEl.textContent=name;appsCheckboxes.innerHTML='';if(V.state.box6.length===0){const p=document.createElement('p');p.className='muted';p.textContent='No Applications registered. Add them in the "Applications" box.';appsCheckboxes.appendChild(p);}else{const selected=new Set((V.supplierApps[name]||[]));V.state.box6.forEach((app,idx)=>{const id='app-'+idx;const wrap=document.createElement('label');const cb=document.createElement('input');cb.type='checkbox';cb.id=id;cb.value=app;cb.checked=selected.has(app);const span=document.createElement('span');span.textContent=app;wrap.append(cb,span);appsCheckboxes.appendChild(wrap);});}linkModal.showModal();}
// (Removed Org-Location modal handlers)
linkForm.addEventListener('submit',e=>{e.preventDefault();if(!linkingSupplier){linkModal.close();return;}const chosen=[];appsCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb=>{if(cb.checked)chosen.push(cb.value);});V.supplierApps[linkingSupplier]=chosen;renderBox('box1');renderBox('box6');linkModal.close();});cancelLinkBtn.addEventListener('click',()=>linkModal.close());
function openLinkClientAdvertModal(name){linkingClientItem=name;linkClientAdvertNameEl.textContent=name;clientOrgRadios.innerHTML='';clientLocationRadios.innerHTML='';clientAppsCheckboxes.innerHTML='';clientInfoCheckboxes.innerHTML='';
  const assoc=V.clientAdvertLinks[name]||{org:'',apps:[],info:[],location:''};
  if(V.state.box4.length===0){const p=document.createElement('p');p.className='muted';p.textContent='No Org registered. Add them in the "Org" box.';clientOrgRadios.appendChild(p);}else{V.state.box4.forEach((org,idx)=>{const id='org-'+idx;const wrap=document.createElement('label');const rb=document.createElement('input');rb.type='radio';rb.name='clientOrg';rb.id=id;rb.value=org;rb.checked=(assoc.org===org);const span=document.createElement('span');span.textContent=org;wrap.append(rb,span);clientOrgRadios.appendChild(wrap);});}
  if(V.state.box2.length===0){const p=document.createElement('p');p.className='muted';p.textContent='No Locations registered. Add them in the "Locations" box.';clientLocationRadios.appendChild(p);}else{V.state.box2.forEach((loc,idx)=>{const id='cloc-'+idx;const wrap=document.createElement('label');const rb=document.createElement('input');rb.type='radio';rb.name='clientLocation';rb.id=id;rb.value=loc;rb.checked=(assoc.location===loc);const span=document.createElement('span');span.textContent=loc;wrap.append(rb,span);clientLocationRadios.appendChild(wrap);});}
  if(V.state.box6.length===0){const p=document.createElement('p');p.className='muted';p.textContent='No Applications registered. Add them in the "Applications" box.';clientAppsCheckboxes.appendChild(p);}else{const selected=new Set(assoc.apps||[]);V.state.box6.forEach((app,idx)=>{const id='capp-'+idx;const wrap=document.createElement('label');const cb=document.createElement('input');cb.type='checkbox';cb.id=id;cb.value=app;cb.checked=selected.has(app);const span=document.createElement('span');span.textContent=app;wrap.append(cb,span);clientAppsCheckboxes.appendChild(wrap);});}
  if(V.state.box5.length===0){const p=document.createElement('p');p.className='muted';p.textContent='No Info registered. Add them in the "Info" box.';clientInfoCheckboxes.appendChild(p);}else{const selected=new Set(assoc.info||[]);V.state.box5.forEach((inf,idx)=>{const id='cinfo-'+idx;const wrap=document.createElement('label');const cb=document.createElement('input');cb.type='checkbox';cb.id=id;cb.value=inf;cb.checked=selected.has(inf);const span=document.createElement('span');span.textContent=inf;wrap.append(cb,span);clientInfoCheckboxes.appendChild(wrap);});}
  linkClientAdvertModal.showModal();}
linkClientAdvertForm.addEventListener('submit',e=>{e.preventDefault();if(!linkingClientItem){linkClientAdvertModal.close();return;}const orgSel=clientOrgRadios.querySelector('input[type="radio"]:checked');const org=orgSel?orgSel.value:'';const locSel=clientLocationRadios.querySelector('input[type="radio"]:checked');const location=locSel?locSel.value:'';const apps=[];clientAppsCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb=>{if(cb.checked)apps.push(cb.value);});const info=[];clientInfoCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb=>{if(cb.checked)info.push(cb.value);});V.clientAdvertLinks[linkingClientItem]={org,location,apps,info};linkingClientItem=null;linkClientAdvertModal.close();const key=getClientAdvertKey();if(key)V.renderBox(key);});
cancelClientAdvertBtn.addEventListener('click',()=>{linkingClientItem=null;linkClientAdvertModal.close();});
grid.addEventListener('click',e=>{const editTitleBtn=e.target.closest('.editTitleBtn');if(editTitleBtn){openEditTitleModal(editTitleBtn.dataset.key);return;}const linkBtn=e.target.closest('[data-action="link"]');if(linkBtn){const key=linkBtn.dataset.key;const index=Number(linkBtn.dataset.index);if(key==='box1'){openLinkModal(V.state.box1[index]);return;}}const linkClientBtn=e.target.closest('[data-action="link-client"]');if(linkClientBtn){const key=linkClientBtn.dataset.key;const index=Number(linkClientBtn.dataset.index);const clientKey=getClientAdvertKey();if(clientKey&&key===clientKey){openLinkClientAdvertModal(V.state[key][index]);return;}}const editItemBtn=e.target.closest('[data-action="edit"]');if(editItemBtn){openEditItemModal(editItemBtn.dataset.key,Number(editItemBtn.dataset.index));return;}const addBtn=e.target.closest('.addBtn');if(addBtn){const key=addBtn.dataset.key;if(key==='box3'){if(V.vsStages.length===0){alert('First add at least one Value Stage in the Summary tab.');return;}openAddVSProcessModal();}else{openInputModal(key);}return;}const removeBtn=e.target.closest('[data-action="remove"]');if(removeBtn){const key=removeBtn.dataset.key;const index=Number(removeBtn.dataset.index);if(key==='box3'){const name=V.state.box3[index];removeProcess(name);}else if(key==='box1'){const name=V.state.box1[index];delete V.supplierApps[name];V.removeItem(key,index);renderBox('box6');}else if(key==='box6'){const app=V.state.box6[index];Object.keys(V.supplierApps).forEach(s=>{V.supplierApps[s]=(V.supplierApps[s]||[]).filter(a=>a!==app);});V.removeItem(key,index);renderBox('box1');}else if(key==='box4'){const name=V.state.box4[index];V.removeItem(key,index);}else if(key==='box2'){V.removeItem(key,index);}else{const clientKey=getClientAdvertKey();if(clientKey&&key===clientKey){const removed=V.state[key][index];delete V.clientAdvertLinks[removed];}V.removeItem(key,index);}}});
window.openInputModal=function(forKey){const modal=$('#inputModal');const itemName=$('#itemName');modal.showModal();itemName.value='';modal.dataset.key=forKey;setTimeout(()=>itemName.focus(),0);};
window.openEditTitleModal=function(forKey){const modal=$('#editTitleModal');const titleInput=$('#titleInput');modal.showModal();modal.dataset.key=forKey;titleInput.value=V.labels[forKey]||'';setTimeout(()=>titleInput.select(),0);};
window.openEditItemModal=function(forKey,index){const modal=$('#editItemModal');const input=$('#editItemName');modal.showModal();modal.dataset.key=forKey;modal.dataset.index=String(index);input.value=V.state[forKey][index]||'';setTimeout(()=>input.select(),0);};
window.openAddVSProcessModal=function(){const modal=$('#addVSProcessModal');const name=$('#vsProcessName');const sel=$('#vsProcessStage');sel.innerHTML='';V.vsStages.forEach((s,i)=>{const opt=document.createElement('option');opt.value=String(i);opt.textContent=s;sel.appendChild(opt);});modal.showModal();name.value='';setTimeout(()=>name.focus(),0);};
window.addProcessToStage=function(name,stageIdx){name=name.trim();if(!name)return;const tableCol=stageIdx+1;const oldStage=V.processesMap[name];if(oldStage!=null&&oldStage!==stageIdx){const oldTableCol=oldStage+1;const itemsOld=window.getProcessesFromCell(oldTableCol);const idxOld=itemsOld.indexOf(name);if(idxOld>-1){itemsOld.splice(idxOld,1);window.setProcessesInCell(oldTableCol,itemsOld);}}const items=window.getProcessesFromCell(tableCol);if(!items.includes(name)){items.push(name);window.setProcessesInCell(tableCol,items);}V.processesMap[name]=stageIdx;uniquePush(V.state.box3,name);V.renderBox('box3');};
window.removeProcess=function(name){const stageIdx=V.processesMap[name];if(stageIdx!=null){const tableCol=stageIdx+1;const items=window.getProcessesFromCell(tableCol);const i=items.indexOf(name);if(i>-1){items.splice(i,1);window.setProcessesInCell(tableCol,items);}delete V.processesMap[name];}const idx=V.state.box3.indexOf(name);if(idx>-1)V.state.box3.splice(idx,1);V.renderBox('box3');};
(function(){const inputModal=$('#inputModal');const inputForm=$('#inputForm');const itemName=$('#itemName');const cancelBtn=$('#cancelBtn');inputForm.addEventListener('submit',e=>{e.preventDefault();const key=inputModal.dataset.key;const val=itemName.value.trim();if(val)V.addItem(key,val);inputModal.close();});cancelBtn.addEventListener('click',()=>inputModal.close());
const editTitleModal=$('#editTitleModal');const editTitleForm=$('#editTitleForm');const titleInput=$('#titleInput');const cancelEditTitleBtn=$('#cancelEditTitleBtn');editTitleForm.addEventListener('submit',e=>{e.preventDefault();const key=editTitleModal.dataset.key;const newTitle=titleInput.value.trim();if(newTitle){V.labels[key]=newTitle;const box=grid.querySelector(`.box[data-key="${key}"]`);if(box){const titleEl=box.querySelector('.box-title');if(titleEl)titleEl.textContent=newTitle;const addBtnEl=box.querySelector('.addBtn');if(addBtnEl)addBtnEl.setAttribute('title',`Add item to ${newTitle}`);}if(key==='box3')V.updateFlowNameLine();}editTitleModal.close();});cancelEditTitleBtn.addEventListener('click',()=>editTitleModal.close());
const editDescModal=$('#editDescModal');const editDescForm=$('#editDescForm');const flowDescInput=$('#flowDescInput');const cancelEditDescBtn=$('#cancelEditDescBtn');editDescForm.addEventListener('submit',e=>{e.preventDefault();V.flowDescription=(flowDescInput.value||'').trim();V.updateFlowDescriptionLine();editDescModal.close();});cancelEditDescBtn.addEventListener('click',()=>editDescModal.close());
const editItemModal=$('#editItemModal');const editItemForm=$('#editItemForm');const editItemName=$('#editItemName');const cancelEditItemBtn=$('#cancelEditItemBtn');editItemForm.addEventListener('submit',e=>{e.preventDefault();const key=editItemModal.dataset.key;const index=Number(editItemModal.dataset.index);const oldVal=V.state[key][index];const newVal=editItemName.value.trim();if(!newVal){editItemModal.close();return;}V.state[key][index]=newVal;V.renderBox(key);if(key==='box3'){const stageIdx=V.processesMap[oldVal];if(stageIdx!=null){const tableCol=stageIdx+1;const items=window.getProcessesFromCell(tableCol);const i=items.indexOf(oldVal);if(i>-1){items[i]=newVal;window.setProcessesInCell(tableCol,items);}delete V.processesMap[oldVal];V.processesMap[newVal]=stageIdx;}}else if(key==='box1'){if(V.supplierApps[oldVal]){V.supplierApps[newVal]=V.supplierApps[oldVal];delete V.supplierApps[oldVal];}V.renderBox('box6');}else if(key==='box6'){Object.keys(V.supplierApps).forEach(s=>{V.supplierApps[s]=(V.supplierApps[s]||[]).map(a=>a===oldVal?newVal:a);});Object.keys(V.clientAdvertLinks).forEach(it=>{V.clientAdvertLinks[it].apps=(V.clientAdvertLinks[it].apps||[]).map(a=>a===oldVal?newVal:a);});V.renderBox('box1');const cKey=getClientAdvertKey();if(cKey)V.renderBox(cKey);}else if(key==='box4'){Object.keys(V.clientAdvertLinks).forEach(it=>{if(V.clientAdvertLinks[it]?.org===oldVal)V.clientAdvertLinks[it].org=newVal;});const cKey=getClientAdvertKey();if(cKey)V.renderBox(cKey);}else if(key==='box2'){Object.keys(V.clientAdvertLinks).forEach(it=>{if(V.clientAdvertLinks[it]?.location===oldVal)V.clientAdvertLinks[it].location=newVal;});const cKey=getClientAdvertKey();if(cKey)V.renderBox(cKey);}else if(key==='box5'){Object.keys(V.clientAdvertLinks).forEach(it=>{V.clientAdvertLinks[it].info=(V.clientAdvertLinks[it].info||[]).map(v=>v===oldVal?newVal:v);});const cKey=getClientAdvertKey();if(cKey)V.renderBox(cKey);}else {const cKey=getClientAdvertKey();if(cKey&&key===cKey){if(V.clientAdvertLinks[oldVal]){V.clientAdvertLinks[newVal]=V.clientAdvertLinks[oldVal];delete V.clientAdvertLinks[oldVal];}V.renderBox(cKey);} }editItemModal.close();});cancelEditItemBtn.addEventListener('click',()=>editItemModal.close());})();})();</script>
  <script>(function(){const V=window.VSE;const{$}=V;const summaryGrid=$('#summary-grid');const vsTable=$('#vsTable');const addStageBtn=$('#addStageBtn');
function renderSummaryAll(){summaryGrid.innerHTML='';for(let i=1;i<=6;i++){const key=`sum${i}`;const boxEl=document.createElement('div');boxEl.className='box'+(i===6?' summary-span':'');boxEl.dataset.key=key;boxEl.innerHTML=`
  <div class="box-header">
    <div class="box-title">${V.labels[key]}</div>
    <div class="actions">
      <button class="btn-secondary addBtn" data-key="${key}" title="Add item to ${V.labels[key]}">+ Add</button>
    </div>
  </div>
  <div class="list" id="list-${key}"></div>`;summaryGrid.appendChild(boxEl);V.renderBox(key);}}
V.renderSummaryAll=renderSummaryAll;
function createStageHeaderCell(name,colIdx){const th=document.createElement('th');const wrap=document.createElement('div');wrap.className='stage-header';const span=document.createElement('span');span.className='stage-title';span.textContent=name;const actions=document.createElement('span');actions.className='stage-actions';const editBtn=document.createElement('button');editBtn.className='mini-btn stage-edit';editBtn.dataset.col=String(colIdx);editBtn.title='Rename column';editBtn.textContent='✎';const remBtn=document.createElement('button');remBtn.className='mini-btn danger stage-remove';remBtn.dataset.col=String(colIdx);remBtn.title='Remove column';remBtn.textContent='×';actions.append(editBtn,remBtn);wrap.append(span,actions);th.appendChild(wrap);return th;}
function updateHeaderIndices(){const headerRow=vsTable.querySelector('tr');if(!headerRow)return;const headers=headerRow.querySelectorAll('th:not(.row-header)');headers.forEach((h,i)=>{const edit=h.querySelector('.stage-edit');const rem=h.querySelector('.stage-remove');if(edit)edit.dataset.col=String(i);if(rem)rem.dataset.col=String(i);});}
function createEditableCell(rowIdx,colIdx,initialText=''){const td=document.createElement('td');const wrap=document.createElement('div');wrap.className='cell-wrapper';const toolbar=document.createElement('div');toolbar.className='cell-toolbar';toolbar.innerHTML=`
  <button class="mini-btn cell-add" title="Add text" data-row="${rowIdx}" data-col="${colIdx + 1}">+</button>
  <button class="mini-btn cell-edit" title="Edit cell" data-row="${rowIdx}" data-col="${colIdx + 1}">✎</button>
  <button class="mini-btn danger cell-clear" title="Clear text" data-row="${rowIdx}" data-col="${colIdx + 1}">×</button>`;const content=document.createElement('div');content.className='cell-content';content.setAttribute('contenteditable','true');content.dataset.row=String(rowIdx);content.dataset.col=String(colIdx+1);content.textContent=initialText;wrap.append(toolbar,content);td.appendChild(wrap);return td;}
// Create a dropdown cell for the "Target Emotions" row
function createEmotionCell(rowIdx,colIdx,initialValue=''){const td=document.createElement('td');const wrap=document.createElement('div');wrap.className='cell-wrapper';const select=document.createElement('select');select.className='cell-select emotion-select';const opts=['','Bored','Confused','Deceived','Disappointed','Excited','Grateful','Impatient','Surprised','Worried'];const labels={'':'— Select —'};opts.forEach(v=>{const opt=document.createElement('option');opt.value=v;opt.textContent=labels[v]||v;select.appendChild(opt);});select.value=initialValue||'';wrap.append(select);td.appendChild(wrap);return td;}
function renderStagesTable(){vsTable.innerHTML='';const tbody=document.createElement('tbody');V.vsRows.forEach((rowLabel,rowIdx)=>{const tr=document.createElement('tr');const th=document.createElement('th');th.className='row-header';th.textContent=rowLabel;tr.appendChild(th);V.vsStages.forEach((stageName,colIdx)=>{if(rowIdx===0){tr.appendChild(createStageHeaderCell(stageName,colIdx));}else if(rowLabel==='Target Emotions'){tr.appendChild(createEmotionCell(rowIdx,colIdx,''));}else{tr.appendChild(createEditableCell(rowIdx,colIdx,''));}});tbody.appendChild(tr);});vsTable.appendChild(tbody);}V.renderStagesTable=renderStagesTable;
function getCell(row,tableCol){const tr=vsTable.tBodies[0]?.rows[row];return tr?.cells[tableCol]||null;}
function getCellContent(row,tableCol){const td=getCell(row,tableCol);return td?.querySelector('.cell-content')?.innerText||'';}
function setCellContent(row,tableCol,text){const td=getCell(row,tableCol);const content=td?.querySelector('.cell-content');if(content)content.textContent=text;}
function getProcessesFromCell(tableCol){const text=getCellContent(V.PROCESS_ROW_INDEX,tableCol);return V.unbulletize(text);}
function setProcessesInCell(tableCol,items){setCellContent(V.PROCESS_ROW_INDEX,tableCol,V.bulletize(items));}
window.getProcessesFromCell=getProcessesFromCell;window.setProcessesInCell=setProcessesInCell;
function syncProcessesFromCell(tableCol){const stageIdx=tableCol-1;const current=new Set(getProcessesFromCell(tableCol));const prev=new Set(Object.entries(V.processesMap).filter(([n,s])=>s===stageIdx).map(([n])=>n));prev.forEach(name=>{if(!current.has(name)){delete V.processesMap[name];const i=V.state.box3.indexOf(name);if(i>-1)V.state.box3.splice(i,1);}});current.forEach(name=>{const oldStage=V.processesMap[name];if(oldStage==null){V.processesMap[name]=stageIdx;V.uniquePush(V.state.box3,name);}else if(oldStage!==stageIdx){const oldTableCol=oldStage+1;const items=getProcessesFromCell(oldTableCol);const idx=items.indexOf(name);if(idx>-1){items.splice(idx,1);setProcessesInCell(oldTableCol,items);}V.processesMap[name]=stageIdx;V.uniquePush(V.state.box3,name);}});V.renderBox('box3');}
function removeProcessesForStage(stageIdx){const names=Object.entries(V.processesMap).filter(([n,s])=>s===stageIdx).map(([n])=>n);names.forEach(n=>{delete V.processesMap[n];const i=V.state.box3.indexOf(n);if(i>-1)V.state.box3.splice(i,1);});V.renderBox('box3');}
window.removeProcessesForStage=removeProcessesForStage;
vsTable.addEventListener('click',e=>{const addBtn=e.target.closest('.cell-add');if(addBtn){openAddTextModal(Number(addBtn.dataset.row),Number(addBtn.dataset.col));return;}const editBtn=e.target.closest('.cell-edit');if(editBtn){openEditCellModal(Number(editBtn.dataset.row),Number(editBtn.dataset.col));return;}const clearBtn=e.target.closest('.cell-clear');if(clearBtn){clearCell(Number(clearBtn.dataset.row),Number(clearBtn.dataset.col));return;}const hdrEdit=e.target.closest('.stage-edit');if(hdrEdit){openEditStageModal(Number(hdrEdit.dataset.col));return;}const hdrRemove=e.target.closest('.stage-remove');if(hdrRemove){openRemoveStageModal(Number(hdrRemove.dataset.col));return;}});
// Track previous valid content for KPI cells
vsTable.addEventListener('focusin',e=>{const content=e.target.closest?.('.cell-content');if(!content)return;const row=Number(content.dataset.row);if(row!==V.KPI_ROW_INDEX)return;content.dataset.prev=content.textContent||'';},true);
vsTable.addEventListener('blur',e=>{const content=e.target.closest?.('.cell-content');if(!content)return;const row=Number(content.dataset.row);const col=Number(content.dataset.col);if(row===V.PROCESS_ROW_INDEX){const lines=V.unbulletize(content.innerText);setCellContent(row,col,V.bulletize(lines));syncProcessesFromCell(col);} if(row===V.KPI_ROW_INDEX){const lines=V.unbulletize(content.innerText);const anyInvalid=lines.some(l=>!V.isValidKpiItem(l));if(anyInvalid){alert('Invalid KPI format. Use "<Text>: <Number><Unit>" (e.g., "Time to create: 2000Minutes").');const prev=content.dataset.prev||'';setCellContent(row,col,prev);content.classList.add('invalid');}else{setCellContent(row,col,V.bulletize(lines));content.dataset.prev=getCell(row,col)?.querySelector('.cell-content')?.textContent||'';content.classList.remove('invalid');}}},true);
const addCellTextModal=$('#addCellTextModal');const addCellTextForm=$('#addCellTextForm');const cellTextInput=$('#cellTextInput');const cancelAddCellTextBtn=$('#cancelAddCellTextBtn');const editCellModal=$('#editCellModal');const editCellForm=$('#editCellForm');const cellTextarea=$('#cellTextarea');const cancelEditCellBtn=$('#cancelEditCellBtn');let activeCell={row:-1,col:-1};

// KPI validation helpers
function validateKpiCell(row, tableCol){
  if(row!==V.KPI_ROW_INDEX) return;
  const td=getCell(row,tableCol);
  const content=td?.querySelector('.cell-content');
  if(!content) return;
  const lines=V.unbulletize(content.innerText);
  const anyInvalid=lines.some(l=>!V.isValidKpiItem(l));
  content.classList.toggle('invalid', anyInvalid);
}
function validateAllKpiCells(){
  if(V.KPI_ROW_INDEX<0) return;
  for(let c=1;c<=V.vsStages.length;c++) validateKpiCell(V.KPI_ROW_INDEX, c);
}
// Expose validators for other script blocks
V.validateKpiCell = validateKpiCell;
V.validateAllKpiCells = validateAllKpiCells;
function openAddTextModal(row,col){activeCell={row,col};cellTextInput.value='';addCellTextModal.showModal();setTimeout(()=>cellTextInput.focus(),0);}
function openEditCellModal(row,col){activeCell={row,col};const plain=getCellContent(row,col).replace(/^\s*•\s?/gm,'');cellTextarea.value=plain;editCellModal.showModal();setTimeout(()=>cellTextarea.focus(),0);}
function clearCell(row,col){setCellContent(row,col,'');if(row===V.PROCESS_ROW_INDEX)syncProcessesFromCell(col);if(row===V.KPI_ROW_INDEX)validateKpiCell(row,col);}
window.openAddTextModal=openAddTextModal;window.openEditCellModal=openEditCellModal;window.clearCell=clearCell;
addCellTextForm.addEventListener('submit',e=>{e.preventDefault();const text=cellTextInput.value.trim();if(text&&activeCell.row>-1&&activeCell.col>-1){if(activeCell.row===V.KPI_ROW_INDEX&&!V.isValidKpiItem(text)){alert('Invalid KPI format. Use "<Text>: <Number><Unit>".');return;}const prev=V.unbulletize(getCellContent(activeCell.row,activeCell.col));prev.push(text);setCellContent(activeCell.row,activeCell.col,V.bulletize(prev));if(activeCell.row===V.PROCESS_ROW_INDEX)syncProcessesFromCell(activeCell.col);if(activeCell.row===V.KPI_ROW_INDEX){const td=getCell(activeCell.row,activeCell.col);const content=td?.querySelector('.cell-content');if(content)content.dataset.prev=content.textContent||'';}}addCellTextModal.close();});cancelAddCellTextBtn.addEventListener('click',()=>addCellTextModal.close());
editCellForm.addEventListener('submit',e=>{e.preventDefault();const lines=cellTextarea.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);if(activeCell.row===V.KPI_ROW_INDEX){const anyInvalid=lines.some(l=>!V.isValidKpiItem(l));if(anyInvalid){alert('Invalid KPI format. Use "<Text>: <Number><Unit>" for each line.');return;}}setCellContent(activeCell.row,activeCell.col,V.bulletize(lines));if(activeCell.row===V.PROCESS_ROW_INDEX)syncProcessesFromCell(activeCell.col);if(activeCell.row===V.KPI_ROW_INDEX){const td=getCell(activeCell.row,activeCell.col);const content=td?.querySelector('.cell-content');if(content)content.dataset.prev=content.textContent||'';}editCellModal.close();});cancelEditCellBtn.addEventListener('click',()=>editCellModal.close());
const addStageModal=$('#addStageModal');const addStageForm=$('#addStageForm');const stageNameInput=$('#stageName');const stageDescInput=$('#stageDesc');const stageRolesInput=$('#stageRoles');const cancelAddStageBtn=$('#cancelAddStageBtn');function openAddStageModal(){stageNameInput.value='';if(stageDescInput)stageDescInput.value='';if(stageRolesInput)stageRolesInput.value='';addStageModal.showModal();setTimeout(()=>stageNameInput.focus(),0);}if(addStageBtn)addStageBtn.addEventListener('click',openAddStageModal);
addStageForm.addEventListener('submit',e=>{e.preventDefault();const name=stageNameInput.value.trim();if(name){V.vsStages.push(name);const roles=(stageRolesInput?.value||'').split(',').map(s=>s.trim()).filter(Boolean);const desc=stageDescInput?.value?.trim()||'';V.vsStageMeta.push({description:desc,businessRoleTypes:roles});addStageColumnDOM(name);}addStageModal.close();});cancelAddStageBtn.addEventListener('click',()=>addStageModal.close());
function addStageColumnDOM(name){let tbody=vsTable.querySelector('tbody');if(!tbody){renderStagesTable();tbody=vsTable.querySelector('tbody');}const rows=[...tbody.querySelectorAll('tr')];const emotionRowIdx=V.vsRows.indexOf('Target Emotions');rows.forEach((tr,rowIdx)=>{if(rowIdx===0){tr.appendChild(createStageHeaderCell(name,V.vsStages.length-1));}else if(rowIdx===emotionRowIdx){tr.appendChild(createEmotionCell(rowIdx,V.vsStages.length-1,''));}else{tr.appendChild(createEditableCell(rowIdx,V.vsStages.length-1,''));}});updateHeaderIndices();}
window.addStageColumnDOM=addStageColumnDOM;
const editStageModal=$('#editStageModal');const editStageForm=$('#editStageForm');const editStageName=$('#editStageName');const editStageDesc=$('#editStageDesc');const editStageRoles=$('#editStageRoles');const cancelEditStageBtn=$('#cancelEditStageBtn');const removeStageModal=$('#removeStageModal');const removeStageName=$('#removeStageName');const cancelRemoveStageBtn=$('#cancelRemoveStageBtn');const confirmRemoveStageBtn=$('#confirmRemoveStageBtn');let editingStageIndex=-1;let removingStageIndex=-1;
function openEditStageModal(colIdx){editingStageIndex=colIdx;editStageName.value=V.vsStages[colIdx]||'';const meta=V.vsStageMeta[colIdx]||{description:'',businessRoleTypes:[]};if(editStageDesc)editStageDesc.value=meta.description||'';if(editStageRoles)editStageRoles.value=(meta.businessRoleTypes||[]).join(', ');editStageModal.showModal();setTimeout(()=>editStageName.select(),0);}function openRemoveStageModal(colIdx){removingStageIndex=colIdx;removeStageName.textContent=V.vsStages[colIdx]||'';removeStageModal.showModal();}
window.openEditStageModal=openEditStageModal;window.openRemoveStageModal=openRemoveStageModal;
editStageForm.addEventListener('submit',e=>{e.preventDefault();const newName=editStageName.value.trim();if(newName&&editingStageIndex>-1){V.vsStages[editingStageIndex]=newName;const desc=editStageDesc?.value?.trim()||'';const roles=(editStageRoles?.value||'').split(',').map(s=>s.trim()).filter(Boolean);V.vsStageMeta[editingStageIndex]={description:desc,businessRoleTypes:roles};const headerRow=vsTable.querySelector('tr');const cell=headerRow?.querySelectorAll('th:not(.row-header)')[editingStageIndex];const titleEl=cell?.querySelector('.stage-title');if(titleEl)titleEl.textContent=newName;}editStageModal.close();});cancelEditStageBtn.addEventListener('click',()=>editStageModal.close());
confirmRemoveStageBtn.addEventListener('click',()=>{if(removingStageIndex>-1){V.vsStages.splice(removingStageIndex,1);V.vsStageMeta.splice(removingStageIndex,1);const rows=vsTable.querySelectorAll('tr');rows.forEach(tr=>{const cells=tr.querySelectorAll('th,td');const target=cells[removingStageIndex+1];if(target)target.remove();});updateHeaderIndices();window.removeProcessesForStage(removingStageIndex);Object.keys(V.processesMap).forEach(n=>{if(V.processesMap[n]>removingStageIndex)V.processesMap[n]-=1;});}removeStageModal.close();});cancelRemoveStageBtn.addEventListener('click',()=>removeStageModal.close());
summaryGrid.addEventListener('click',e=>{const editItemBtn=e.target.closest('[data-action="edit"]');if(editItemBtn){openEditItemModal(editItemBtn.dataset.key,Number(editItemBtn.dataset.index));return;}const addBtn=e.target.closest('.addBtn');if(addBtn){openInputModal(addBtn.dataset.key);return;}const removeBtn=e.target.closest('[data-action="remove"]');if(removeBtn){V.removeItem(removeBtn.dataset.key,Number(removeBtn.dataset.index));return;}});})();</script>
  <script>(function(){const V=window.VSE;const{$}=V;const exportBtn=$('#exportBtn');const createDupBtn=$('#createDupBtn');const exportModal=$('#exportModal');const exportTextarea=$('#exportTextarea');const closeExportBtn=$('#closeExportBtn');const copyBtn=$('#copyBtn');
function getMatrixJSON(){const vsTable=$('#vsTable');if(!vsTable.tBodies.length)V.renderStagesTable();const stages=V.vsStages.map((name,i)=>({name,description:(V.vsStageMeta[i]?.description)||'',businessRoleTypes:(V.vsStageMeta[i]?.businessRoleTypes)||[]}));const rows=V.vsRows.slice(1);const data={};rows.forEach((rowLabel,rIdx)=>{const tr=vsTable.tBodies[0].rows[rIdx+1];const arr=[];if(tr){for(let c=0;c<V.vsStages.length;c++){const cell=tr.cells[c+1];if(rowLabel==='Target Emotions'){const sel=cell?.querySelector('select');arr.push((sel?.value||'').trim());}else{const content=cell?.querySelector('.cell-content');const text=(content?.innerText||'').trim();const list=V.unbulletize(text);arr.push(list);}}}data[rowLabel]=arr;});return{stages,rows,data};}window.getMatrixJSON=getMatrixJSON;
exportBtn.addEventListener('click',()=>{const out={'Suppliers':V.state.box1,'Locations':V.state.box2,'Value Stream':V.state.box3,'Org':V.state.box4,'Info':V.state.box5,'Applications':V.state.box6,'Value Stream Name':V.labels.box3,'Value Stream Description':V.flowDescription,'Initiators':V.state.sum1,'Initiation Events':V.state.sum2,'Initiation Conditions':V.state.sum3,'Outcome Conditions':V.state.sum4,'Outcomes':V.state.sum5,'Impacted Business Services':V.state.sum6,'Value Stages Matrix':getMatrixJSON(),'Suppliers Applications Mapping':(function(){const appsSet=new Set(V.state.box6);const m={};V.state.box1.forEach(s=>{const arr=(V.supplierApps[s]||[]).filter(a=>appsSet.has(a));m[s]=arr;});return m;})(),'Value Stream Associations':(function(){const clientKey=getClientAdvertKey();const m={};if(clientKey){const orgSet=new Set(V.state.box4);const appSet=new Set(V.state.box6);const infoSet=new Set(V.state.box5);const locSet=new Set(V.state.box2);V.state[clientKey].forEach(it=>{const assoc=V.clientAdvertLinks[it]||{org:'',location:'',apps:[],info:[]};const Org=orgSet.has(assoc.org)?assoc.org:'';const Location=locSet.has(assoc.location)?assoc.location:'';const Applications=(assoc.apps||[]).filter(a=>appSet.has(a));const Info=(assoc.info||[]).filter(i=>infoSet.has(i));m[it]={Org,Location,Applications,Info};});}return m;})()};exportTextarea.value=JSON.stringify(out,null,2);exportModal.showModal();exportTextarea.focus();exportTextarea.select();});closeExportBtn.addEventListener('click',()=>exportModal.close());copyBtn.addEventListener('click',async()=>{try{await navigator.clipboard.writeText(exportTextarea.value);copyBtn.textContent='Copied!';setTimeout(()=>copyBtn.textContent='Copy',1200);}catch{copyBtn.textContent='Select and copy';setTimeout(()=>copyBtn.textContent='Copy',1500);}});
const importBtn=$('#importBtn');const importModal=$('#importModal');const importForm=$('#importForm');const importFile=$('#importFile');const importTextarea=$('#importTextarea');const cancelImportBtn=$('#cancelImportBtn');

// ===== DUP generation helpers (ported from essential_dup_generator_v57.html) =====
function b64ToUtf8(b64){ if(!b64) return ""; const bin=atob(b64); const bytes=Uint8Array.from(bin,c=>c.charCodeAt(0)); return new TextDecoder().decode(bytes); }
function ensureDupExtension(name){ const base=(name||'').trim()||'export'; const trimmed=base.toLowerCase().endsWith('.dup')?base:`${base}.dup`; return trimmed; }
function toPythonUnicodeLiteral(value){ const s=String(value??''); const escaped=s.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/\r\n|\r|\n/g,'\\n'); return "u'"+escaped+"'"; }
function flattenBlock(block){ if(block==null) return []; if(Array.isArray(block)){ const out=[]; for(const entry of block){ if(Array.isArray(entry)) out.push(...entry); else if(typeof entry==='string' && entry.trim()) out.push(entry.trim()); } return out; } if(typeof block==='string' && block.trim()){ return block.split(/\r?\n/).map(t=>t.replace(/^\s*•\s*/u,'').trim()).filter(Boolean);} return []; }

async function createDupFromState(){
  const V=window.VSE;
  if(typeof JSZip==='undefined'){ alert('JSZip not available. Check your network connection.'); return; }
  const outName=ensureDupExtension(V.labels.box3||'export');
  const refJson=(function(){
    const out={'Suppliers':V.state.box1,'Locations':V.state.box2,'Value Stream':V.state.box3,'Org':V.state.box4,'Info':V.state.box5,'Applications':V.state.box6,'Value Stream Name':V.labels.box3,'Value Stream Description':V.flowDescription,'Initiators':V.state.sum1,'Initiation Events':V.state.sum2,'Initiation Conditions':V.state.sum3,'Outcome Conditions':V.state.sum4,'Outcomes':V.state.sum5,'Impacted Business Services':V.state.sum6,'Value Stages Matrix':getMatrixJSON(),'Suppliers Applications Mapping':(function(){const appsSet=new Set(V.state.box6);const m={};V.state.box1.forEach(s=>{const arr=(V.supplierApps[s]||[]).filter(a=>appsSet.has(a));m[s]=arr;});return m;})(),'Value Stream Associations':(function(){const clientKey=getClientAdvertKey();const m={};if(clientKey){const orgSet=new Set(V.state.box4);const appSet=new Set(V.state.box6);const infoSet=new Set(V.state.box5);const locSet=new Set(V.state.box2);V.state[clientKey].forEach(it=>{const assoc=V.clientAdvertLinks[it]||{org:'',location:'',apps:[],info:[]};const Org=orgSet.has(assoc.org)?assoc.org:'';const Location=locSet.has(assoc.location)?assoc.location:'';const Applications=(assoc.apps||[]).filter(a=>appSet.has(a));const Info=(assoc.info||[]).filter(i=>infoSet.has(i));m[it]={Org,Location,Applications,Info};});}return m;})()};
    return out;
  })();

  const vsNameRaw=refJson['Value Stream Name'];
  if(typeof vsNameRaw!=='string' || !vsNameRaw.trim()) throw new Error("JSON needs 'Value Stream Name'.");
  const vsNameLiteral=toPythonUnicodeLiteral(vsNameRaw.trim());
  const vsDescRaw=refJson['Value Stream Description'];
  let vsDescCode=""; if(typeof vsDescRaw==='string' && vsDescRaw.trim()){ const vsDescLit=toPythonUnicodeLiteral(vsDescRaw.trim()); vsDescCode="addIfNotThere(valueStream, 'description', "+vsDescLit+")\n"; }
  const initiators=Array.isArray(refJson['Initiators'])?refJson['Initiators']:[];
  const initEvents=Array.isArray(refJson['Initiation Events'])?refJson['Initiation Events']:[];
  const initiationConds=Array.isArray(refJson['Initiation Conditions'])?refJson['Initiation Conditions']:[];
  const outcomeConds=Array.isArray(refJson['Outcome Conditions'])?refJson['Outcome Conditions']:[];
  const outcomes=Array.isArray(refJson['Outcomes'])?refJson['Outcomes']:[];
  const impactedServices=Array.isArray(refJson['Impacted Business Services'])?refJson['Impacted Business Services']:[];
  const suppliersAppsMap=(refJson['Suppliers Applications Mapping']&&typeof refJson['Suppliers Applications Mapping']==='object')?refJson['Suppliers Applications Mapping']:{};
  const valueStreamAssociations=(refJson['Value Stream Associations']&&typeof refJson['Value Stream Associations']==='object')?refJson['Value Stream Associations']:{};
  const vsm=refJson['Value Stages Matrix']||{}; const stages=Array.isArray(vsm.stages)?vsm.stages:[]; const data=vsm.data||{}; const targetEmotions=Array.isArray(data['Target Emotions'])?data['Target Emotions']:[];

  const pythonB64=document.getElementById('python-code-b64').textContent.trim();
  const decodedPythonCode=b64ToUtf8(pythonB64);
  const updateInfoXml=document.getElementById('update-info-xml').textContent;
  const updatepackXsdXml=document.getElementById('updatepack-xsd-xml').textContent;
  const dupScriptHeader=document.getElementById('dup-import-script-header').textContent;

  const vsLine="valueStream=EssentialGetInstance('Value_Stream', u'', "+vsNameLiteral+", u'', externalRepository)\n";
  let initiatorsCode=""; for(const it of initiators) if(typeof it==='string'&&it.trim()){ const itLit=toPythonUnicodeLiteral(it.trim()); initiatorsCode+="individualBusinessRole=EssentialGetInstance('Individual_Business_Role', u'', "+itLit+", u'', externalRepository)\n"; initiatorsCode+="addIfNotThere(valueStream, 'vs_trigger_business_roles', individualBusinessRole)\n"; }
  let initEventsCode=""; for(const ev of initEvents) if(typeof ev==='string'&&ev.trim()){ const evLit=toPythonUnicodeLiteral(ev.trim()); initEventsCode+="businessEvent=EssentialGetInstance('Business_Event', u'', "+evLit+", u'', externalRepository)\n"; initEventsCode+="addIfNotThere(valueStream, 'vs_trigger_events', businessEvent)\n"; }
  let initiationCondsCode=""; for(const ic of initiationConds) if(typeof ic==='string'&&ic.trim()){ const icLit=toPythonUnicodeLiteral(ic.trim()); initiationCondsCode+="businessCondition=EssentialGetInstance('Business_Condition', u'', "+icLit+", u'', externalRepository)\n"; initiationCondsCode+="addIfNotThere(valueStream, 'vs_trigger_conditions', businessCondition)\n"; }
  let outcomeCondsCode=""; for(const oc of outcomeConds) if(typeof oc==='string'&&oc.trim()){ const ocLit=toPythonUnicodeLiteral(oc.trim()); outcomeCondsCode+="businessCondition=EssentialGetInstance('Business_Condition', u'', "+ocLit+", u'', externalRepository)\n"; outcomeCondsCode+="addIfNotThere(valueStream, 'vs_outcome_conditions', businessCondition)\n"; }
  let outcomesCode=""; for(const out of outcomes) if(typeof out==='string'&&out.trim()){ const outLit=toPythonUnicodeLiteral(out.trim()); outcomesCode+="businessEvent=EssentialGetInstance('Business_Event', u'', "+outLit+", u'', externalRepository)\n"; outcomesCode+="addIfNotThere(valueStream, 'vs_outcome_events', businessEvent)\n"; }
  let impactedServicesCode=""; for(const ps of impactedServices) if(typeof ps==='string'&&ps.trim()){ const psLit=toPythonUnicodeLiteral(ps.trim()); impactedServicesCode+="productType=EssentialGetInstance('Product_Type', u'', "+psLit+", u'', externalRepository)\n"; impactedServicesCode+="addIfNotThere(valueStream, 'vs_product_types', productType)\n"; }
  let suppliersAppsCode=""; for(const [supplierName,apps] of Object.entries(suppliersAppsMap)){ if(typeof supplierName!=='string'||!supplierName.trim()) continue; const supLit=toPythonUnicodeLiteral(supplierName.trim()); suppliersAppsCode+="supplier=EssentialGetInstance('Supplier', u'', "+supLit+", u'', externalRepository)\n"; if(Array.isArray(apps)){ for(const app of apps){ if(typeof app!=='string'||!app.trim()) continue; const appTxt=app.trim(); const appLit=toPythonUnicodeLiteral(appTxt); suppliersAppsCode+="application=EssentialGetInstance('Composite_Application_Provider', u'', "+appLit+", u'', externalRepository)\n"; suppliersAppsCode+="addIfNotThere(application, 'ap_supplier', supplier)\n"; const appServiceLabel=toPythonUnicodeLiteral(appTxt+" Generic Service"); const appRoleLabel=toPythonUnicodeLiteral(appTxt+" as "+appTxt+" Services"); suppliersAppsCode+="applicationService=EssentialGetInstance('Application_Service', u'', "+appServiceLabel+", u'', externalRepository)\n"; suppliersAppsCode+="applicationProviderRole=EssentialGetInstance('Application_Provider_Role', u'', "+appRoleLabel+", u'', externalRepository)\n"; suppliersAppsCode+="addIfNotThere(applicationProviderRole, 'implementing_application_service', applicationService)\n"; suppliersAppsCode+="addIfNotThere(applicationProviderRole, 'role_for_application_provider', application)\n"; } } }
  function addListItems(block,className,relationName){ const items=flattenBlock(block); let code=""; for(const txt of items){ const lit=toPythonUnicodeLiteral(txt); if(className==='Business_Process'){ code+="businessProcess=EssentialGetInstance('Business_Process', u'', "+lit+", u'', externalRepository)\n"; code+="addIfNotThere(valueStage, '"+relationName+"', businessProcess)\n"; } else if(className==='Business_Event'){ code+="businessEvent=EssentialGetInstance('Business_Event', u'', "+lit+", u'', externalRepository)\n"; code+="addIfNotThere(valueStage, '"+relationName+"', businessEvent)\n"; } else if(className==='Business_Condition'){ code+="businessCondition=EssentialGetInstance('Business_Condition', u'', "+lit+", u'', externalRepository)\n"; code+="addIfNotThere(valueStage, '"+relationName+"', businessCondition)\n"; } else if(className==='Business_Capability'){ code+="businessCapability=EssentialGetInstance('Business_Capability', u'', "+lit+", u'', externalRepository)\n"; code+="addIfNotThere(valueStage, '"+relationName+"', businessCapability)\n"; } } return code; }
  let stagesCode=""; let index=1;
  for(let i=0;i<stages.length;i++){
    const st=stages[i]; if(!st||typeof st.name!=="string") continue;
    const stName=st.name.trim(); if(!stName) continue;
    const stDesc=(typeof st.description==="string")?st.description.trim():"";
    const stRoleTypes=Array.isArray(st.businessRoleTypes)?st.businessRoleTypes:[];
    const stLit=toPythonUnicodeLiteral(stName);
    const composed=`${vsNameRaw.trim()}: ${index}. ${stName}`; const composedLit=toPythonUnicodeLiteral(composed);
    stagesCode+="valueStageLabel=EssentialGetInstance('Label', u'', "+stLit+", u'', externalRepository)\n";
    stagesCode+="valueStage=EssentialGetInstance('Value_Stage', u'', "+composedLit+", u'', externalRepository)\n";
    stagesCode+="addIfNotThere(valueStage, 'vsg_value_stream', valueStream)\n";
    stagesCode+="addIfNotThere(valueStage, 'vsg_label', valueStageLabel)\n";
    stagesCode+="addIfNotThere(valueStage, 'vsg_index', "+index+")\n";
    if(stDesc){ const stDescLit=toPythonUnicodeLiteral(stDesc); stagesCode+="addIfNotThere(valueStage, 'description', "+stDescLit+")\n"; }
    for(const br of stRoleTypes){ if(typeof br!=="string"||!br.trim()) continue; const brLit=toPythonUnicodeLiteral(br.trim());
      stagesCode+="businessRoleType=EssentialGetInstance('Business_Role_Type', u'', "+brLit+", u'', externalRepository)\n";
      stagesCode+="addIfNotThere(valueStage, 'vsg_participants', businessRoleType)\n";
    }
    stagesCode+=addListItems((data['Supporting Business Capabilities']||[])[i],'Business_Capability','vsg_required_business_capabilities');
    stagesCode+=addListItems((data['Supporting Business Processes']||[])[i],'Business_Process','vs_supporting_bus_processes');
    stagesCode+=addListItems((data['Entrance Events']||[])[i],'Business_Event','vsg_entrance_events');
    stagesCode+=addListItems((data['Entrance Conditions']||[])[i],'Business_Condition','vsg_entrance_conditions');
    stagesCode+=addListItems((data['Exit Events']||[])[i],'Business_Event','vsg_exit_events');
    stagesCode+=addListItems((data['Exit Conditions']||[])[i],'Business_Condition','vsg_exit_conditions');
    const emo=(targetEmotions[i]&&typeof targetEmotions[i]==='string')?targetEmotions[i].trim():'';
    if(emo){ const emoLit=toPythonUnicodeLiteral(emo); const composedRel=composed+" - "+emo; const composedRelLit=toPythonUnicodeLiteral(composedRel);
      stagesCode+="customerEmotion=EssentialGetInstance('Customer_Emotion', u'', "+emoLit+", u'', externalRepository)\n";
      stagesCode+="addIfNotThere(customerEmotion, 'enumeration_value', "+emoLit+")\n";
      stagesCode+="emotionRelation=EssentialGetInstance('VALUE_STAGE_TO_EMOTION_RELATION', u'', "+composedRelLit+", u'', externalRepository)\n";
      stagesCode+="addIfNotThere(emotionRelation, 'value_stage_to_emotion_from_value_stage', valueStage)\n";
      stagesCode+="addIfNotThere(emotionRelation, 'value_stage_to_emotion_to_emotion', customerEmotion)\n";
    }
    const kpiArr=Array.isArray((data['KPIs']||[])[i])?(data['KPIs'][i]):[];
    for(const line of kpiArr){ if(typeof line!=="string"||!line.trim()) continue; const m=line.trim().match(/^([^:]+):\s*([+-]?\d+(?:[.,]\d+)?)(.*)$/); if(!m) continue;
      const name=m[1].trim(); const value=m[2].trim(); const unit=(m[3]||'').trim();
      const nameLit=toPythonUnicodeLiteral(name); const unitLit=toPythonUnicodeLiteral(unit);
      const label=name+" - "+value+unit; const labelLit=toPythonUnicodeLiteral(label);
      stagesCode+="businessServiceQuality=EssentialGetInstance('Business_Service_Quality', u'', "+nameLit+", u'', externalRepository)\n";
      stagesCode+="unitOfMeasure=EssentialGetInstance('Unit_Of_Measure', u'', "+unitLit+", u'', externalRepository)\n";
      stagesCode+="businessServiceQualityValue=EssentialGetInstance('Business_Service_Quality_Value', u'', "+labelLit+", u'', externalRepository)\n";
      stagesCode+="addIfNotThere(businessServiceQualityValue, 'usage_of_service_quality', businessServiceQuality)\n";
      stagesCode+="addIfNotThere(businessServiceQualityValue, 'service_quality_value_uom', unitOfMeasure)\n";
      stagesCode+="addIfNotThere(businessServiceQualityValue, 'service_quality_value_value', "+toPythonUnicodeLiteral(value)+")\n";
      const bpmLabel=composed+" measured as "+name+" - "+value+unit; const bpmLabelLit=toPythonUnicodeLiteral(bpmLabel);
      stagesCode+="businessPerformanceMeasure=EssentialGetInstance('Business_Performance_Measure', u'', "+bpmLabelLit+", u'', externalRepository)\n";
      stagesCode+="addIfNotThere(businessPerformanceMeasure, 'pm_performance_value', businessServiceQualityValue)\n";
      stagesCode+="addIfNotThere(valueStage, 'performance_measures', businessPerformanceMeasure)\n";
    }
    index+=1;
  }
  let associationsCode=""; for(const [pName,assoc] of Object.entries(valueStreamAssociations)){ if(typeof pName!=='string'||!pName.trim()) continue; const nameTxt=pName.trim(); const assocObj=assoc&&typeof assoc==='object'?assoc:{}; const orgVal=(typeof assocObj.Org==='string'?assocObj.Org:'').trim(); const locVal=(typeof assocObj.Location==='string'?assocObj.Location:'').trim(); const appsList=Array.isArray(assocObj.Applications)?assocObj.Applications:[]; const infoList=Array.isArray(assocObj.Info)?assocObj.Info:[]; const bpLit=toPythonUnicodeLiteral(nameTxt); associationsCode+="businessProcess=EssentialGetInstance('Business_Process', u'', "+bpLit+", u'', externalRepository)\n"; if(orgVal){ const orgLit=toPythonUnicodeLiteral(orgVal); associationsCode+="groupActor=EssentialGetInstance('Group_Actor', u'', "+orgLit+", u'', externalRepository)\n"; const physLabelLit=toPythonUnicodeLiteral(orgVal+" performing "+nameTxt); associationsCode+="physicalProcess=EssentialGetInstance('Physical_Process', u'', "+physLabelLit+", u'', externalRepository)\n"; associationsCode+="addIfNotThere(physicalProcess, 'implements_business_process', businessProcess)\n"; associationsCode+="addIfNotThere(physicalProcess, 'process_performed_by_actor_role', groupActor)\n"; if(locVal){ const locLit=toPythonUnicodeLiteral(locVal); associationsCode+="site=EssentialGetInstance('Site', u'', "+locLit+", u'', externalRepository)\n"; associationsCode+="addIfNotThere(physicalProcess, 'process_performed_at_sites', site)\n"; } for(const infoItem of infoList){ if(typeof infoItem!=='string'||!infoItem.trim()) continue; const infoTxt=infoItem.trim(); const infoLit=toPythonUnicodeLiteral(infoTxt); const infoRelLabelLit=toPythonUnicodeLiteral(infoTxt+"  managed by"); const physInfoLabelLit=toPythonUnicodeLiteral(orgVal+" performing "+nameTxt+" using "+infoTxt+"  managed by"); associationsCode+="informationRepresentation=EssentialGetInstance('Information_Representation', u'', "+infoLit+", u'', externalRepository)\n"; associationsCode+="informationRel=EssentialGetInstance('APP_PRO_TO_INFOREP_RELATION', u'', "+infoRelLabelLit+", u'', externalRepository)\n"; associationsCode+="addIfNotThere(informationRel, 'app_pro_to_inforep_to_inforep', informationRepresentation)\n"; associationsCode+="businessProcessInfo=EssentialGetInstance('PHYSBUSPROC_TO_APPINFOREP_RELATION', u'', "+physInfoLabelLit+", u'', externalRepository)\n"; associationsCode+="addIfNotThere(businessProcessInfo, 'physbusproc_to_appinfoview_from_physbusproc', physicalProcess)\n"; associationsCode+="addIfNotThere(businessProcessInfo, 'physbusproc_to_appinfoview_to_appinforep', informationRel)\n"; } for(const appItem of appsList){ if(typeof appItem!=='string'||!appItem.trim()) continue; const appTxt=appItem.trim(); const appRoleLabelLit=toPythonUnicodeLiteral(appTxt+" as "+appTxt+" Services"); const appPhysLabelLit=toPythonUnicodeLiteral(appTxt+" as "+appTxt+" as Service::supports::"+orgVal+" performing "+nameTxt); associationsCode+="applicationProviderRole=EssentialGetInstance('Application_Provider_Role', u'', "+appRoleLabelLit+", u'', externalRepository)\n"; associationsCode+="appPhysicalProcess=EssentialGetInstance('APP_PRO_TO_PHYS_BUS_RELATION', u'', "+appPhysLabelLit+", u'', externalRepository)\n"; associationsCode+="addIfNotThere(appPhysicalProcess, 'apppro_to_physbus_to_busproc', physicalProcess)\n"; associationsCode+="addIfNotThere(appPhysicalProcess, 'apppro_to_physbus_from_appprorole', applicationProviderRole)\n"; } } }
  const futureMarker="# ==== BEGIN GENERATED FROM JSON (to be implemented) ====\n"+"# JSON keys available: "+Object.keys(refJson).join(', ')+"\n"+"# ==== END GENERATED FROM JSON (to be implemented) ====\n";
  const dupScript=(dupScriptHeader+"\n"+vsLine+vsDescCode+initiatorsCode+initEventsCode+initiationCondsCode+outcomeCondsCode+outcomesCode+impactedServicesCode+suppliersAppsCode+stagesCode+associationsCode+"\n"+futureMarker);
  const zip=new JSZip(); zip.file('dup_import_script.py',dupScript); zip.file('standardFunctions.py',decodedPythonCode); zip.file('update.info',updateInfoXml); zip.file('updatepack.xsd',updatepackXsdXml);
  const blob=await zip.generateAsync({type:'blob',compression:'DEFLATE'});
  if(window.showSaveFilePicker){ try{ const handle=await window.showSaveFilePicker({ suggestedName: outName, types:[{description:'Essential DUP', accept:{'application/zip':['.dup']}}] }); const writable=await handle.createWritable(); await writable.write(blob); await writable.close(); return; }catch(err){ if(!err||err.name!=='AbortError') console.warn(err); } }
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=outName; document.body.appendChild(a); a.click(); a.remove();
}

if(createDupBtn){ createDupBtn.addEventListener('click',()=>{ createDupFromState().catch(err=>{ console.error(err); alert('Error creating .dup: '+(err&&err.message?err.message:String(err))); }); }); }
function normaliseToStringArray(v){if(Array.isArray(v))return v.map(x=>String(x));if(['string','number','boolean'].includes(typeof v))return[String(v)];return[];}
function applyMatrixFromJSON(matrix){const vsTable=$('#vsTable');if(!matrix||!Array.isArray(matrix.stages)){V.vsStages.length=0;V.vsStageMeta.length=0;V.renderStagesTable();V.processesMap={};return;}V.vsStages.length=0;V.vsStageMeta.length=0;matrix.stages.forEach(s=>{if(s&&typeof s==='object'){const name=String(s.name||'').trim();const description=String(s.description||'').trim();const roles=Array.isArray(s.businessRoleTypes)?s.businessRoleTypes.map(String):[];V.vsStages.push(name);V.vsStageMeta.push({description,businessRoleTypes:roles});}else{V.vsStages.push(String(s));V.vsStageMeta.push({description:'',businessRoleTypes:[]});}});V.renderStagesTable();const data=matrix.data||{};Object.keys(data).forEach(rowName=>{const rowIdx=V.vsRows.indexOf(rowName);if(rowIdx<=0)return;const values=Array.isArray(data[rowName])?data[rowName]:[];const tr=vsTable.tBodies[0].rows[rowIdx];for(let c=0;c<V.vsStages.length;c++){const td=tr?.cells[c+1];if(rowName==='Target Emotions'){const sel=td?.querySelector('select');if(sel)sel.value=values[c]!=null?String(values[c]):'';}else{const content=td?.querySelector('.cell-content');if(content){const v=values[c];if(Array.isArray(v)){content.textContent=V.bulletize(v);}else{content.textContent=v!=null?String(v):'';}}}}});V.validateAllKpiCells();rebuildMappingFromMatrix();}window.applyMatrixFromJSON=applyMatrixFromJSON;
function rebuildMappingFromMatrix(){const vsTable=$('#vsTable');V.processesMap={};for(let stageIdx=0;stageIdx<V.vsStages.length;stageIdx++){const tableCol=stageIdx+1;const text=vsTable.tBodies[0]?.rows[V.PROCESS_ROW_INDEX]?.cells[tableCol]?.querySelector('.cell-content')?.innerText||'';const items=V.unbulletize(text);items.forEach(n=>{if(!(n in V.processesMap)){V.processesMap[n]=stageIdx;V.uniquePush(V.state.box3,n);}});}V.renderBox('box3');}window.rebuildMappingFromMatrix=rebuildMappingFromMatrix;
function applyImportedData(obj){if(!obj||typeof obj!=='object')return;const fixedToKey={'suppliers':'box1','locations':'box2','value stream':'box3','org':'box4','info':'box5','applications':'box6','initiators':'sum1','initiation events':'sum2','initiation conditions':'sum3','outcome conditions':'sum4','outcomes':'sum5','impacted business services':'sum6'};const vsNameEntry=Object.keys(obj).find(k=>k.toLowerCase()==='value stream name');if(vsNameEntry){const name=String(obj[vsNameEntry]).trim();if(name)V.labels.box3=name;}const vsDescEntry=Object.keys(obj).find(k=>k.toLowerCase()==='value stream description');if(vsDescEntry){V.flowDescription=String(obj[vsDescEntry]||'').trim();}
Object.keys(V.state).forEach(k=>V.state[k]=[]);for(const[k,v]of Object.entries(obj)){const lower=String(k).toLowerCase();if(['value stream name','value stages matrix','suppliers applications mapping','value stream associations'].includes(lower))continue;const mappedKey=fixedToKey[lower]||(k in V.state?k:null);if(!mappedKey)continue;V.state[mappedKey]=normaliseToStringArray(v);}const matrixKey=Object.keys(obj).find(k=>k.toLowerCase()==='value stages matrix');if(matrixKey)applyMatrixFromJSON(obj[matrixKey]);else V.processesMap={};
V.supplierApps={};const mapKey=Object.keys(obj).find(k=>k.toLowerCase()==='suppliers applications mapping');if(mapKey){const m=obj[mapKey];if(m&&typeof m==='object'){const appsSet=new Set(V.state.box6);Object.entries(m).forEach(([supplier,arr])=>{const s=String(supplier);const list=Array.isArray(arr)?arr.map(String).filter(a=>appsSet.has(a)):[];V.supplierApps[s]=list;});}}
V.clientAdvertLinks={};const clientKeyFound=Object.keys(obj).find(k=>k.toLowerCase()==='value stream associations');if(clientKeyFound){const m=obj[clientKeyFound];if(m&&typeof m==='object'){const clientKey=getClientAdvertKey();const itemsSet=new Set(clientKey?V.state[clientKey]:[]);const orgSet=new Set(V.state.box4);const appSet=new Set(V.state.box6);const infoSet=new Set(V.state.box5);const locSet=new Set(V.state.box2);Object.entries(m).forEach(([item,data])=>{const name=String(item);if(!itemsSet.has(name))return;const org=String((data&&data.Org)||'');const location=String((data&&data.Location)||'');const apps=Array.isArray(data?.Applications)?data.Applications.map(String).filter(a=>appSet.has(a)):[];const info=Array.isArray(data?.Info)?data.Info.map(String).filter(i=>infoSet.has(i)):[];V.clientAdvertLinks[name]={org:orgSet.has(org)?org:'',location:locSet.has(location)?location:'',apps,info};});}}
V.renderCanvasAll();V.renderSummaryAll();V.renderBox('box3');V.renderBox('box1');V.renderBox('box6');V.renderBox('box4');V.renderBox('box2');const caKey=getClientAdvertKey();if(caKey)V.renderBox(caKey);V.updateFlowNameLine();V.updateFlowDescriptionLine();}
window.applyImportedData=applyImportedData;
importBtn.addEventListener('click',()=>{importTextarea.value='';if(importFile)importFile.value='';importModal.showModal();});cancelImportBtn.addEventListener('click',()=>importModal.close());importFile.addEventListener('change',e=>{const f=e.target.files?.[0];if(!f)return;const reader=new FileReader();reader.onload=()=>{importTextarea.value=String(reader.result||'');};reader.readAsText(f);});importForm.addEventListener('submit',e=>{e.preventDefault();try{const raw=(importTextarea.value||'').replace(/^\uFEFF/, '').trim();if(!raw){alert('Paste JSON or select a file before loading.');return;}const obj=JSON.parse(raw);applyImportedData(obj);importModal.close();}catch(err){alert('Invalid JSON. Check the content and try again.\n'+(err&&err.message?err.message:''));}});
const clearAllBtn=$('#clearAllBtn');const confirmClear=$('#confirmClear');const cancelClearBtn=$('#cancelClearBtn');const confirmClearBtn=$('#confirmClearBtn');
function clearAll(){Object.keys(V.state).forEach(k=>V.state[k]=[]);V.vsStages.length=0;V.processesMap={};V.supplierApps={};V.clientAdvertLinks={};V.flowDescription='';V.renderCanvasAll();V.renderSummaryAll();V.renderStagesTable();V.updateFlowNameLine();V.updateFlowDescriptionLine();}
window.clearAll=clearAll;clearAllBtn.addEventListener('click',()=>confirmClear.showModal());cancelClearBtn.addEventListener('click',()=>confirmClear.close());confirmClearBtn.addEventListener('click',()=>{clearAll();confirmClear.close();});})();</script>
  <script>(function(){function boot(){const V=window.VSE;const{$}=V;const tabsEl=$('#tabs');if(!tabsEl){return setTimeout(boot,10);}tabsEl.addEventListener('click',e=>{const btn=e.target.closest('.tab-btn');if(!btn)return;V.selectTab(btn.dataset.target);});const editFlowNameBtn=$('#editFlowNameBtn');if(editFlowNameBtn){editFlowNameBtn.addEventListener('click',()=>window.openEditTitleModal('box3'));}const editFlowDescBtn=$('#editFlowDescBtn');if(editFlowDescBtn){editFlowDescBtn.addEventListener('click',()=>{const m=document.querySelector('#editDescModal');const i=document.querySelector('#flowDescInput');if(!m||!i)return;m.showModal();i.value=V.flowDescription||'';setTimeout(()=>i.select(),0);});}
V.renderCanvasAll();V.renderSummaryAll();V.renderStagesTable();V.updateFlowNameLine();V.updateFlowDescriptionLine();}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',boot);}else{boot();}})();</script>
</body>
</html>
